<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/blog/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/blog/uploads/favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/blog/uploads/favicon.ico">
  <link rel="mask-icon" href="/blog/images/logo.svg" color="#222">

<link rel="stylesheet" href="/blog/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.0/css/all.min.css" integrity="sha256-yIDrPSXHZdOZhAqiBP7CKzIwMQmRCJ8UeB8Jo17YC4o=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/themes/blue/pace-theme-minimal.css">
  <script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"dunwu.github.io","root":"/blog/","images":"/blog/images","scheme":"Pisces","darkmode":true,"version":"8.19.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"gitalk","storage":true,"lazyload":true,"nav":null,"activeClass":"gitalk"},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/blog/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/blog/js/config.js"></script>

    <meta name="description" content="钝悟的个人博客">
<meta property="og:type" content="website">
<meta property="og:title" content="Dunwu Blog">
<meta property="og:url" content="https://dunwu.github.io/blog/page/12/index.html">
<meta property="og:site_name" content="Dunwu Blog">
<meta property="og:description" content="钝悟的个人博客">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="钝悟 ◾ Dunwu">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://dunwu.github.io/blog/page/12/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"page/12/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Dunwu Blog</title>
  








  <noscript>
    <link rel="stylesheet" href="/blog/css/noscript.css">
  </noscript>
<style>.darkmode--activated{--body-bg-color:#282828;--content-bg-color:#333;--card-bg-color:#555;--text-color:#ccc;--blockquote-color:#bbb;--link-color:#ccc;--link-hover-color:#eee;--brand-color:#ddd;--brand-hover-color:#ddd;--table-row-odd-bg-color:#282828;--table-row-hover-bg-color:#363636;--menu-item-bg-color:#555;--btn-default-bg:#222;--btn-default-color:#ccc;--btn-default-border-color:#555;--btn-default-hover-bg:#666;--btn-default-hover-color:#ccc;--btn-default-hover-border-color:#666;--highlight-background:#282b2e;--highlight-foreground:#a9b7c6;--highlight-gutter-background:#34393d;--highlight-gutter-foreground:#9ca9b6}.darkmode--activated img{opacity:.75}.darkmode--activated img:hover{opacity:.9}.darkmode--activated code{color:#69dbdc;background:0 0}button.darkmode-toggle{z-index:9999}.darkmode-ignore,img{display:flex!important}.beian img{display:inline-block!important}</style></head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/blog/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Dunwu Blog</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">大道至简，知易行难</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/blog/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/blog/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/blog/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">326</span></a></li><li class="menu-item menu-item-categories"><a href="/blog/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">137</span></a></li><li class="menu-item menu-item-archives"><a href="/blog/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">461</span></a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="钝悟 ◾ Dunwu"
      src="/blog/uploads/avatar.gif">
  <p class="site-author-name" itemprop="name">钝悟 ◾ Dunwu</p>
  <div class="site-description" itemprop="description">钝悟的个人博客</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/blog/archives/">
          <span class="site-state-item-count">461</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/blog/categories/">
        <span class="site-state-item-count">137</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/blog/tags/">
        <span class="site-state-item-count">326</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/dunwu" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;dunwu" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:forbreak@163.com" title="E-Mail → mailto:forbreak@163.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>
  <div class="cc-license animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" class="cc-opacity" rel="noopener" target="_blank"><img src="https://cdn.jsdelivr.net/npm/@creativecommons/vocabulary@2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a>
  </div>

        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="返回顶部">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://dunwu.github.io/blog/pages/9c6402/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/uploads/avatar.gif">
      <meta itemprop="name" content="钝悟 ◾ Dunwu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dunwu Blog">
      <meta itemprop="description" content="钝悟的个人博客">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Dunwu Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/pages/9c6402/" class="post-title-link" itemprop="url">JMH 快速入门</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-02-17 22:34:30" itemprop="dateCreated datePublished" datetime="2022-02-17T22:34:30+08:00">2022-02-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-01-27 23:32:48" itemprop="dateModified" datetime="2024-01-27T23:32:48+08:00">2024-01-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/%E5%B7%A5%E5%85%B7/" itemprop="url" rel="index"><span itemprop="name">工具</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/%E5%B7%A5%E5%85%B7/%E6%B5%8B%E8%AF%95/" itemprop="url" rel="index"><span itemprop="name">测试</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>8.3k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>8 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="JMH-快速入门"><a href="#JMH-快速入门" class="headerlink" title="JMH 快速入门"></a>JMH 快速入门</h1><h2 id="基准测试简介"><a href="#基准测试简介" class="headerlink" title="基准测试简介"></a>基准测试简介</h2><h3 id="什么是基准测试"><a href="#什么是基准测试" class="headerlink" title="什么是基准测试"></a>什么是基准测试</h3><p>基准测试是指通过设计科学的测试方法、测试工具和测试系统，实现对一类测试对象的某项性能指标进行定量的和可对比的测试。</p>
<p>现代软件常常都把高性能作为目标。那么，何为高性能，性能就是快，更快吗？显然，如果没有一个量化的标准，难以衡量性能的好坏。</p>
<p>不同的基准测试其具体内容和范围也存在很大的不同。如果是专业的性能工程师，更加熟悉的可能是类似 SPEC 提供的工业标准的系统级测试；而对于大多数 Java 开发者，更熟悉的则是范围相对较小、关注点更加细节的微基准测试（Micro-Benchmark）。何谓 Micro Benchmark 呢？ 简单地说就是在 method 层面上的 benchmark，精度可以精确到 <strong>微秒级</strong>。</p>
<h3 id="何时需要微基准测试"><a href="#何时需要微基准测试" class="headerlink" title="何时需要微基准测试"></a>何时需要微基准测试</h3><p>微基准测试大多是 API 级别的性能测试。</p>
<p>微基准测试的适用场景：</p>
<ul>
<li>如果开发公共类库、中间件，会被其他模块经常调用的 API。</li>
<li>对于性能，如响应延迟、吞吐量有严格要求的核心 API。</li>
</ul>
<h2 id="JMH-简介"><a href="#JMH-简介" class="headerlink" title="JMH 简介"></a>JMH 简介</h2><p><a target="_blank" rel="noopener" href="http://openjdk.java.net/projects/code-tools/jmh/">JMH(即 Java Microbenchmark Harness)</a>，是目前主流的微基准测试框架。JMH 是由 Hotspot JVM 团队专家开发的，除了支持完整的基准测试过程，包括预热、运行、统计和报告等，还支持 Java 和其他 JVM 语言。更重要的是，它针对 Hotspot JVM 提供了各种特性，以保证基准测试的正确性，整体准确性大大优于其他框架，并且，JMH 还提供了用近乎白盒的方式进行 Profiling 等工作的能力。</p>
<h3 id="为什么需要-JMH"><a href="#为什么需要-JMH" class="headerlink" title="为什么需要 JMH"></a>为什么需要 JMH</h3><h4 id="死码消除"><a href="#死码消除" class="headerlink" title="死码消除"></a>死码消除</h4><p>所谓死码，是指注释的代码，不可达的代码块，可达但不被使用的代码等等 。</p>
<h4 id="常量折叠与常量传播"><a href="#常量折叠与常量传播" class="headerlink" title="常量折叠与常量传播"></a>常量折叠与常量传播</h4><p><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%B8%B8%E6%95%B8%E6%8A%98%E7%96%8A#%E5%B8%B8%E6%95%B8%E5%82%B3%E6%92%AD">常量折叠</a> (Constant folding) 是一个在编译时期简化常数的一个过程，常数在表示式中仅仅代表一个简单的数值，就像是整数 <code>2</code>，若是一个变数从未被修改也可作为常数，或者直接将一个变数被明确地被标注为常数，例如下面的描述：</p>
<h3 id="JMH-的注意点"><a href="#JMH-的注意点" class="headerlink" title="JMH 的注意点"></a>JMH 的注意点</h3><ul>
<li>测试前需要预热。</li>
<li>防止无用代码进入测试方法中。</li>
<li>并发测试。</li>
<li>测试结果呈现。</li>
</ul>
<h3 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h3><ol>
<li>当你已经找出了热点函数，而需要对热点函数进行进一步的优化时，就可以使用 JMH 对优化的效果进行定量的分析。</li>
<li>想定量地知道某个函数需要执行多长时间，以及执行时间和输入 n 的相关性</li>
<li>一个函数有两种不同实现（例如 JSON 序列化&#x2F;反序列化有 Jackson 和 Gson 实现），不知道哪种实现性能更好</li>
</ol>
<h3 id="JMH-概念"><a href="#JMH-概念" class="headerlink" title="JMH 概念"></a>JMH 概念</h3><ul>
<li><code>Iteration</code> - iteration 是 JMH 进行测试的最小单位，包含一组 invocations。</li>
<li><code>Invocation</code> - 一次 benchmark 方法调用。</li>
<li><code>Operation</code> - benchmark 方法中，被测量操作的执行。如果被测试的操作在 benchmark 方法中循环执行，可以使用<code>@OperationsPerInvocation</code>表明循环次数，使测试结果为单次 operation 的性能。</li>
<li><code>Warmup</code> - 在实际进行 benchmark 前先进行预热。因为某个函数被调用多次之后，JIT 会对其进行编译，通过预热可以使测量结果更加接近真实情况。</li>
</ul>
<h2 id="JMH-快速入门-1"><a href="#JMH-快速入门-1" class="headerlink" title="JMH 快速入门"></a>JMH 快速入门</h2><h3 id="添加-maven-依赖"><a href="#添加-maven-依赖" class="headerlink" title="添加 maven 依赖"></a>添加 maven 依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.openjdk.jmh<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jmh-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;jmh.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.openjdk.jmh<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jmh-generator-annprocess<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;jmh.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="测试代码"><a href="#测试代码" class="headerlink" title="测试代码"></a>测试代码</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.openjdk.jmh.annotations.*;</span><br><span class="line"><span class="keyword">import</span> org.openjdk.jmh.runner.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="meta">@BenchmarkMode(Mode.Throughput)</span></span><br><span class="line"><span class="meta">@Warmup(iterations = 3)</span></span><br><span class="line"><span class="meta">@Measurement(iterations = 10, time = 5, timeUnit = TimeUnit.SECONDS)</span></span><br><span class="line"><span class="meta">@Threads(8)</span></span><br><span class="line"><span class="meta">@Fork(2)</span></span><br><span class="line"><span class="meta">@OutputTimeUnit(TimeUnit.MILLISECONDS)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StringBuilderBenchmark</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Benchmark</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testStringAdd</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">a</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">            a += i;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// System.out.println(a);</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Benchmark</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testStringBuilderAdd</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">            sb.append(i);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// System.out.println(sb.toString());</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> RunnerException &#123;</span><br><span class="line">        <span class="type">Options</span> <span class="variable">options</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OptionsBuilder</span>()</span><br><span class="line">            .include(StringBuilderBenchmark.class.getSimpleName())</span><br><span class="line">            .output(<span class="string">&quot;d:/Benchmark.log&quot;</span>)</span><br><span class="line">            .build();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Runner</span>(options).run();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="执行-JMH"><a href="#执行-JMH" class="headerlink" title="执行 JMH"></a>执行 JMH</h3><h4 id="命令行"><a href="#命令行" class="headerlink" title="命令行"></a>命令行</h4><p>（1）初始化 <strong>benchmarking</strong> 工程</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">mvn archetype:generate \</span></span><br><span class="line"><span class="language-bash">          -DinteractiveMode=<span class="literal">false</span> \</span></span><br><span class="line"><span class="language-bash">          -DarchetypeGroupId=org.openjdk.jmh \</span></span><br><span class="line"><span class="language-bash">          -DarchetypeArtifactId=jmh-java-benchmark-archetype \</span></span><br><span class="line"><span class="language-bash">          -DgroupId=org.sample \</span></span><br><span class="line"><span class="language-bash">          -DartifactId=<span class="built_in">test</span> \</span></span><br><span class="line"><span class="language-bash">          -Dversion=1.0</span></span><br></pre></td></tr></table></figure>

<p>（2）构建 benchmark</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd test/</span><br><span class="line">mvn clean install</span><br></pre></td></tr></table></figure>

<p>（3）运行 benchmark</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar target/benchmarks.jar</span><br></pre></td></tr></table></figure>

<h4 id="执行-main-方法"><a href="#执行-main-方法" class="headerlink" title="执行 main 方法"></a>执行 main 方法</h4><p>执行 main 方法，耐心等待测试结果，最终会生成一个测试报告，内容大致如下；</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">JMH version: 1.22</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">VM version: JDK 1.8.0_181, Java HotSpot(TM) 64-Bit Server VM, 25.181-b13</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">VM invoker: C:\Program Files\Java\jdk1.8.0_181\jre\bin\java.exe</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">VM options: -javaagent:D:\Program Files\JetBrains\IntelliJ IDEA 2019.2.3\lib\idea_rt.jar=58635:D:\Program Files\JetBrains\IntelliJ IDEA 2019.2.3\bin -Dfile.encoding=UTF-8</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Warmup: 3 iterations, 10 s each</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Measurement: 10 iterations, 5 s each</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Timeout: 10 min per iteration</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Threads: 8 threads, will synchronize iterations</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Benchmark mode: Throughput, ops/time</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Benchmark: io.github.dunwu.javatech.jmh.StringBuilderBenchmark.testStringAdd</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Run progress: 0.00% complete, ETA 00:05:20</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Fork: 1 of 2</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Warmup Iteration   1: 21803.050 ops/ms</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Warmup Iteration   2: 22501.860 ops/ms</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Warmup Iteration   3: 20953.944 ops/ms</span></span><br><span class="line">Iteration   1: 21627.645 ops/ms</span><br><span class="line">Iteration   2: 21215.269 ops/ms</span><br><span class="line">Iteration   3: 20863.282 ops/ms</span><br><span class="line">Iteration   4: 21617.715 ops/ms</span><br><span class="line">Iteration   5: 21695.645 ops/ms</span><br><span class="line">Iteration   6: 21886.784 ops/ms</span><br><span class="line">Iteration   7: 21986.899 ops/ms</span><br><span class="line">Iteration   8: 22389.540 ops/ms</span><br><span class="line">Iteration   9: 22507.313 ops/ms</span><br><span class="line">Iteration  10: 22124.133 ops/ms</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Run progress: 25.00% complete, ETA 00:04:02</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Fork: 2 of 2</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Warmup Iteration   1: 22262.108 ops/ms</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Warmup Iteration   2: 21567.804 ops/ms</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Warmup Iteration   3: 21787.002 ops/ms</span></span><br><span class="line">Iteration   1: 21598.970 ops/ms</span><br><span class="line">Iteration   2: 22486.133 ops/ms</span><br><span class="line">Iteration   3: 22157.834 ops/ms</span><br><span class="line">Iteration   4: 22321.827 ops/ms</span><br><span class="line">Iteration   5: 22477.063 ops/ms</span><br><span class="line">Iteration   6: 22154.760 ops/ms</span><br><span class="line">Iteration   7: 21561.095 ops/ms</span><br><span class="line">Iteration   8: 22194.863 ops/ms</span><br><span class="line">Iteration   9: 22493.844 ops/ms</span><br><span class="line">Iteration  10: 22568.078 ops/ms</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Result &quot;io.github.dunwu.javatech.jmh.StringBuilderBenchmark.testStringAdd&quot;:</span><br><span class="line">  21996.435 ±(99.9%) 412.955 ops/ms [Average]</span><br><span class="line">  (min, avg, max) = (20863.282, 21996.435, 22568.078), stdev = 475.560</span><br><span class="line">  CI (99.9%): [21583.480, 22409.390] (assumes normal distribution)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">JMH version: 1.22</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">VM version: JDK 1.8.0_181, Java HotSpot(TM) 64-Bit Server VM, 25.181-b13</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">VM invoker: C:\Program Files\Java\jdk1.8.0_181\jre\bin\java.exe</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">VM options: -javaagent:D:\Program Files\JetBrains\IntelliJ IDEA 2019.2.3\lib\idea_rt.jar=58635:D:\Program Files\JetBrains\IntelliJ IDEA 2019.2.3\bin -Dfile.encoding=UTF-8</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Warmup: 3 iterations, 10 s each</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Measurement: 10 iterations, 5 s each</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Timeout: 10 min per iteration</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Threads: 8 threads, will synchronize iterations</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Benchmark mode: Throughput, ops/time</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Benchmark: io.github.dunwu.javatech.jmh.StringBuilderBenchmark.testStringBuilderAdd</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Run progress: 50.00% complete, ETA 00:02:41</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Fork: 1 of 2</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Warmup Iteration   1: 241500.886 ops/ms</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Warmup Iteration   2: 134206.032 ops/ms</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Warmup Iteration   3: 86907.846 ops/ms</span></span><br><span class="line">Iteration   1: 86143.339 ops/ms</span><br><span class="line">Iteration   2: 74725.356 ops/ms</span><br><span class="line">Iteration   3: 72316.121 ops/ms</span><br><span class="line">Iteration   4: 77319.716 ops/ms</span><br><span class="line">Iteration   5: 83469.256 ops/ms</span><br><span class="line">Iteration   6: 87712.360 ops/ms</span><br><span class="line">Iteration   7: 79421.899 ops/ms</span><br><span class="line">Iteration   8: 80867.839 ops/ms</span><br><span class="line">Iteration   9: 82619.163 ops/ms</span><br><span class="line">Iteration  10: 87026.928 ops/ms</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Run progress: 75.00% complete, ETA 00:01:20</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Fork: 2 of 2</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Warmup Iteration   1: 228342.337 ops/ms</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Warmup Iteration   2: 124737.248 ops/ms</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Warmup Iteration   3: 82598.851 ops/ms</span></span><br><span class="line">Iteration   1: 86877.318 ops/ms</span><br><span class="line">Iteration   2: 89388.624 ops/ms</span><br><span class="line">Iteration   3: 88523.558 ops/ms</span><br><span class="line">Iteration   4: 87547.332 ops/ms</span><br><span class="line">Iteration   5: 88376.087 ops/ms</span><br><span class="line">Iteration   6: 88848.837 ops/ms</span><br><span class="line">Iteration   7: 85998.124 ops/ms</span><br><span class="line">Iteration   8: 86796.998 ops/ms</span><br><span class="line">Iteration   9: 87994.726 ops/ms</span><br><span class="line">Iteration  10: 87784.453 ops/ms</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Result &quot;io.github.dunwu.javatech.jmh.StringBuilderBenchmark.testStringBuilderAdd&quot;:</span><br><span class="line">  84487.902 ±(99.9%) 4355.525 ops/ms [Average]</span><br><span class="line">  (min, avg, max) = (72316.121, 84487.902, 89388.624), stdev = 5015.829</span><br><span class="line">  CI (99.9%): [80132.377, 88843.427] (assumes normal distribution)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Run complete. Total time: 00:05:23</span></span><br><span class="line"></span><br><span class="line">REMEMBER: The numbers below are just data. To gain reusable insights, you need to follow up on</span><br><span class="line">why the numbers are the way they are. Use profilers (see -prof, -lprof), design factorial</span><br><span class="line">experiments, perform baseline and negative tests that provide experimental control, make sure</span><br><span class="line">the benchmarking environment is safe on JVM/OS/HW level, ask for reviews from the domain experts.</span><br><span class="line">Do not assume the numbers tell you what you want them to tell.</span><br><span class="line"></span><br><span class="line">Benchmark                                     Mode  Cnt      Score      Error   Units</span><br><span class="line">StringBuilderBenchmark.testStringAdd         thrpt   20  21996.435 ±  412.955  ops/ms</span><br><span class="line">StringBuilderBenchmark.testStringBuilderAdd  thrpt   20  84487.902 ± 4355.525  ops/ms</span><br></pre></td></tr></table></figure>

<h2 id="JMH-API"><a href="#JMH-API" class="headerlink" title="JMH API"></a>JMH API</h2><p>下面来了解一下 jmh 常用 API</p>
<h3 id="BenchmarkMode"><a href="#BenchmarkMode" class="headerlink" title="@BenchmarkMode"></a>@BenchmarkMode</h3><p>基准测试类型。这里选择的是 <code>Throughput</code> 也就是吞吐量。根据源码点进去，每种类型后面都有对应的解释，比较好理解，吞吐量会得到单位时间内可以进行的操作数。</p>
<ul>
<li><code>Throughput</code> - 整体吞吐量，例如“1 秒内可以执行多少次调用”。</li>
<li><code>AverageTime</code> - 调用的平均时间，例如“每次调用平均耗时 xxx 毫秒”。</li>
<li><code>SampleTime</code> - 随机取样，最后输出取样结果的分布，例如“99%的调用在 xxx 毫秒以内，99.99%的调用在 xxx 毫秒以内”</li>
<li><code>SingleShotTime</code> - 以上模式都是默认一次 iteration 是 1s，唯有 SingleShotTime 是只运行一次。往往同时把 warmup 次数设为 0，用于测试冷启动时的性能。</li>
<li><code>All</code> - 所有模式</li>
</ul>
<h3 id="Warmup"><a href="#Warmup" class="headerlink" title="@Warmup"></a>@Warmup</h3><p>上面我们提到了，进行基准测试前需要进行预热。一般我们前几次进行程序测试的时候都会比较慢， 所以要让程序进行几轮预热，保证测试的准确性。其中的参数 iterations 也就非常好理解了，就是预热轮数。</p>
<p>为什么需要预热？因为 JVM 的 JIT 机制的存在，如果某个函数被调用多次之后，JVM 会尝试将其编译成为机器码从而提高执行速度。所以为了让 benchmark 的结果更加接近真实情况就需要进行预热。</p>
<h3 id="Measurement"><a href="#Measurement" class="headerlink" title="@Measurement"></a>@Measurement</h3><p>度量，其实就是一些基本的测试参数。</p>
<ul>
<li><code>iterations</code> - 进行测试的轮次</li>
<li><code>time</code> - 每轮进行的时长</li>
<li><code>timeUnit</code> - 时长单位</li>
</ul>
<p>都是一些基本的参数，可以根据具体情况调整。一般比较重的东西可以进行大量的测试，放到服务器上运行。</p>
<h3 id="Threads"><a href="#Threads" class="headerlink" title="@Threads"></a>@Threads</h3><p>每个进程中的测试线程，这个非常好理解，根据具体情况选择，一般为 cpu 乘以 2。</p>
<h3 id="Fork"><a href="#Fork" class="headerlink" title="@Fork"></a>@Fork</h3><p>进行 fork 的次数。如果 fork 数是 2 的话，则 JMH 会 fork 出两个进程来进行测试。</p>
<h3 id="OutputTimeUnit"><a href="#OutputTimeUnit" class="headerlink" title="@OutputTimeUnit"></a>@OutputTimeUnit</h3><p>这个比较简单了，基准测试结果的时间类型。一般选择秒、毫秒、微秒。</p>
<h3 id="Benchmark"><a href="#Benchmark" class="headerlink" title="@Benchmark"></a>@Benchmark</h3><p>方法级注解，表示该方法是需要进行 benchmark 的对象，用法和 JUnit 的 @Test 类似。</p>
<h3 id="Param"><a href="#Param" class="headerlink" title="@Param"></a>@Param</h3><p>属性级注解，@Param 可以用来指定某项参数的多种情况。特别适合用来测试一个函数在不同的参数输入的情况下的性能。</p>
<h3 id="Setup"><a href="#Setup" class="headerlink" title="@Setup"></a>@Setup</h3><p>方法级注解，这个注解的作用就是我们需要在测试之前进行一些准备工作，比如对一些数据的初始化之类的。</p>
<h3 id="TearDown"><a href="#TearDown" class="headerlink" title="@TearDown"></a>@TearDown</h3><p>方法级注解，这个注解的作用就是我们需要在测试之后进行一些结束工作，比如关闭线程池，数据库连接等的，主要用于资源的回收等。</p>
<h3 id="State"><a href="#State" class="headerlink" title="@State"></a>@State</h3><p>当使用 @Setup 参数的时候，必须在类上加这个参数，不然会提示无法运行。</p>
<p>State 用于声明某个类是一个“状态”，然后接受一个 Scope 参数用来表示该状态的共享范围。 因为很多 benchmark 会需要一些表示状态的类，JMH 允许你把这些类以依赖注入的方式注入到 benchmark 函数里。Scope 主要分为三种。</p>
<ul>
<li><code>Thread</code> - 该状态为每个线程独享。</li>
<li><code>Group</code> - 该状态为同一个组里面所有线程共享。</li>
<li><code>Benchmark</code> - 该状态在所有线程间共享。</li>
</ul>
<p>关于 State 的用法，官方的 code sample 里有比较好的<a target="_blank" rel="noopener" href="http://hg.openjdk.java.net/code-tools/jmh/file/cb9aa824b55a/jmh-samples/src/main/java/org/openjdk/jmh/samples/JMHSample_03_States.java">例子</a>。</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a target="_blank" rel="noopener" href="http://hg.openjdk.java.net/code-tools/jmh/file/tip/jmh-samples/src/main/java/org/openjdk/jmh/samples/">jmh 官方示例</a></li>
<li><a target="_blank" rel="noopener" href="https://www.xncoding.com/2018/01/07/java/jmh.html">Java 微基准测试框架 JMH</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnkirito.moe/java-jmh/">JAVA 拾遗 — JMH 与 8 个测试陷阱</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://dunwu.github.io/blog/pages/fcc1c4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/uploads/avatar.gif">
      <meta itemprop="name" content="钝悟 ◾ Dunwu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dunwu Blog">
      <meta itemprop="description" content="钝悟的个人博客">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Dunwu Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/pages/fcc1c4/" class="post-title-link" itemprop="url">javalib-log</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-02-17 22:34:30" itemprop="dateCreated datePublished" datetime="2022-02-17T22:34:30+08:00">2022-02-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-01-27 23:32:48" itemprop="dateModified" datetime="2024-01-27T23:32:48+08:00">2024-01-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/%E5%B7%A5%E5%85%B7/" itemprop="url" rel="index"><span itemprop="name">工具</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/%E5%B7%A5%E5%85%B7/%E5%85%B6%E4%BB%96/" itemprop="url" rel="index"><span itemprop="name">其他</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>21k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>19 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="细说-Java-主流日志工具库"><a href="#细说-Java-主流日志工具库" class="headerlink" title="细说 Java 主流日志工具库"></a>细说 Java 主流日志工具库</h1><blockquote>
<p>在项目开发中，为了跟踪代码的运行情况，常常要使用日志来记录信息。</p>
<p>在 Java 世界，有很多的日志工具库来实现日志功能，避免了我们重复造轮子。</p>
<p>我们先来逐一了解一下主流日志工具。</p>
</blockquote>
<h2 id="日志框架"><a href="#日志框架" class="headerlink" title="日志框架"></a>日志框架</h2><h3 id="java-util-logging-JUL"><a href="#java-util-logging-JUL" class="headerlink" title="java.util.logging (JUL)"></a>java.util.logging (JUL)</h3><p>JDK1.4 开始，通过 <code>java.util.logging</code> 提供日志功能。</p>
<p>它能满足基本的日志需要，但是功能没有 Log4j 强大，而且使用范围也没有 Log4j 广泛。</p>
<h3 id="Log4j"><a href="#Log4j" class="headerlink" title="Log4j"></a>Log4j</h3><p>Log4j 是 apache 的一个开源项目，创始人 Ceki Gulcu。</p>
<p>Log4j 应该说是 Java 领域资格最老，应用最广的日志工具。从诞生之日到现在一直广受业界欢迎。</p>
<p>Log4j 是高度可配置的，并可通过在运行时的外部文件配置。它根据记录的优先级别，并提供机制，以指示记录信息到许多的目的地，诸如：数据库，文件，控制台，UNIX 系统日志等。</p>
<p>Log4j 中有三个主要组成部分：</p>
<ul>
<li><strong>loggers</strong> - 负责捕获记录信息。</li>
<li><strong>appenders</strong> - 负责发布日志信息，以不同的首选目的地。</li>
<li><strong>layouts</strong> - 负责格式化不同风格的日志信息。</li>
</ul>
<p><a target="_blank" rel="noopener" href="http://logging.apache.org/log4j/2.x/">官网地址</a></p>
<h3 id="Logback"><a href="#Logback" class="headerlink" title="Logback"></a>Logback</h3><p>Logback 是由 log4j 创始人 Ceki Gulcu 设计的又一个开源日记组件，目标是替代 log4j。</p>
<p>logback 当前分成三个模块：<code>logback-core</code>、<code>logback-classic</code> 和 <code>logback-access</code>。</p>
<ul>
<li><code>logback-core</code> - 是其它两个模块的基础模块。</li>
<li><code>logback-classic</code> - 是 log4j 的一个 改良版本。此外 <code>logback-classic</code> 完整实现 SLF4J API 使你可以很方便地更换成其它日记系统如 log4j 或 JDK14 Logging。</li>
<li><code>logback-access</code> - 访问模块与 Servlet 容器集成提供通过 Http 来访问日记的功能。</li>
</ul>
<p><a target="_blank" rel="noopener" href="http://logback.qos.ch/">官网地址</a></p>
<h3 id="Log4j2"><a href="#Log4j2" class="headerlink" title="Log4j2"></a>Log4j2</h3><p><a target="_blank" rel="noopener" href="http://logging.apache.org/log4j/2.x/">官网地址</a></p>
<p>按照官方的说法，Log4j2 是 Log4j 和 Logback 的替代。</p>
<p>Log4j2 架构：</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/cs/java/javalib/log/log4j2-architecture.jpg" alt="img"></p>
<h3 id="Log4j-vs-Logback-vs-Log4j2"><a href="#Log4j-vs-Logback-vs-Log4j2" class="headerlink" title="Log4j vs Logback vs Log4j2"></a>Log4j vs Logback vs Log4j2</h3><p>按照官方的说法，<strong>Log4j2 大大优于 Log4j 和 Logback。</strong></p>
<p>那么，Log4j2 相比于先问世的 Log4j 和 Logback，它具有哪些优势呢？</p>
<ol>
<li>Log4j2 旨在用作审计日志记录框架。 Log4j 1.x 和 Logback 都会在重新配置时丢失事件。 Log4j 2 不会。在 Logback 中，Appender 中的异常永远不会对应用程序可见。在 Log4j 中，可以将 Appender 配置为允许异常渗透到应用程序。</li>
<li>Log4j2 在多线程场景中，<a target="_blank" rel="noopener" href="https://logging.apache.org/log4j/2.x/manual/async.html">异步 Loggers</a> 的吞吐量比 Log4j 1.x 和 Logback 高 10 倍，延迟低几个数量级。</li>
<li>Log4j2 对于独立应用程序是无垃圾的，对于稳定状态日志记录期间的 Web 应用程序来说是低垃圾。这减少了垃圾收集器的压力，并且可以提供更好的响应时间性能。</li>
<li>Log4j2 使用插件系统，通过添加新的 Appender、Filter、Layout、Lookup 和 Pattern Converter，可以非常轻松地扩展框架，而无需对 Log4j 进行任何更改。</li>
<li>由于插件系统配置更简单。配置中的条目不需要指定类名。</li>
<li>支持<a target="_blank" rel="noopener" href="https://logging.apache.org/log4j/2.x/manual/customloglevels.html">自定义日志等级</a>。</li>
<li>支持 <a target="_blank" rel="noopener" href="https://logging.apache.org/log4j/2.x/manual/api.html#LambdaSupport">lambda 表达式</a>。</li>
<li>支持<a target="_blank" rel="noopener" href="https://logging.apache.org/log4j/2.x/manual/messages.html">消息对象</a>。</li>
<li>Log4j 和 Logback 的 Layout 返回的是字符串，而 Log4j2 返回的是二进制数组，这使得它能被各种 Appender 使用。</li>
<li>Syslog Appender 支持 TCP 和 UDP 并且支持 BSD 系统日志。</li>
<li>Log4j2 利用 Java5 并发特性，尽量小粒度的使用锁，减少锁的开销。</li>
</ol>
<h2 id="日志门面"><a href="#日志门面" class="headerlink" title="日志门面"></a>日志门面</h2><p>何谓日志门面？</p>
<p>日志门面是对不同日志框架提供的一个 API 封装，可以在部署的时候不修改任何配置即可接入一种日志实现方案。</p>
<h3 id="common-logging"><a href="#common-logging" class="headerlink" title="common-logging"></a>common-logging</h3><p>common-logging 是 apache 的一个开源项目。也称<strong>Jakarta Commons Logging，缩写 JCL</strong>。</p>
<p>common-logging 的功能是提供日志功能的 API 接口，本身并不提供日志的具体实现（当然，common-logging 内部有一个 Simple logger 的简单实现，但是功能很弱，直接忽略），而是在<strong>运行时</strong>动态的绑定日志实现组件来工作（如 log4j、java.util.loggin）。</p>
<p><a target="_blank" rel="noopener" href="http://commons.apache.org/proper/commons-logging/">官网地址</a></p>
<h3 id="slf4j"><a href="#slf4j" class="headerlink" title="slf4j"></a>slf4j</h3><p>全称为 Simple Logging Facade for Java，即 java 简单日志门面。</p>
<p>什么，作者又是 Ceki Gulcu！这位大神写了 Log4j、Logback 和 slf4j，专注日志组件开发五百年，一直只能超越自己。</p>
<p>类似于 Common-Logging，slf4j 是对不同日志框架提供的一个 API 封装，可以在部署的时候不修改任何配置即可接入一种日志实现方案。但是，slf4j 在<strong>编译时</strong>静态绑定真正的 Log 库。使用 SLF4J 时，如果你需要使用某一种日志实现，那么你必须选择正确的 SLF4J 的 jar 包的集合（各种桥接包）。</p>
<p><a target="_blank" rel="noopener" href="http://www.slf4j.org/">官网地址</a></p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/cs/java/javalib/log/slf4j-to-other-log.png" alt="img"></p>
<h3 id="common-logging-vs-slf4j"><a href="#common-logging-vs-slf4j" class="headerlink" title="common-logging vs slf4j"></a>common-logging vs slf4j</h3><p>slf4j 库类似于 Apache Common-Logging。但是，他在编译时静态绑定真正的日志库。这点似乎很麻烦，其实也不过是导入桥接 jar 包而已。</p>
<p>slf4j 一大亮点是提供了更方便的日志记录方式：</p>
<p>不需要使用<code>logger.isDebugEnabled()</code>来解决日志因为字符拼接产生的性能问题。slf4j 的方式是使用<code>&#123;&#125;</code>作为字符串替换符，形式如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">logger.debug(<span class="string">&quot;id: &#123;&#125;, name: &#123;&#125; &quot;</span>, id, name);</span><br></pre></td></tr></table></figure>

<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>综上所述，使用 slf4j + Logback 可谓是目前最理想的日志解决方案了。</p>
<p>接下来，就是如何在项目中实施了。</p>
<h2 id="实施日志解决方案"><a href="#实施日志解决方案" class="headerlink" title="实施日志解决方案"></a>实施日志解决方案</h2><p>使用日志解决方案基本可分为三步：</p>
<ol>
<li>引入 jar 包</li>
<li>配置</li>
<li>使用 API</li>
</ol>
<p>常见的各种日志解决方案的第 2 步和第 3 步基本一样，实施上的差别主要在第 1 步，也就是使用不同的库。</p>
<h3 id="引入-jar-包"><a href="#引入-jar-包" class="headerlink" title="引入 jar 包"></a>引入 jar 包</h3><p>这里首选推荐使用 slf4j + logback 的组合。</p>
<p>如果你习惯了 common-logging，可以选择 common-logging+log4j。</p>
<p>强烈建议不要直接使用日志实现组件(logback、log4j、java.util.logging)，理由前面也说过，就是无法灵活替换日志库。</p>
<p>还有一种情况：你的老项目使用了 common-logging，或是直接使用日志实现组件。如果修改老的代码，工作量太大，需要兼容处理。在下文，都将看到各种应对方法。</p>
<p><strong><em>注：据我所知，当前仍没有方法可以将 slf4j 桥接到 common-logging。如果我孤陋寡闻了，请不吝赐教。</em></strong></p>
<h4 id="slf4j-直接绑定日志组件"><a href="#slf4j-直接绑定日志组件" class="headerlink" title="slf4j 直接绑定日志组件"></a>slf4j 直接绑定日志组件</h4><p><strong>slf4j + logback</strong></p>
<p>添加依赖到 pom.xml 中即可。</p>
<p><em>logback-classic-1.0.13.jar</em> 会自动将 <em>slf4j-api-1.7.21.jar</em> 和 <em>logback-core-1.0.13.jar</em> 也添加到你的项目中。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>ch.qos.logback<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>logback-classic<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.13<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>slf4j + log4j</strong></p>
<p>添加依赖到 pom.xml 中即可。</p>
<p><em>slf4j-log4j12-1.7.21.jar</em> 会自动将 <em>slf4j-api-1.7.21.jar</em> 和 <em>log4j-1.2.17.jar</em> 也添加到你的项目中。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>slf4j-log4j12<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.7.21<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>slf4j + java.util.logging</strong></p>
<p>添加依赖到 pom.xml 中即可。</p>
<p><em>slf4j-jdk14-1.7.21.jar</em> 会自动将 <em>slf4j-api-1.7.21.jar</em> 也添加到你的项目中。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>slf4j-jdk14<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.7.21<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="slf4j-兼容非-slf4j-日志组件"><a href="#slf4j-兼容非-slf4j-日志组件" class="headerlink" title="slf4j 兼容非 slf4j 日志组件"></a>slf4j 兼容非 slf4j 日志组件</h4><p>在介绍解决方案前，先提一个概念——桥接</p>
<p><strong>什么是桥接呢</strong></p>
<p>假如你正在开发应用程序所调用的组件当中已经使用了 common-logging，这时你需要 jcl-over-slf4j.jar 把日志信息输出重定向到 slf4j-api，slf4j-api 再去调用 slf4j 实际依赖的日志组件。这个过程称为桥接。下图是官方的 slf4j 桥接策略图：</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/cs/java/javalib/log/slf4j-bind-strategy.png" alt="img"></p>
<p>从图中应该可以看出，无论你的老项目中使用的是 common-logging 或是直接使用 log4j、java.util.logging，都可以使用对应的桥接 jar 包来解决兼容问题。</p>
<p><strong>slf4j 兼容 common-logging</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jcl-over-slf4j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.7.12<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>slf4j 兼容 log4j</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log4j-over-slf4j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.7.12<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>slf4j 兼容 java.util.logging</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jul-to-slf4j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.7.12<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="spring-集成-slf4j"><a href="#spring-集成-slf4j" class="headerlink" title="spring 集成 slf4j"></a>spring 集成 slf4j</h4><p>做 java web 开发，基本离不开 spring 框架。很遗憾，spring 使用的日志解决方案是 common-logging + log4j。</p>
<p>所以，你需要一个桥接 jar 包：_logback-ext-spring_。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>ch.qos.logback<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>logback-classic<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.logback-extensions<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>logback-ext-spring<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.1.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jcl-over-slf4j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.7.12<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="common-logging-绑定日志组件"><a href="#common-logging-绑定日志组件" class="headerlink" title="common-logging 绑定日志组件"></a>common-logging 绑定日志组件</h4><p><strong>common-logging + log4j</strong></p>
<p>添加依赖到 pom.xml 中即可。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-logging<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-logging<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>log4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log4j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.17<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="使用-API"><a href="#使用-API" class="headerlink" title="使用 API"></a>使用 API</h3><h4 id="slf4j-用法"><a href="#slf4j-用法" class="headerlink" title="slf4j 用法"></a>slf4j 用法</h4><p>使用 slf4j 的 API 很简单。使用<code>LoggerFactory</code>初始化一个<code>Logger</code>实例，然后调用 Logger 对应的打印等级函数就行了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">App</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">log</span> <span class="operator">=</span> LoggerFactory.getLogger(App.class);</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="string">&quot;print log, current level: &#123;&#125;&quot;</span>;</span><br><span class="line">        log.trace(msg, <span class="string">&quot;trace&quot;</span>);</span><br><span class="line">        log.debug(msg, <span class="string">&quot;debug&quot;</span>);</span><br><span class="line">        log.info(msg, <span class="string">&quot;info&quot;</span>);</span><br><span class="line">        log.warn(msg, <span class="string">&quot;warn&quot;</span>);</span><br><span class="line">        log.error(msg, <span class="string">&quot;error&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="common-logging-用法"><a href="#common-logging-用法" class="headerlink" title="common-logging 用法"></a>common-logging 用法</h4><p>common-logging 用法和 slf4j 几乎一样，但是支持的打印等级多了一个更高级别的：<strong>fatal</strong>。</p>
<p>此外，common-logging 不支持<code>&#123;&#125;</code>替换参数，你只能选择拼接字符串这种方式了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.logging.Log;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.logging.LogFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JclTest</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Log</span> <span class="variable">log</span> <span class="operator">=</span> LogFactory.getLog(JclTest.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="string">&quot;print log, current level: &quot;</span>;</span><br><span class="line">        log.trace(msg + <span class="string">&quot;trace&quot;</span>);</span><br><span class="line">        log.debug(msg + <span class="string">&quot;debug&quot;</span>);</span><br><span class="line">        log.info(msg + <span class="string">&quot;info&quot;</span>);</span><br><span class="line">        log.warn(msg + <span class="string">&quot;warn&quot;</span>);</span><br><span class="line">        log.error(msg + <span class="string">&quot;error&quot;</span>);</span><br><span class="line">        log.fatal(msg + <span class="string">&quot;fatal&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="log4j2-配置"><a href="#log4j2-配置" class="headerlink" title="log4j2 配置"></a>log4j2 配置</h2><p>log4j2 基本配置形式如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span>;</span><br><span class="line"><span class="tag">&lt;<span class="name">Configuration</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">Properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Property</span> <span class="attr">name</span>=<span class="string">&quot;name1&quot;</span>&gt;</span>value<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Property</span> <span class="attr">name</span>=<span class="string">&quot;name2&quot;</span> <span class="attr">value</span>=<span class="string">&quot;value2&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">Properties</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">Filter</span> <span class="attr">type</span>=<span class="string">&quot;type&quot;</span> <span class="attr">...</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">Appenders</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Appender</span> <span class="attr">type</span>=<span class="string">&quot;type&quot;</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">Filter</span> <span class="attr">type</span>=<span class="string">&quot;type&quot;</span> <span class="attr">...</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Appender</span>&gt;</span></span><br><span class="line">    ...</span><br><span class="line">  <span class="tag">&lt;/<span class="name">Appenders</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">Loggers</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Logger</span> <span class="attr">name</span>=<span class="string">&quot;name1&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">Filter</span> <span class="attr">type</span>=<span class="string">&quot;type&quot;</span> <span class="attr">...</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Logger</span>&gt;</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="tag">&lt;<span class="name">Root</span> <span class="attr">level</span>=<span class="string">&quot;level&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">AppenderRef</span> <span class="attr">ref</span>=<span class="string">&quot;name&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Root</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">Loggers</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>配置示例：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Configuration</span> <span class="attr">status</span>=<span class="string">&quot;debug&quot;</span> <span class="attr">strict</span>=<span class="string">&quot;true&quot;</span> <span class="attr">name</span>=<span class="string">&quot;XMLConfigTest&quot;</span></span></span><br><span class="line"><span class="tag">               <span class="attr">packages</span>=<span class="string">&quot;org.apache.logging.log4j.test&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">Properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Property</span> <span class="attr">name</span>=<span class="string">&quot;filename&quot;</span>&gt;</span>target/test.log<span class="tag">&lt;/<span class="name">Property</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">Properties</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">Filter</span> <span class="attr">type</span>=<span class="string">&quot;ThresholdFilter&quot;</span> <span class="attr">level</span>=<span class="string">&quot;trace&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">Appenders</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Appender</span> <span class="attr">type</span>=<span class="string">&quot;Console&quot;</span> <span class="attr">name</span>=<span class="string">&quot;STDOUT&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">Layout</span> <span class="attr">type</span>=<span class="string">&quot;PatternLayout&quot;</span> <span class="attr">pattern</span>=<span class="string">&quot;%m MDC%X%n&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">Filters</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Filter</span> <span class="attr">type</span>=<span class="string">&quot;MarkerFilter&quot;</span> <span class="attr">marker</span>=<span class="string">&quot;FLOW&quot;</span> <span class="attr">onMatch</span>=<span class="string">&quot;DENY&quot;</span> <span class="attr">onMismatch</span>=<span class="string">&quot;NEUTRAL&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Filter</span> <span class="attr">type</span>=<span class="string">&quot;MarkerFilter&quot;</span> <span class="attr">marker</span>=<span class="string">&quot;EXCEPTION&quot;</span> <span class="attr">onMatch</span>=<span class="string">&quot;DENY&quot;</span> <span class="attr">onMismatch</span>=<span class="string">&quot;ACCEPT&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">Filters</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Appender</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Appender</span> <span class="attr">type</span>=<span class="string">&quot;Console&quot;</span> <span class="attr">name</span>=<span class="string">&quot;FLOW&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">Layout</span> <span class="attr">type</span>=<span class="string">&quot;PatternLayout&quot;</span> <span class="attr">pattern</span>=<span class="string">&quot;%C&#123;1&#125;.%M %m %ex%n&quot;</span>/&gt;</span><span class="comment">&lt;!-- class and line number --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">Filters</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Filter</span> <span class="attr">type</span>=<span class="string">&quot;MarkerFilter&quot;</span> <span class="attr">marker</span>=<span class="string">&quot;FLOW&quot;</span> <span class="attr">onMatch</span>=<span class="string">&quot;ACCEPT&quot;</span> <span class="attr">onMismatch</span>=<span class="string">&quot;NEUTRAL&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Filter</span> <span class="attr">type</span>=<span class="string">&quot;MarkerFilter&quot;</span> <span class="attr">marker</span>=<span class="string">&quot;EXCEPTION&quot;</span> <span class="attr">onMatch</span>=<span class="string">&quot;ACCEPT&quot;</span> <span class="attr">onMismatch</span>=<span class="string">&quot;DENY&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">Filters</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Appender</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Appender</span> <span class="attr">type</span>=<span class="string">&quot;File&quot;</span> <span class="attr">name</span>=<span class="string">&quot;File&quot;</span> <span class="attr">fileName</span>=<span class="string">&quot;$&#123;filename&#125;&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">Layout</span> <span class="attr">type</span>=<span class="string">&quot;PatternLayout&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Pattern</span>&gt;</span>%d %p %C&#123;1.&#125; [%t] %m%n<span class="tag">&lt;/<span class="name">Pattern</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">Layout</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Appender</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">Appenders</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">Loggers</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Logger</span> <span class="attr">name</span>=<span class="string">&quot;org.apache.logging.log4j.test1&quot;</span> <span class="attr">level</span>=<span class="string">&quot;debug&quot;</span> <span class="attr">additivity</span>=<span class="string">&quot;false&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">Filter</span> <span class="attr">type</span>=<span class="string">&quot;ThreadContextMapFilter&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">KeyValuePair</span> <span class="attr">key</span>=<span class="string">&quot;test&quot;</span> <span class="attr">value</span>=<span class="string">&quot;123&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">Filter</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">AppenderRef</span> <span class="attr">ref</span>=<span class="string">&quot;STDOUT&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Logger</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">Logger</span> <span class="attr">name</span>=<span class="string">&quot;org.apache.logging.log4j.test2&quot;</span> <span class="attr">level</span>=<span class="string">&quot;debug&quot;</span> <span class="attr">additivity</span>=<span class="string">&quot;false&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">AppenderRef</span> <span class="attr">ref</span>=<span class="string">&quot;File&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Logger</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">Root</span> <span class="attr">level</span>=<span class="string">&quot;trace&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">AppenderRef</span> <span class="attr">ref</span>=<span class="string">&quot;STDOUT&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Root</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">Loggers</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">Configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="logback-配置"><a href="#logback-配置" class="headerlink" title="logback 配置"></a>logback 配置</h2><h3 id=""><a href="#" class="headerlink" title="&lt;configuration&gt;"></a><code>&lt;configuration&gt;</code></h3><ul>
<li>作用：<code>&lt;configuration&gt;</code> 是 logback 配置文件的根元素。</li>
<li>要点<ul>
<li>它有 <code>&lt;appender&gt;</code>、<code>&lt;logger&gt;</code>、<code>&lt;root&gt;</code> 三个子元素。</li>
</ul>
</li>
</ul>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/cs/java/javalib/log/logback-configuration.png" alt="img"></p>
<h3 id="-1"><a href="#-1" class="headerlink" title="&lt;appender&gt;"></a><code>&lt;appender&gt;</code></h3><ul>
<li>作用：将记录日志的任务委托给名为 appender 的组件。</li>
<li>要点<ul>
<li>可以配置零个或多个。</li>
<li>它有 <code>&lt;file&gt;</code>、<code>&lt;filter&gt;</code>、<code>&lt;layout&gt;</code>、<code>&lt;encoder&gt;</code> 四个子元素。</li>
</ul>
</li>
<li>属性<ul>
<li>name：设置 appender 名称。</li>
<li>class：设置具体的实例化类。</li>
</ul>
</li>
</ul>
<h4 id="-2"><a href="#-2" class="headerlink" title="&lt;file&gt;"></a><code>&lt;file&gt;</code></h4><ul>
<li>作用：设置日志文件路径。</li>
</ul>
<h4 id="-3"><a href="#-3" class="headerlink" title="&lt;filter&gt;"></a><code>&lt;filter&gt;</code></h4><ul>
<li>作用：设置过滤器。</li>
<li>要点<ul>
<li>可以配置零个或多个。</li>
</ul>
</li>
</ul>
<h4 id="-4"><a href="#-4" class="headerlink" title="&lt;layout&gt;"></a><code>&lt;layout&gt;</code></h4><ul>
<li>作用：设置 appender。</li>
<li>要点<ul>
<li>可以配置零个或一个。</li>
</ul>
</li>
<li>属性<ul>
<li>class：设置具体的实例化类。</li>
</ul>
</li>
</ul>
<h4 id="-5"><a href="#-5" class="headerlink" title="&lt;encoder&gt;"></a><code>&lt;encoder&gt;</code></h4><ul>
<li>作用：设置编码。</li>
<li>要点<ul>
<li>可以配置零个或多个。</li>
</ul>
</li>
<li>属性<ul>
<li>class：设置具体的实例化类。</li>
</ul>
</li>
</ul>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/cs/java/javalib/log/logback-appender.png" alt="img"></p>
<h3 id="-6"><a href="#-6" class="headerlink" title="&lt;logger&gt;"></a><code>&lt;logger&gt;</code></h3><ul>
<li>作用：设置 logger。</li>
<li>要点<ul>
<li>可以配置零个或多个。</li>
</ul>
</li>
<li>属性<ul>
<li>name</li>
<li>level：设置日志级别。不区分大小写。可选值：TRACE、DEBUG、INFO、WARN、ERROR、ALL、OFF。</li>
<li>additivity：可选值：true 或 false。</li>
</ul>
</li>
</ul>
<h4 id="-7"><a href="#-7" class="headerlink" title="&lt;appender-ref&gt;"></a><code>&lt;appender-ref&gt;</code></h4><ul>
<li>作用：appender 引用。</li>
<li>要点<ul>
<li>可以配置零个或多个。</li>
</ul>
</li>
</ul>
<h3 id="-8"><a href="#-8" class="headerlink" title="&lt;root&gt;"></a><code>&lt;root&gt;</code></h3><ul>
<li>作用：设置根 logger。</li>
<li>要点<ul>
<li>只能配置一个。</li>
<li>除了 level，不支持任何属性。level 属性和 <code>&lt;logger&gt;</code> 中的相同。</li>
<li>有一个子元素 <code>&lt;appender-ref&gt;</code>，与 <code>&lt;logger&gt;</code> 中的相同。</li>
</ul>
</li>
</ul>
<h3 id="完整的-logback-xml-参考示例"><a href="#完整的-logback-xml-参考示例" class="headerlink" title="完整的 logback.xml 参考示例"></a>完整的 logback.xml 参考示例</h3><p>在下面的配置文件中，我为自己的项目代码（根目录：org.zp.notes.spring）设置了五种等级：</p>
<p>TRACE、DEBUG、INFO、WARN、ERROR，优先级依次从低到高。</p>
<p>因为关注 spring 框架本身的一些信息，我增加了专门打印 spring WARN 及以上等级的日志。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- logback中一共有5种有效级别，分别是TRACE、DEBUG、INFO、WARN、ERROR，优先级依次从低到高 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span> <span class="attr">scan</span>=<span class="string">&quot;true&quot;</span> <span class="attr">scanPeriod</span>=<span class="string">&quot;60 seconds&quot;</span> <span class="attr">debug</span>=<span class="string">&quot;false&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;DIR_NAME&quot;</span> <span class="attr">value</span>=<span class="string">&quot;spring-helloworld&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- 将记录日志打印到控制台 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">&quot;STDOUT&quot;</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.ConsoleAppender&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">encoder</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>%d&#123;HH:mm:ss.SSS&#125; [%thread] [%-5p] %c&#123;36&#125;.%M - %m%n<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- RollingFileAppender begin --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">&quot;ALL&quot;</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 根据时间来制定滚动策略 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rollingPolicy</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.TimeBasedRollingPolicy&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">fileNamePattern</span>&gt;</span>$&#123;user.dir&#125;/logs/$&#123;DIR_NAME&#125;/all.%d&#123;yyyy-MM-dd&#125;.log<span class="tag">&lt;/<span class="name">fileNamePattern</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">maxHistory</span>&gt;</span>30<span class="tag">&lt;/<span class="name">maxHistory</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">rollingPolicy</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 根据文件大小来制定滚动策略 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">triggeringPolicy</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.SizeBasedTriggeringPolicy&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">maxFileSize</span>&gt;</span>30MB<span class="tag">&lt;/<span class="name">maxFileSize</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">triggeringPolicy</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">encoder</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>%d&#123;HH:mm:ss.SSS&#125; [%thread] [%-5p] %c&#123;36&#125;.%M - %m%n<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">&quot;ERROR&quot;</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 根据时间来制定滚动策略 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rollingPolicy</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.TimeBasedRollingPolicy&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">fileNamePattern</span>&gt;</span>$&#123;user.dir&#125;/logs/$&#123;DIR_NAME&#125;/error.%d&#123;yyyy-MM-dd&#125;.log<span class="tag">&lt;/<span class="name">fileNamePattern</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">maxHistory</span>&gt;</span>30<span class="tag">&lt;/<span class="name">maxHistory</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">rollingPolicy</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 根据文件大小来制定滚动策略 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">triggeringPolicy</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.SizeBasedTriggeringPolicy&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">maxFileSize</span>&gt;</span>10MB<span class="tag">&lt;/<span class="name">maxFileSize</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">triggeringPolicy</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.classic.filter.LevelFilter&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">level</span>&gt;</span>ERROR<span class="tag">&lt;/<span class="name">level</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">onMatch</span>&gt;</span>ACCEPT<span class="tag">&lt;/<span class="name">onMatch</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">onMismatch</span>&gt;</span>DENY<span class="tag">&lt;/<span class="name">onMismatch</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">encoder</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>%d&#123;HH:mm:ss.SSS&#125; [%thread] [%-5p] %c&#123;36&#125;.%M - %m%n<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">&quot;WARN&quot;</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 根据时间来制定滚动策略 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rollingPolicy</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.TimeBasedRollingPolicy&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">fileNamePattern</span>&gt;</span>$&#123;user.dir&#125;/logs/$&#123;DIR_NAME&#125;/warn.%d&#123;yyyy-MM-dd&#125;.log<span class="tag">&lt;/<span class="name">fileNamePattern</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">maxHistory</span>&gt;</span>30<span class="tag">&lt;/<span class="name">maxHistory</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">rollingPolicy</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 根据文件大小来制定滚动策略 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">triggeringPolicy</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.SizeBasedTriggeringPolicy&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">maxFileSize</span>&gt;</span>10MB<span class="tag">&lt;/<span class="name">maxFileSize</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">triggeringPolicy</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.classic.filter.LevelFilter&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">level</span>&gt;</span>WARN<span class="tag">&lt;/<span class="name">level</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">onMatch</span>&gt;</span>ACCEPT<span class="tag">&lt;/<span class="name">onMatch</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">onMismatch</span>&gt;</span>DENY<span class="tag">&lt;/<span class="name">onMismatch</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">encoder</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>%d&#123;HH:mm:ss.SSS&#125; [%thread] [%-5p] %c&#123;36&#125;.%M - %m%n<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">&quot;INFO&quot;</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 根据时间来制定滚动策略 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rollingPolicy</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.TimeBasedRollingPolicy&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">fileNamePattern</span>&gt;</span>$&#123;user.dir&#125;/logs/$&#123;DIR_NAME&#125;/info.%d&#123;yyyy-MM-dd&#125;.log<span class="tag">&lt;/<span class="name">fileNamePattern</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">maxHistory</span>&gt;</span>30<span class="tag">&lt;/<span class="name">maxHistory</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">rollingPolicy</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 根据文件大小来制定滚动策略 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">triggeringPolicy</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.SizeBasedTriggeringPolicy&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">maxFileSize</span>&gt;</span>10MB<span class="tag">&lt;/<span class="name">maxFileSize</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">triggeringPolicy</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.classic.filter.LevelFilter&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">level</span>&gt;</span>INFO<span class="tag">&lt;/<span class="name">level</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">onMatch</span>&gt;</span>ACCEPT<span class="tag">&lt;/<span class="name">onMatch</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">onMismatch</span>&gt;</span>DENY<span class="tag">&lt;/<span class="name">onMismatch</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">encoder</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>%d&#123;HH:mm:ss.SSS&#125; [%thread] [%-5p] %c&#123;36&#125;.%M - %m%n<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">&quot;DEBUG&quot;</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 根据时间来制定滚动策略 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rollingPolicy</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.TimeBasedRollingPolicy&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">fileNamePattern</span>&gt;</span>$&#123;user.dir&#125;/logs/$&#123;DIR_NAME&#125;/debug.%d&#123;yyyy-MM-dd&#125;.log<span class="tag">&lt;/<span class="name">fileNamePattern</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">maxHistory</span>&gt;</span>30<span class="tag">&lt;/<span class="name">maxHistory</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">rollingPolicy</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 根据文件大小来制定滚动策略 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">triggeringPolicy</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.SizeBasedTriggeringPolicy&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">maxFileSize</span>&gt;</span>10MB<span class="tag">&lt;/<span class="name">maxFileSize</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">triggeringPolicy</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.classic.filter.LevelFilter&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">level</span>&gt;</span>DEBUG<span class="tag">&lt;/<span class="name">level</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">onMatch</span>&gt;</span>ACCEPT<span class="tag">&lt;/<span class="name">onMatch</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">onMismatch</span>&gt;</span>DENY<span class="tag">&lt;/<span class="name">onMismatch</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">encoder</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>%d&#123;HH:mm:ss.SSS&#125; [%thread] [%-5p] %c&#123;36&#125;.%M - %m%n<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">&quot;TRACE&quot;</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 根据时间来制定滚动策略 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rollingPolicy</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.TimeBasedRollingPolicy&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">fileNamePattern</span>&gt;</span>$&#123;user.dir&#125;/logs/$&#123;DIR_NAME&#125;/trace.%d&#123;yyyy-MM-dd&#125;.log<span class="tag">&lt;/<span class="name">fileNamePattern</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">maxHistory</span>&gt;</span>30<span class="tag">&lt;/<span class="name">maxHistory</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">rollingPolicy</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 根据文件大小来制定滚动策略 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">triggeringPolicy</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.SizeBasedTriggeringPolicy&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">maxFileSize</span>&gt;</span>10MB<span class="tag">&lt;/<span class="name">maxFileSize</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">triggeringPolicy</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.classic.filter.LevelFilter&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">level</span>&gt;</span>TRACE<span class="tag">&lt;/<span class="name">level</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">onMatch</span>&gt;</span>ACCEPT<span class="tag">&lt;/<span class="name">onMatch</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">onMismatch</span>&gt;</span>DENY<span class="tag">&lt;/<span class="name">onMismatch</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">encoder</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>%d&#123;HH:mm:ss.SSS&#125; [%thread] [%-5p] %c&#123;36&#125;.%M - %m%n<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">&quot;SPRING&quot;</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 根据时间来制定滚动策略 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rollingPolicy</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.TimeBasedRollingPolicy&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">fileNamePattern</span>&gt;</span>$&#123;user.dir&#125;/logs/$&#123;DIR_NAME&#125;/springframework.%d&#123;yyyy-MM-dd&#125;.log</span><br><span class="line">      <span class="tag">&lt;/<span class="name">fileNamePattern</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">maxHistory</span>&gt;</span>30<span class="tag">&lt;/<span class="name">maxHistory</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">rollingPolicy</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 根据文件大小来制定滚动策略 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">triggeringPolicy</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.SizeBasedTriggeringPolicy&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">maxFileSize</span>&gt;</span>10MB<span class="tag">&lt;/<span class="name">maxFileSize</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">triggeringPolicy</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">encoder</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>%d&#123;HH:mm:ss.SSS&#125; [%thread] [%-5p] %c&#123;36&#125;.%M - %m%n<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- RollingFileAppender end --&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- logger begin --&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- 本项目的日志记录，分级打印 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">logger</span> <span class="attr">name</span>=<span class="string">&quot;org.zp.notes.spring&quot;</span> <span class="attr">level</span>=<span class="string">&quot;TRACE&quot;</span> <span class="attr">additivity</span>=<span class="string">&quot;false&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;STDOUT&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;ERROR&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;WARN&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;INFO&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;DEBUG&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;TRACE&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">logger</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- SPRING框架日志 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">logger</span> <span class="attr">name</span>=<span class="string">&quot;org.springframework&quot;</span> <span class="attr">level</span>=<span class="string">&quot;WARN&quot;</span> <span class="attr">additivity</span>=<span class="string">&quot;false&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;SPRING&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">logger</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">root</span> <span class="attr">level</span>=<span class="string">&quot;TRACE&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;ALL&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- logger end --&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="log4j-配置"><a href="#log4j-配置" class="headerlink" title="log4j 配置"></a>log4j 配置</h2><h3 id="完整的-log4j-xml-参考示例"><a href="#完整的-log4j-xml-参考示例" class="headerlink" title="完整的 log4j.xml 参考示例"></a>完整的 log4j.xml 参考示例</h3><p>log4j 的配置文件一般有 xml 格式或 properties 格式。这里为了和 logback.xml 做个对比，就不介绍 properties 了，其实也没太大差别。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">log4j</span>:configuration <span class="keyword">SYSTEM</span> <span class="string">&quot;log4j.dtd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">log4j:configuration</span> <span class="attr">xmlns:log4j</span>=<span class="string">&#x27;http://jakarta.apache.org/log4j/&#x27;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">&quot;STDOUT&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.apache.log4j.ConsoleAppender&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">layout</span> <span class="attr">class</span>=<span class="string">&quot;org.apache.log4j.PatternLayout&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">&quot;ConversionPattern&quot;</span></span></span><br><span class="line"><span class="tag">             <span class="attr">value</span>=<span class="string">&quot;%d&#123;yyyy-MM-dd HH:mm:ss,SSS\&#125; [%-5p] [%t] %c&#123;36\&#125;.%M - %m%n&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">layout</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--过滤器设置输出的级别--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter</span> <span class="attr">class</span>=<span class="string">&quot;org.apache.log4j.varia.LevelRangeFilter&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">&quot;levelMin&quot;</span> <span class="attr">value</span>=<span class="string">&quot;debug&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">&quot;levelMax&quot;</span> <span class="attr">value</span>=<span class="string">&quot;fatal&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">&quot;AcceptOnMatch&quot;</span> <span class="attr">value</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">&quot;ALL&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.apache.log4j.DailyRollingFileAppender&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">&quot;File&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;user.dir&#125;/logs/spring-common/jcl/all&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">&quot;Append&quot;</span> <span class="attr">value</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 每天重新生成日志文件 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">&quot;DatePattern&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&#x27;-&#x27;yyyy-MM-dd&#x27;.log&#x27;&quot;</span>/&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 每小时重新生成日志文件 --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--&lt;param name=&quot;DatePattern&quot; value=&quot;&#x27;-&#x27;yyyy-MM-dd-HH&#x27;.log&#x27;&quot;/&gt;--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">layout</span> <span class="attr">class</span>=<span class="string">&quot;org.apache.log4j.PatternLayout&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">&quot;ConversionPattern&quot;</span></span></span><br><span class="line"><span class="tag">             <span class="attr">value</span>=<span class="string">&quot;%d&#123;yyyy-MM-dd HH:mm:ss,SSS\&#125; [%-5p] [%t] %c&#123;36\&#125;.%M - %m%n&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">layout</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- 指定logger的设置，additivity指示是否遵循缺省的继承机制--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">logger</span> <span class="attr">name</span>=<span class="string">&quot;org.zp.notes.spring&quot;</span> <span class="attr">additivity</span>=<span class="string">&quot;false&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">level</span> <span class="attr">value</span>=<span class="string">&quot;error&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;STDOUT&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;ALL&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">logger</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- 根logger的设置--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">root</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">level</span> <span class="attr">value</span>=<span class="string">&quot;warn&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;STDOUT&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">log4j:configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a target="_blank" rel="noopener" href="http://www.slf4j.org/manual.html">slf4 官方文档</a></li>
<li><a target="_blank" rel="noopener" href="http://logback.qos.ch/">logback 官方文档</a></li>
<li><a target="_blank" rel="noopener" href="http://logging.apache.org/log4j/1.2/">log4j 官方文档</a></li>
<li><a target="_blank" rel="noopener" href="http://commons.apache.org/proper/commons-logging/">commons-logging 官方文档</a></li>
<li><a target="_blank" rel="noopener" href="http://blog.csdn.net/yycdaizi/article/details/8276265">http://blog.csdn.net/yycdaizi/article/details/8276265</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://dunwu.github.io/blog/pages/ce6195/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/uploads/avatar.gif">
      <meta itemprop="name" content="钝悟 ◾ Dunwu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dunwu Blog">
      <meta itemprop="description" content="钝悟的个人博客">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Dunwu Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/pages/ce6195/" class="post-title-link" itemprop="url">Reflections 快速入门</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-02-17 22:34:30" itemprop="dateCreated datePublished" datetime="2022-02-17T22:34:30+08:00">2022-02-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-01-27 23:32:48" itemprop="dateModified" datetime="2024-01-27T23:32:48+08:00">2024-01-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/%E5%B7%A5%E5%85%B7/" itemprop="url" rel="index"><span itemprop="name">工具</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/%E5%B7%A5%E5%85%B7/%E5%85%B6%E4%BB%96/" itemprop="url" rel="index"><span itemprop="name">其他</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>2.7k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>2 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Reflections-快速入门"><a href="#Reflections-快速入门" class="headerlink" title="Reflections 快速入门"></a>Reflections 快速入门</h1><p>引入 pom</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.reflections<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>reflections<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.9.11<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>典型应用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Reflections</span> <span class="variable">reflections</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Reflections</span>(<span class="string">&quot;my.project&quot;</span>);</span><br><span class="line">Set&lt;Class&lt;? <span class="keyword">extends</span> <span class="title class_">SomeType</span>&gt;&gt; subTypes = reflections.getSubTypesOf(SomeType.class);</span><br><span class="line">Set&lt;Class&lt;?&gt;&gt; annotated = reflections.getTypesAnnotatedWith(SomeAnnotation.class);</span><br></pre></td></tr></table></figure>

<h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><p>基本上，使用 Reflections 首先使用 urls 和 scanners 对其进行实例化</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//scan urls that contain &#x27;my.package&#x27;, include inputs starting with &#x27;my.package&#x27;, use the default scanners</span></span><br><span class="line"><span class="type">Reflections</span> <span class="variable">reflections</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Reflections</span>(<span class="string">&quot;my.package&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//or using ConfigurationBuilder</span></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Reflections</span>(<span class="keyword">new</span> <span class="title class_">ConfigurationBuilder</span>()</span><br><span class="line">     .setUrls(ClasspathHelper.forPackage(<span class="string">&quot;my.project.prefix&quot;</span>))</span><br><span class="line">     .setScanners(<span class="keyword">new</span> <span class="title class_">SubTypesScanner</span>(),</span><br><span class="line">                  <span class="keyword">new</span> <span class="title class_">TypeAnnotationsScanner</span>().filterResultsBy(optionalFilter), ...),</span><br><span class="line">     .filterInputsBy(<span class="keyword">new</span> <span class="title class_">FilterBuilder</span>().includePackage(<span class="string">&quot;my.project.prefix&quot;</span>))</span><br><span class="line">     ...);</span><br></pre></td></tr></table></figure>

<p>然后，使用方便的查询方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 子类型扫描</span></span><br><span class="line">Set&lt;Class&lt;? <span class="keyword">extends</span> <span class="title class_">Module</span>&gt;&gt; modules =</span><br><span class="line">    reflections.getSubTypesOf(com.google.inject.Module.class);</span><br><span class="line"><span class="comment">// 类型注解扫描</span></span><br><span class="line">Set&lt;Class&lt;?&gt;&gt; singletons =</span><br><span class="line">    reflections.getTypesAnnotatedWith(javax.inject.Singleton.class);</span><br><span class="line"><span class="comment">// 资源扫描</span></span><br><span class="line">Set&lt;String&gt; properties =</span><br><span class="line">    reflections.getResources(Pattern.compile(<span class="string">&quot;.*\\.properties&quot;</span>));</span><br><span class="line"><span class="comment">// 方法注解扫描</span></span><br><span class="line">Set&lt;Method&gt; resources =</span><br><span class="line">    reflections.getMethodsAnnotatedWith(javax.ws.rs.Path.class);</span><br><span class="line">Set&lt;Constructor&gt; injectables =</span><br><span class="line">    reflections.getConstructorsAnnotatedWith(javax.inject.Inject.class);</span><br><span class="line"><span class="comment">// 字段注解扫描</span></span><br><span class="line">Set&lt;Field&gt; ids =</span><br><span class="line">    reflections.getFieldsAnnotatedWith(javax.persistence.Id.class);</span><br><span class="line"><span class="comment">// 方法参数扫描</span></span><br><span class="line">Set&lt;Method&gt; someMethods =</span><br><span class="line">    reflections.getMethodsMatchParams(<span class="type">long</span>.class, <span class="type">int</span>.class);</span><br><span class="line">Set&lt;Method&gt; voidMethods =</span><br><span class="line">    reflections.getMethodsReturn(<span class="keyword">void</span>.class);</span><br><span class="line">Set&lt;Method&gt; pathParamMethods =</span><br><span class="line">    reflections.getMethodsWithAnyParamAnnotated(PathParam.class);</span><br><span class="line"><span class="comment">// 方法参数名扫描</span></span><br><span class="line">List&lt;String&gt; parameterNames =</span><br><span class="line">    reflections.getMethodParamNames(Method.class)</span><br><span class="line"><span class="comment">// 方法使用扫描</span></span><br><span class="line">Set&lt;Member&gt; usages =</span><br><span class="line">    reflections.getMethodUsages(Method.class)</span><br></pre></td></tr></table></figure>

<p>说明：</p>
<ul>
<li>如果未配置扫描程序，则将使用默认值 - SubTypesScanner 和 TypeAnnotationsScanner。</li>
<li>还可以配置类加载器，它将用于从名称中解析运行时类。</li>
<li>Reflection 默认情况下会扩展超类型。 这解决了传输 URL 不被扫描的一些问题。</li>
</ul>
<h2 id="ReflectionUtils"><a href="#ReflectionUtils" class="headerlink" title="ReflectionUtils"></a>ReflectionUtils</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.reflections.ReflectionUtils.*;</span><br><span class="line"></span><br><span class="line">Set&lt;Method&gt; getters = getAllMethods(someClass,</span><br><span class="line">  withModifier(Modifier.PUBLIC), withPrefix(<span class="string">&quot;get&quot;</span>), withParametersCount(<span class="number">0</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">//or</span></span><br><span class="line">Set&lt;Method&gt; listMethodsFromCollectionToBoolean =</span><br><span class="line">  getAllMethods(List.class,</span><br><span class="line">    withParametersAssignableTo(Collection.class), withReturnType(<span class="type">boolean</span>.class));</span><br><span class="line"></span><br><span class="line">Set&lt;Field&gt; fields = getAllFields(SomeClass.class, withAnnotation(annotation), withTypeAssignableTo(type));</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://dunwu.github.io/blog/pages/27ad42/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/uploads/avatar.gif">
      <meta itemprop="name" content="钝悟 ◾ Dunwu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dunwu Blog">
      <meta itemprop="description" content="钝悟的个人博客">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Dunwu Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/pages/27ad42/" class="post-title-link" itemprop="url">javalib-util</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-02-17 22:34:30" itemprop="dateCreated datePublished" datetime="2022-02-17T22:34:30+08:00">2022-02-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-01-27 23:32:48" itemprop="dateModified" datetime="2024-01-27T23:32:48+08:00">2024-01-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/%E5%B7%A5%E5%85%B7/" itemprop="url" rel="index"><span itemprop="name">工具</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/%E5%B7%A5%E5%85%B7/%E5%85%B6%E4%BB%96/" itemprop="url" rel="index"><span itemprop="name">其他</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>70</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>1 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="细说-Java-主流工具包"><a href="#细说-Java-主流工具包" class="headerlink" title="细说 Java 主流工具包"></a>细说 Java 主流工具包</h1><ul>
<li>apache.commons<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/apache/commons-lang">commons-lang</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/apache/commons-collections">commons-collections</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/apache/commons-io">common-io</a></li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://github.com/google/guava">guava</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://dunwu.github.io/blog/pages/cd38ec/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/uploads/avatar.gif">
      <meta itemprop="name" content="钝悟 ◾ Dunwu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dunwu Blog">
      <meta itemprop="description" content="钝悟的个人博客">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Dunwu Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/pages/cd38ec/" class="post-title-link" itemprop="url">JavaMail 快速入门</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-02-17 22:34:30" itemprop="dateCreated datePublished" datetime="2022-02-17T22:34:30+08:00">2022-02-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-01-27 23:32:48" itemprop="dateModified" datetime="2024-01-27T23:32:48+08:00">2024-01-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/%E5%B7%A5%E5%85%B7/" itemprop="url" rel="index"><span itemprop="name">工具</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/%E5%B7%A5%E5%85%B7/%E5%85%B6%E4%BB%96/" itemprop="url" rel="index"><span itemprop="name">其他</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>12k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>11 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="JavaMail-快速入门"><a href="#JavaMail-快速入门" class="headerlink" title="JavaMail 快速入门"></a>JavaMail 快速入门</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><h3 id="邮件相关的标准"><a href="#邮件相关的标准" class="headerlink" title="邮件相关的标准"></a>邮件相关的标准</h3><p>厂商所提供的 JavaMail 服务程序可以有选择地实现某些邮件协议，常见的邮件协议包括：</p>
<ul>
<li><code>SMTP(Simple Mail Transfer Protocol)</code> ：即简单邮件传输协议，它是一组用于由源地址到目的地址传送邮件的规则，由它来控制信件的中转方式。</li>
<li><code>POP3(Post Office Protocol - Version 3)</code> ：即邮局协议版本 3 ，用于接收电子邮件的标准协议。</li>
<li><code>IMAP(Internet Mail Access Protocol)</code> ：即 Internet 邮件访问协议。是 POP3 的替代协议。</li>
</ul>
<p>这三种协议都有对应 SSL 加密传输的协议，分别是 <strong>SMTPS</strong>， <strong>POP3S</strong>和 <strong>IMAPS</strong>。</p>
<p><code>MIME(Multipurpose Internet Mail Extensions)</code> ：即多用途因特网邮件扩展标准。它不是邮件传输协议。但对传输内容的消息、附件及其它的内容定义了格式。</p>
<h3 id="JavaMail-简介"><a href="#JavaMail-简介" class="headerlink" title="JavaMail 简介"></a>JavaMail 简介</h3><p>JavaMail 是由 Sun 发布的用来处理 email 的 API 。它并没有包含在 Java SE 中，而是作为 Java EE 的一部分。</p>
<ul>
<li><code>mail.jar</code> ：此 JAR 文件包含 JavaMail API 和 Sun 提供的 SMTP 、 IMAP 和 POP3 服务提供程序；</li>
<li><code>activation.jar</code> ：此 JAR 文件包含 JAF API 和 Sun 的实现。</li>
</ul>
<p>JavaMail 包中用于处理电子邮件的核心类是： <code>Properties</code> 、 <code>Session</code> 、 <code>Message</code> 、 <code>Address</code> 、 <code>Authenticator</code> 、 <code>Transport</code> 、 <code>Store</code> 等。</p>
<h3 id="邮件传输过程"><a href="#邮件传输过程" class="headerlink" title="邮件传输过程"></a>邮件传输过程</h3><p>如上图，电子邮件的处理步骤如下：</p>
<ol>
<li>创建一个 Session 对象。</li>
<li>Session 对象创建一个 Transport 对象 &#x2F;Store 对象，用来发送 &#x2F; 保存邮件。</li>
<li>Transport 对象 &#x2F;Store 对象连接邮件服务器。</li>
<li>Transport 对象 &#x2F;Store 对象创建一个 Message 对象 ( 也就是邮件内容 ) 。</li>
<li>Transport 对象发送邮件； Store 对象获取邮箱的邮件。</li>
</ol>
<h3 id="Message-结构"><a href="#Message-结构" class="headerlink" title="Message 结构"></a>Message 结构</h3><ul>
<li><code>MimeMessage</code> 类：代表整封邮件。</li>
<li><code>MimeBodyPart</code> 类：代表邮件的一个 MIME 信息。</li>
<li><code>MimeMultipart</code> 类：代表一个由多个 MIME 信息组合成的组合 MIME 信息。</li>
</ul>
<p><img src="http://upload-images.jianshu.io/upload_images/3101171-948230d2f5c7a620.png" alt="img"></p>
<h2 id="JavaMail-的核心类"><a href="#JavaMail-的核心类" class="headerlink" title="JavaMail 的核心类"></a>JavaMail 的核心类</h2><p>JavaMail 对收发邮件进行了高级的抽象，形成了一些关键的的接口和类，它们构成了程序的基础，下面我们分别来了解一下这些最常见的对象。</p>
<h3 id="java-util-Properties-类（属性对象）"><a href="#java-util-Properties-类（属性对象）" class="headerlink" title="java.util.Properties 类（属性对象）"></a>java.util.Properties 类（属性对象）</h3><p>java.util.Properties 类代表一组属性集合。</p>
<p>它的每一个键和值都是 String <strong>类型。</strong></p>
<p>由于 JavaMail 需要和邮件服务器进行通信，这就要求程序提供许多诸如服务器地址、端口、用户名、密码等信息， JavaMail 通过 Properties 对象封装这些属性信息。</p>
<p>例： 如下面的代码封装了几个属性信息：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Properties</span> <span class="variable">prop</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Properties</span>();</span><br><span class="line">prop.setProperty(<span class="string">&quot;mail.debug&quot;</span>, <span class="string">&quot;true&quot;</span>);</span><br><span class="line">prop.setProperty(<span class="string">&quot;mail.host&quot;</span>, <span class="string">&quot;[email protected]&quot;</span>);</span><br><span class="line">prop.setProperty(<span class="string">&quot;mail.transport.protocol&quot;</span>, <span class="string">&quot;smtp&quot;</span>);</span><br><span class="line">prop.setProperty(<span class="string">&quot;mail.smtp.auth&quot;</span>, <span class="string">&quot;true&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>针对不同的的邮件协议， JavaMail 规定了服务提供者必须支持一系列属性，</p>
<p>下表是一些常见属性（属性值都以 String 类型进行设置，属性类型栏仅表示属性是如何被解析的）：</p>
<table>
<thead>
<tr>
<th>关键词</th>
<th>类型</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>mail.debug</td>
<td>boolean</td>
<td>debug 开关。</td>
</tr>
<tr>
<td>mail.host</td>
<td>String</td>
<td>指定发送、接收邮件的默认邮箱服务器。</td>
</tr>
<tr>
<td>mail.store.protocol</td>
<td>String</td>
<td>指定接收邮件的协议。</td>
</tr>
<tr>
<td>mail.transport.protocol</td>
<td>String</td>
<td>指定发送邮件的协议。</td>
</tr>
<tr>
<td>mail.debug.auth</td>
<td>boolean</td>
<td>debug 输出中是否包含认证命令。默认是 false 。</td>
</tr>
</tbody></table>
<p>详情请参考官方 API 文档：</p>
<p><a target="_blank" rel="noopener" href="https://javamail.java.net/nonav/docs/api/">https://javamail.java.net/nonav/docs/api/</a> 。</p>
<h3 id="javax-mail-Session-类（会话对象）"><a href="#javax-mail-Session-类（会话对象）" class="headerlink" title="javax.mail.Session 类（会话对象）"></a>javax.mail.Session 类（会话对象）</h3><p><code>Session</code> 表示一个邮件会话。</p>
<p>Session 的主要作用包括两个方面：</p>
<ul>
<li>接收各种配置属性信息：通过 Properties 对象设置的属性信息；</li>
<li>初始化 JavaMail 环境：根据 JavaMail 的配置文件，初始化 JavaMail 环境，以便通过 Session 对象创建其他重要类的实例。</li>
</ul>
<p>JavaMail 在 Jar 包的 META-INF 目录下，通过以下文件提供了基本配置信息，以便 session 能够根据这个配置文件加载提供者的实现类：</p>
<ul>
<li>javamail.default.providers</li>
<li>javamail.default.address.map</li>
</ul>
<p><img src="http://upload-images.jianshu.io/upload_images/3101171-b59382c69385df45.png" alt="img"></p>
<p><strong>例：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Properties</span> <span class="variable">props</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Properties</span>();</span><br><span class="line">props.setProperty(<span class="string">&quot;mail.transport.protocol&quot;</span>, <span class="string">&quot;smtp&quot;</span>);</span><br><span class="line"><span class="type">Session</span> <span class="variable">session</span> <span class="operator">=</span> Session.getInstance(props);</span><br></pre></td></tr></table></figure>

<h3 id="javax-mail-Transport-类（邮件传输）"><a href="#javax-mail-Transport-类（邮件传输）" class="headerlink" title="javax.mail.Transport 类（邮件传输）"></a>javax.mail.Transport 类（邮件传输）</h3><p>邮件操作只有发送或接收两种处理方式。</p>
<p>JavaMail 将这两种不同操作描述为传输（ javax.mail.Transport ）和存储（ javax.mail.Store ），传输对应邮件的发送，而存储对应邮件的接收。</p>
<ul>
<li><code>getTransport</code> - Session 类中的 **getTransport()**有多个重载方法，可以用来创建 Transport 对象。</li>
<li><code>connect</code> - 如果设置了认证命令—— mail.smtp.auth ，那么使用 Transport 类的 connect 方法连接服务器时，则必须加上用户名和密码。</li>
<li><code>sendMessage</code> - Transport 类的 sendMessage 方法用来发送邮件消息。</li>
<li><code>close</code> - Transport 类的 close 方法用来关闭和邮件服务器的连接。</li>
</ul>
<h3 id="javax-mail-Store-类（邮件存储-）"><a href="#javax-mail-Store-类（邮件存储-）" class="headerlink" title="javax.mail.Store 类（邮件存储 ）"></a>javax.mail.Store 类（邮件存储 ）</h3><ul>
<li><code>getStore</code> - Session 类中的 getStore () 有多个重载方法，可以用来创建 Store 对象。</li>
<li><code>connect</code> - 如果设置了认证命令—— mail.smtp.auth ，那么使用 Store 类的 connect 方法连接服务器时，则必须加上用户名和密码。</li>
<li><code>getFolder</code> - Store 类的 getFolder 方法可以 获取邮箱内的邮件夹 Folder 对象</li>
<li><code>close</code> - Store 类的 close 方法用来关闭和邮件服务器的连接。</li>
</ul>
<h3 id="javax-mail-Message-类（消息对象）"><a href="#javax-mail-Message-类（消息对象）" class="headerlink" title="javax.mail.Message 类（消息对象）"></a>javax.mail.Message 类（消息对象）</h3><ul>
<li><code>javax.mail.Message</code> - 是个抽象类，只能用子类去实例化，多数情况下为 <code>javax.mail.internet.MimeMessage</code>。</li>
<li><code>MimeMessage</code> - 代表 MIME 类型的电子邮件消息。</li>
</ul>
<p>要创建一个 Message ，需要将 Session 对象传递给 <code>MimeMessage</code> 构造器：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">MimeMessage</span> <span class="variable">message</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MimeMessage</span>(session);</span><br></pre></td></tr></table></figure>

<p>注意：还存在其它构造器，如用按 RFC822 格式的输入流来创建消息。</p>
<ul>
<li>setFrom - 设置邮件的发件人</li>
<li>setRecipient - 设置邮件的发送人、抄送人、密送人</li>
</ul>
<p>三种预定义的地址类型是：</p>
<ul>
<li><code>Message.RecipientType.TO</code> - 收件人</li>
<li><code>Message.RecipientType.CC</code> - 抄送人</li>
<li><code>Message.RecipientType.BCC</code> - 密送人</li>
<li><code>setSubject</code> - 设置邮件的主题</li>
<li><code>setContent</code> - 设置邮件内容</li>
<li><code>setText</code> - 如果邮件内容是纯文本，可以使用此接口设置文本内容。</li>
</ul>
<h3 id="javax-mail-Address-类（地址）"><a href="#javax-mail-Address-类（地址）" class="headerlink" title="javax.mail.Address 类（地址）"></a>javax.mail.Address 类（地址）</h3><p>一旦您创建了 Session 和 Message ，并将内容填入消息后，就可以用 Address 确定信件地址了。和 Message 一样， Address 也是个抽象类。您用的是 javax.mail.internet.InternetAddress 类。</p>
<p>若创建的地址只包含电子邮件地址，只要传递电子邮件地址到构造器就行了。</p>
<p><strong>例：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Address</span> <span class="variable">address</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InternetAddress</span>(<span class="string">&quot;[email protected]&quot;</span>);</span><br></pre></td></tr></table></figure>

<h3 id="Authenticator-类（认证者）"><a href="#Authenticator-类（认证者）" class="headerlink" title="Authenticator 类（认证者）"></a>Authenticator 类（认证者）</h3><p>与 java.net 类一样， JavaMail API 也可以利用 <code>Authenticator</code> 通过用户名和密码访问受保护的资源。对于 JavaMail API 来说，这些资源就是邮件服务器。<code>Authenticator</code> 在 javax.mail 包中，而且它和 java.net 中同名的类 Authenticator 不同。两者并不共享同一个 Authenticator ，因为 JavaMail API 用于 Java 1.1 ，它没有 java.net 类别。</p>
<p>要使用 Authenticator ，先创建一个抽象类的子类，并从 <code>getPasswordAuthentication()</code> 方法中返回 <code>PasswordAuthentication</code> 实例。创建完成后，您必需向 session 注册 <code>Authenticator</code> 。然后，在需要认证的时候，就会通知 <code>Authenticator</code> 。您可以弹出窗口，也可以从配置文件中（虽然没有加密是不安全的）读取用户名和密码，将它们作为 <code>PasswordAuthentication</code> 对象返回给调用程序。</p>
<p><strong>例：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Properties</span> <span class="variable">props</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Properties</span>();</span><br><span class="line"><span class="type">Authenticator</span> <span class="variable">auth</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyAuthenticator</span>();</span><br><span class="line"><span class="type">Session</span> <span class="variable">session</span> <span class="operator">=</span> Session.getDefaultInstance(props, auth);</span><br></pre></td></tr></table></figure>

<h2 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h2><h3 id="发送文本邮件"><a href="#发送文本邮件" class="headerlink" title="发送文本邮件"></a>发送文本邮件</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">Properties</span> <span class="variable">prop</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Properties</span>();</span><br><span class="line">    prop.setProperty(<span class="string">&quot;mail.debug&quot;</span>, <span class="string">&quot;true&quot;</span>);</span><br><span class="line">    prop.setProperty(<span class="string">&quot;mail.host&quot;</span>, MAIL_SERVER_HOST);</span><br><span class="line">    prop.setProperty(<span class="string">&quot;mail.transport.protocol&quot;</span>, <span class="string">&quot;smtp&quot;</span>);</span><br><span class="line">    prop.setProperty(<span class="string">&quot;mail.smtp.auth&quot;</span>, <span class="string">&quot;true&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1、创建session</span></span><br><span class="line">    <span class="type">Session</span> <span class="variable">session</span> <span class="operator">=</span> Session.getInstance(prop);</span><br><span class="line">    <span class="type">Transport</span> <span class="variable">ts</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2、通过session得到transport对象</span></span><br><span class="line">    ts = session.getTransport();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3、连上邮件服务器</span></span><br><span class="line">    ts.connect(MAIL_SERVER_HOST, USER, PASSWORD);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4、创建邮件</span></span><br><span class="line">    <span class="type">MimeMessage</span> <span class="variable">message</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MimeMessage</span>(session);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 邮件消息头</span></span><br><span class="line">    message.setFrom(<span class="keyword">new</span> <span class="title class_">InternetAddress</span>(MAIL_FROM)); <span class="comment">// 邮件的发件人</span></span><br><span class="line">    message.setRecipient(Message.RecipientType.TO, <span class="keyword">new</span> <span class="title class_">InternetAddress</span>(MAIL_TO)); <span class="comment">// 邮件的收件人</span></span><br><span class="line">    message.setRecipient(Message.RecipientType.CC, <span class="keyword">new</span> <span class="title class_">InternetAddress</span>(MAIL_CC)); <span class="comment">// 邮件的抄送人</span></span><br><span class="line">    message.setRecipient(Message.RecipientType.BCC, <span class="keyword">new</span> <span class="title class_">InternetAddress</span>(MAIL_BCC)); <span class="comment">// 邮件的密送人</span></span><br><span class="line">    message.setSubject(<span class="string">&quot;测试文本邮件&quot;</span>); <span class="comment">// 邮件的标题</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 邮件消息体</span></span><br><span class="line">    message.setText(<span class="string">&quot;天下无双。&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 5、发送邮件</span></span><br><span class="line">    ts.sendMessage(message, message.getAllRecipients());</span><br><span class="line">    ts.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="发送-HTML-格式的邮件"><a href="#发送-HTML-格式的邮件" class="headerlink" title="发送 HTML 格式的邮件"></a>发送 HTML 格式的邮件</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">Properties</span> <span class="variable">prop</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Properties</span>();</span><br><span class="line">    prop.setProperty(<span class="string">&quot;mail.debug&quot;</span>, <span class="string">&quot;true&quot;</span>);</span><br><span class="line">    prop.setProperty(<span class="string">&quot;mail.host&quot;</span>, MAIL_SERVER_HOST);</span><br><span class="line">    prop.setProperty(<span class="string">&quot;mail.transport.protocol&quot;</span>, <span class="string">&quot;smtp&quot;</span>);</span><br><span class="line">    prop.setProperty(<span class="string">&quot;mail.smtp.auth&quot;</span>, <span class="string">&quot;true&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1、创建session</span></span><br><span class="line">    <span class="type">Session</span> <span class="variable">session</span> <span class="operator">=</span> Session.getInstance(prop);</span><br><span class="line">    <span class="type">Transport</span> <span class="variable">ts</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2、通过session得到transport对象</span></span><br><span class="line">    ts = session.getTransport();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3、连上邮件服务器</span></span><br><span class="line">    ts.connect(MAIL_SERVER_HOST, USER, PASSWORD);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4、创建邮件</span></span><br><span class="line">    <span class="type">MimeMessage</span> <span class="variable">message</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MimeMessage</span>(session);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 邮件消息头</span></span><br><span class="line">    message.setFrom(<span class="keyword">new</span> <span class="title class_">InternetAddress</span>(MAIL_FROM)); <span class="comment">// 邮件的发件人</span></span><br><span class="line">    message.setRecipient(Message.RecipientType.TO, <span class="keyword">new</span> <span class="title class_">InternetAddress</span>(MAIL_TO)); <span class="comment">// 邮件的收件人</span></span><br><span class="line">    message.setRecipient(Message.RecipientType.CC, <span class="keyword">new</span> <span class="title class_">InternetAddress</span>(MAIL_CC)); <span class="comment">// 邮件的抄送人</span></span><br><span class="line">    message.setRecipient(Message.RecipientType.BCC, <span class="keyword">new</span> <span class="title class_">InternetAddress</span>(MAIL_BCC)); <span class="comment">// 邮件的密送人</span></span><br><span class="line">    message.setSubject(<span class="string">&quot;测试HTML邮件&quot;</span>); <span class="comment">// 邮件的标题</span></span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">htmlContent</span> <span class="operator">=</span> <span class="string">&quot;&lt;h1&gt;Hello&lt;/h1&gt;&quot;</span> + <span class="string">&quot;&lt;p&gt;显示图片&lt;img src=&#x27;cid:abc.jpg&#x27;&gt;1.jpg&lt;/p&gt;&quot;</span>;</span><br><span class="line">    <span class="type">MimeBodyPart</span> <span class="variable">text</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MimeBodyPart</span>();</span><br><span class="line">    text.setContent(htmlContent, <span class="string">&quot;text/html;charset=UTF-8&quot;</span>);</span><br><span class="line">    <span class="type">MimeBodyPart</span> <span class="variable">image</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MimeBodyPart</span>();</span><br><span class="line">    <span class="type">DataHandler</span> <span class="variable">dh</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DataHandler</span>(<span class="keyword">new</span> <span class="title class_">FileDataSource</span>(<span class="string">&quot;D:\\05_Datas\\图库\\吉他少年背影.png&quot;</span>));</span><br><span class="line">    image.setDataHandler(dh);</span><br><span class="line">    image.setContentID(<span class="string">&quot;abc.jpg&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 描述数据关系</span></span><br><span class="line">    <span class="type">MimeMultipart</span> <span class="variable">mm</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MimeMultipart</span>();</span><br><span class="line">    mm.addBodyPart(text);</span><br><span class="line">    mm.addBodyPart(image);</span><br><span class="line">    mm.setSubType(<span class="string">&quot;related&quot;</span>);</span><br><span class="line">    message.setContent(mm);</span><br><span class="line">    message.saveChanges();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 5、发送邮件</span></span><br><span class="line">    ts.sendMessage(message, message.getAllRecipients());</span><br><span class="line">    ts.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="发送带附件的邮件"><a href="#发送带附件的邮件" class="headerlink" title="发送带附件的邮件"></a>发送带附件的邮件</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">Properties</span> <span class="variable">prop</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Properties</span>();</span><br><span class="line">    prop.setProperty(<span class="string">&quot;mail.debug&quot;</span>, <span class="string">&quot;true&quot;</span>);</span><br><span class="line">    prop.setProperty(<span class="string">&quot;mail.host&quot;</span>, MAIL_SERVER_HOST);</span><br><span class="line">    prop.setProperty(<span class="string">&quot;mail.transport.protocol&quot;</span>, <span class="string">&quot;smtp&quot;</span>);</span><br><span class="line">    prop.setProperty(<span class="string">&quot;mail.smtp.auth&quot;</span>, <span class="string">&quot;true&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1、创建session</span></span><br><span class="line">    <span class="type">Session</span> <span class="variable">session</span> <span class="operator">=</span> Session.getInstance(prop);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2、通过session得到transport对象</span></span><br><span class="line">    <span class="type">Transport</span> <span class="variable">ts</span> <span class="operator">=</span> session.getTransport();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3、连上邮件服务器</span></span><br><span class="line">    ts.connect(MAIL_SERVER_HOST, USER, PASSWORD);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4、创建邮件</span></span><br><span class="line">    <span class="type">MimeMessage</span> <span class="variable">message</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MimeMessage</span>(session);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 邮件消息头</span></span><br><span class="line">    message.setFrom(<span class="keyword">new</span> <span class="title class_">InternetAddress</span>(MAIL_FROM)); <span class="comment">// 邮件的发件人</span></span><br><span class="line">    message.setRecipient(Message.RecipientType.TO, <span class="keyword">new</span> <span class="title class_">InternetAddress</span>(MAIL_TO)); <span class="comment">// 邮件的收件人</span></span><br><span class="line">    message.setRecipient(Message.RecipientType.CC, <span class="keyword">new</span> <span class="title class_">InternetAddress</span>(MAIL_CC)); <span class="comment">// 邮件的抄送人</span></span><br><span class="line">    message.setRecipient(Message.RecipientType.BCC, <span class="keyword">new</span> <span class="title class_">InternetAddress</span>(MAIL_BCC)); <span class="comment">// 邮件的密送人</span></span><br><span class="line">    message.setSubject(<span class="string">&quot;测试带附件邮件&quot;</span>); <span class="comment">// 邮件的标题</span></span><br><span class="line"></span><br><span class="line">    <span class="type">MimeBodyPart</span> <span class="variable">text</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MimeBodyPart</span>();</span><br><span class="line">    text.setContent(<span class="string">&quot;邮件中有两个附件。&quot;</span>, <span class="string">&quot;text/html;charset=UTF-8&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 描述数据关系</span></span><br><span class="line">    <span class="type">MimeMultipart</span> <span class="variable">mm</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MimeMultipart</span>();</span><br><span class="line">    mm.setSubType(<span class="string">&quot;related&quot;</span>);</span><br><span class="line">    mm.addBodyPart(text);</span><br><span class="line">    String[] files = &#123;</span><br><span class="line">            <span class="string">&quot;D:\\00_Temp\\temp\\1.jpg&quot;</span>, <span class="string">&quot;D:\\00_Temp\\temp\\2.png&quot;</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 添加邮件附件</span></span><br><span class="line">    <span class="keyword">for</span> (String filename : files) &#123;</span><br><span class="line">        <span class="type">MimeBodyPart</span> <span class="variable">attachPart</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MimeBodyPart</span>();</span><br><span class="line">        attachPart.attachFile(filename);</span><br><span class="line">        mm.addBodyPart(attachPart);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    message.setContent(mm);</span><br><span class="line">    message.saveChanges();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 5、发送邮件</span></span><br><span class="line">    ts.sendMessage(message, message.getAllRecipients());</span><br><span class="line">    ts.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="获取邮箱中的邮件"><a href="#获取邮箱中的邮件" class="headerlink" title="获取邮箱中的邮件"></a>获取邮箱中的邮件</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建一个有具体连接信息的Properties对象</span></span><br><span class="line">    <span class="type">Properties</span> <span class="variable">prop</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Properties</span>();</span><br><span class="line">    prop.setProperty(<span class="string">&quot;mail.debug&quot;</span>, <span class="string">&quot;true&quot;</span>);</span><br><span class="line">    prop.setProperty(<span class="string">&quot;mail.store.protocol&quot;</span>, <span class="string">&quot;pop3&quot;</span>);</span><br><span class="line">    prop.setProperty(<span class="string">&quot;mail.pop3.host&quot;</span>, MAIL_SERVER_HOST);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1、创建session</span></span><br><span class="line">    <span class="type">Session</span> <span class="variable">session</span> <span class="operator">=</span> Session.getInstance(prop);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2、通过session得到Store对象</span></span><br><span class="line">    <span class="type">Store</span> <span class="variable">store</span> <span class="operator">=</span> session.getStore();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3、连上邮件服务器</span></span><br><span class="line">    store.connect(MAIL_SERVER_HOST, USER, PASSWORD);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4、获得邮箱内的邮件夹</span></span><br><span class="line">    <span class="type">Folder</span> <span class="variable">folder</span> <span class="operator">=</span> store.getFolder(<span class="string">&quot;inbox&quot;</span>);</span><br><span class="line">    folder.open(Folder.READ_ONLY);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获得邮件夹Folder内的所有邮件Message对象</span></span><br><span class="line">    Message[] messages = folder.getMessages();</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; messages.length; i++) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">subject</span> <span class="operator">=</span> messages[i].getSubject();</span><br><span class="line">        <span class="type">String</span> <span class="variable">from</span> <span class="operator">=</span> (messages[i].getFrom()[<span class="number">0</span>]).toString();</span><br><span class="line">        System.out.println(<span class="string">&quot;第 &quot;</span> + (i + <span class="number">1</span>) + <span class="string">&quot;封邮件的主题：&quot;</span> + subject);</span><br><span class="line">        System.out.println(<span class="string">&quot;第 &quot;</span> + (i + <span class="number">1</span>) + <span class="string">&quot;封邮件的发件人地址：&quot;</span> + from);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 5、关闭</span></span><br><span class="line">    folder.close(<span class="literal">false</span>);</span><br><span class="line">    store.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="转发邮件"><a href="#转发邮件" class="headerlink" title="转发邮件"></a>转发邮件</h3><p>例：获取指定邮件夹下的第一封邮件并转发</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">Properties</span> <span class="variable">prop</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Properties</span>();</span><br><span class="line">    prop.put(<span class="string">&quot;mail.store.protocol&quot;</span>, <span class="string">&quot;pop3&quot;</span>);</span><br><span class="line">    prop.put(<span class="string">&quot;mail.pop3.host&quot;</span>, MAIL_SERVER_POP3);</span><br><span class="line">    prop.put(<span class="string">&quot;mail.pop3.starttls.enable&quot;</span>, <span class="string">&quot;true&quot;</span>);</span><br><span class="line">    prop.put(<span class="string">&quot;mail.smtp.auth&quot;</span>, <span class="string">&quot;true&quot;</span>);</span><br><span class="line">    prop.put(<span class="string">&quot;mail.smtp.host&quot;</span>, MAIL_SERVER_SMTP);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1、创建session</span></span><br><span class="line">    <span class="type">Session</span> <span class="variable">session</span> <span class="operator">=</span> Session.getDefaultInstance(prop);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2、读取邮件夹</span></span><br><span class="line">    <span class="type">Store</span> <span class="variable">store</span> <span class="operator">=</span> session.getStore(<span class="string">&quot;pop3&quot;</span>);</span><br><span class="line">    store.connect(MAIL_SERVER_POP3, USER, PASSWORD);</span><br><span class="line">    <span class="type">Folder</span> <span class="variable">folder</span> <span class="operator">=</span> store.getFolder(<span class="string">&quot;inbox&quot;</span>);</span><br><span class="line">    folder.open(Folder.READ_ONLY);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取邮件夹中第1封邮件信息</span></span><br><span class="line">    Message[] messages = folder.getMessages();</span><br><span class="line">    <span class="keyword">if</span> (messages.length &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">Message</span> <span class="variable">message</span> <span class="operator">=</span> messages[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 打印邮件关键信息</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">from</span> <span class="operator">=</span> InternetAddress.toString(message.getFrom());</span><br><span class="line">    <span class="keyword">if</span> (from != <span class="literal">null</span>) &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;From: &quot;</span> + from);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">replyTo</span> <span class="operator">=</span> InternetAddress.toString(message.getReplyTo());</span><br><span class="line">    <span class="keyword">if</span> (replyTo != <span class="literal">null</span>) &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Reply-to: &quot;</span> + replyTo);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">to</span> <span class="operator">=</span> InternetAddress.toString(message.getRecipients(Message.RecipientType.TO));</span><br><span class="line">    <span class="keyword">if</span> (to != <span class="literal">null</span>) &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;To: &quot;</span> + to);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">subject</span> <span class="operator">=</span> message.getSubject();</span><br><span class="line">    <span class="keyword">if</span> (subject != <span class="literal">null</span>) &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Subject: &quot;</span> + subject);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">Date</span> <span class="variable">sent</span> <span class="operator">=</span> message.getSentDate();</span><br><span class="line">    <span class="keyword">if</span> (sent != <span class="literal">null</span>) &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Sent: &quot;</span> + sent);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置转发邮件信息头</span></span><br><span class="line">    <span class="type">Message</span> <span class="variable">forward</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MimeMessage</span>(session);</span><br><span class="line">    forward.setFrom(<span class="keyword">new</span> <span class="title class_">InternetAddress</span>(MAIL_FROM));</span><br><span class="line">    forward.setRecipient(Message.RecipientType.TO, <span class="keyword">new</span> <span class="title class_">InternetAddress</span>(MAIL_TO));</span><br><span class="line">    forward.setSubject(<span class="string">&quot;Fwd: &quot;</span> + message.getSubject());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置转发邮件内容</span></span><br><span class="line">    <span class="type">MimeBodyPart</span> <span class="variable">bodyPart</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MimeBodyPart</span>();</span><br><span class="line">    bodyPart.setContent(message, <span class="string">&quot;message/rfc822&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">Multipart</span> <span class="variable">multipart</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MimeMultipart</span>();</span><br><span class="line">    multipart.addBodyPart(bodyPart);</span><br><span class="line">    forward.setContent(multipart);</span><br><span class="line">    forward.saveChanges();</span><br><span class="line"></span><br><span class="line">    <span class="type">Transport</span> <span class="variable">ts</span> <span class="operator">=</span> session.getTransport(<span class="string">&quot;smtp&quot;</span>);</span><br><span class="line">    ts.connect(USER, PASSWORD);</span><br><span class="line">    ts.sendMessage(forward, forward.getAllRecipients());</span><br><span class="line"></span><br><span class="line">    folder.close(<span class="literal">false</span>);</span><br><span class="line">    store.close();</span><br><span class="line">    ts.close();</span><br><span class="line">    System.out.println(<span class="string">&quot;message forwarded successfully....&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://dunwu.github.io/blog/pages/5dd78d/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/uploads/avatar.gif">
      <meta itemprop="name" content="钝悟 ◾ Dunwu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dunwu Blog">
      <meta itemprop="description" content="钝悟的个人博客">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Dunwu Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/pages/5dd78d/" class="post-title-link" itemprop="url">Jsoup 快速入门</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-02-17 22:34:30" itemprop="dateCreated datePublished" datetime="2022-02-17T22:34:30+08:00">2022-02-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-01-27 23:32:48" itemprop="dateModified" datetime="2024-01-27T23:32:48+08:00">2024-01-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/%E5%B7%A5%E5%85%B7/" itemprop="url" rel="index"><span itemprop="name">工具</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/%E5%B7%A5%E5%85%B7/%E5%85%B6%E4%BB%96/" itemprop="url" rel="index"><span itemprop="name">其他</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>11k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>10 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Jsoup-快速入门"><a href="#Jsoup-快速入门" class="headerlink" title="Jsoup 快速入门"></a>Jsoup 快速入门</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>jsoup 是一款 Java 的 HTML 解析器，可直接解析某个 URL 地址、HTML 文本内容。它提供了一套非常省力的 API，可通过 DOM，CSS 以及类似于 JQuery 的操作方法来取出和操作数据。</p>
<p>jsoup 工作的流程主要如下：</p>
<ol>
<li>从一个 URL，文件或字符串中解析 HTML，并加载为一个 <code>Document</code> 对象。</li>
<li>使用 DOM 或 CSS 选择器来取出数据；</li>
<li>可操作 HTML 元素、属性、文本。</li>
</ol>
<p>jsoup 是基于 MIT 协议发布的，可放心使用于商业项目。</p>
<h2 id="加载"><a href="#加载" class="headerlink" title="加载"></a>加载</h2><h3 id="从-HTML-字符串加载一个文档"><a href="#从-HTML-字符串加载一个文档" class="headerlink" title="从 HTML 字符串加载一个文档"></a>从 HTML 字符串加载一个文档</h3><p>使用静态 <code>Jsoup.parse(String html)</code> 方法或 <code>Jsoup.parse(String html, String baseUri)</code> 示例代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">html</span> <span class="operator">=</span> <span class="string">&quot;&lt;html&gt;&lt;head&gt;&lt;title&gt;First parse&lt;/title&gt;&lt;/head&gt;&quot;</span></span><br><span class="line">  + <span class="string">&quot;&lt;body&gt;&lt;p&gt;Parsed HTML into a doc.&lt;/p&gt;&lt;/body&gt;&lt;/html&gt;&quot;</span>;</span><br><span class="line"><span class="type">Document</span> <span class="variable">doc</span> <span class="operator">=</span> Jsoup.parse(html);</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>说明</strong></p>
<p><code>parse(String html, String baseUri)</code> 这方法能够将输入的 HTML 解析为一个新的文档 (Document），参数 baseUri 是用来将相对 URL 转成绝对 URL，并指定从哪个网站获取文档。如这个方法不适用，你可以使用 <code>parse(String html)</code> 方法来解析成 HTML 字符串如上面的示例。</p>
<p>只要解析的不是空字符串，就能返回一个结构合理的文档，其中包含(至少) 一个 head 和一个 body 元素。</p>
<p>一旦拥有了一个 Document，你就可以使用 Document 中适当的方法或它父类 <code>Element</code>和<code>Node</code>中的方法来取得相关数据。</p>
</blockquote>
<h3 id="解析一个-body-片断"><a href="#解析一个-body-片断" class="headerlink" title="解析一个 body 片断"></a>解析一个 body 片断</h3><p><strong>问题</strong></p>
<p>假如你有一个 HTML 片断 (比如. 一个 <code>div</code> 包含一对 <code>p</code> 标签; 一个不完整的 HTML 文档) 想对它进行解析。这个 HTML 片断可以是用户提交的一条评论或在一个 CMS 页面中编辑 body 部分。</p>
<p><strong>办法</strong></p>
<p>使用<code>Jsoup.parseBodyFragment(String html)</code>方法.</p>
<figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">String html <span class="operator">=</span> <span class="string">&quot;&lt;div&gt;&lt;p&gt;Lorem ipsum.&lt;/p&gt;&quot;</span><span class="comment">;</span></span><br><span class="line">Document doc <span class="operator">=</span> Jsoup.parseBodyFragment(html)<span class="comment">;</span></span><br><span class="line">Element body <span class="operator">=</span> doc.body()<span class="comment">;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>说明</strong></p>
<p><code>parseBodyFragment</code> 方法创建一个空壳的文档，并插入解析过的 HTML 到<code>body</code>元素中。假如你使用正常的 <code>Jsoup.parse(String html)</code> 方法，通常你也可以得到相同的结果，但是明确将用户输入作为 body 片段处理，以确保用户所提供的任何糟糕的 HTML 都将被解析成 body 元素。</p>
<p><code>Document.body()</code> 方法能够取得文档 body 元素的所有子元素，与 <code>doc.getElementsByTag(&quot;body&quot;)</code>相同。</p>
</blockquote>
<h4 id="保证安全-Stay-safe"><a href="#保证安全-Stay-safe" class="headerlink" title="保证安全 Stay safe"></a>保证安全 Stay safe</h4><p>假如你可以让用户输入 HTML 内容，那么要小心避免跨站脚本攻击。利用基于 <code>Whitelist</code> 的清除器和 <code>clean(String bodyHtml, Whitelist whitelist)</code>方法来清除用户输入的恶意内容。</p>
<h3 id="从-URL-加载一个文档"><a href="#从-URL-加载一个文档" class="headerlink" title="从 URL 加载一个文档"></a>从 URL 加载一个文档</h3><p>使用 <code>Jsoup.connect(String url)</code>方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Document</span> <span class="variable">doc</span> <span class="operator">=</span> Jsoup.connect(<span class="string">&quot;http://example.com/&quot;</span>).get();</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>说明</strong></p>
<p><code>connect(String url)</code> 方法创建一个新的 <code>Connection</code>, 和 <code>get()</code> 取得和解析一个 HTML 文件。如果从该 URL 获取 HTML 时发生错误，便会抛出 IOException，应适当处理。</p>
</blockquote>
<p><code>Connection</code> 接口还提供一个方法链来解决特殊请求，具体如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Document</span> <span class="variable">doc</span> <span class="operator">=</span> Jsoup.connect(<span class="string">&quot;http://example.com&quot;</span>)</span><br><span class="line">  .data(<span class="string">&quot;query&quot;</span>, <span class="string">&quot;Java&quot;</span>)</span><br><span class="line">  .userAgent(<span class="string">&quot;Mozilla&quot;</span>)</span><br><span class="line">  .cookie(<span class="string">&quot;auth&quot;</span>, <span class="string">&quot;token&quot;</span>)</span><br><span class="line">  .timeout(<span class="number">3000</span>)</span><br><span class="line">  .post();</span><br></pre></td></tr></table></figure>

<h3 id="从一个文件加载一个文档"><a href="#从一个文件加载一个文档" class="headerlink" title="从一个文件加载一个文档"></a>从一个文件加载一个文档</h3><p>可以使用静态 <code>Jsoup.parse(File in, String charsetName, String baseUri)</code> 方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">File</span> <span class="variable">input</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;/tmp/input.html&quot;</span>);</span><br><span class="line"><span class="type">Document</span> <span class="variable">doc</span> <span class="operator">=</span> Jsoup.parse(input, <span class="string">&quot;UTF-8&quot;</span>, <span class="string">&quot;http://example.com/&quot;</span>);</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>说明</strong></p>
<p><code>parse(File in, String charsetName, String baseUri)</code> 这个方法用来加载和解析一个 HTML 文件。如在加载文件的时候发生错误，将抛出 IOException，应作适当处理。</p>
<p><code>baseUri</code> 参数用于解决文件中 URLs 是相对路径的问题。如果不需要可以传入一个空的字符串。</p>
<p>另外还有一个方法<code>parse(File in, String charsetName)</code> ，它使用文件的路径做为 <code>baseUri</code>。 这个方法适用于如果被解析文件位于网站的本地文件系统，且相关链接也指向该文件系统。</p>
</blockquote>
<h2 id="解析"><a href="#解析" class="headerlink" title="解析"></a>解析</h2><h3 id="使用-DOM-方法来遍历一个文档"><a href="#使用-DOM-方法来遍历一个文档" class="headerlink" title="使用 DOM 方法来遍历一个文档"></a>使用 DOM 方法来遍历一个文档</h3><p><strong>问题</strong></p>
<p>你有一个 HTML 文档要从中提取数据，并了解这个 HTML 文档的结构。</p>
<p><strong>方法</strong></p>
<p>将 HTML 解析成一个<code>Document</code>之后，就可以使用类似于 DOM 的方法进行操作。示例代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">File</span> <span class="variable">input</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;/tmp/input.html&quot;</span>);</span><br><span class="line"><span class="type">Document</span> <span class="variable">doc</span> <span class="operator">=</span> Jsoup.parse(input, <span class="string">&quot;UTF-8&quot;</span>, <span class="string">&quot;http://example.com/&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">Element</span> <span class="variable">content</span> <span class="operator">=</span> doc.getElementById(<span class="string">&quot;content&quot;</span>);</span><br><span class="line"><span class="type">Elements</span> <span class="variable">links</span> <span class="operator">=</span> content.getElementsByTag(<span class="string">&quot;a&quot;</span>);</span><br><span class="line"><span class="keyword">for</span> (Element link : links) &#123;</span><br><span class="line">  <span class="type">String</span> <span class="variable">linkHref</span> <span class="operator">=</span> link.attr(<span class="string">&quot;href&quot;</span>);</span><br><span class="line">  <span class="type">String</span> <span class="variable">linkText</span> <span class="operator">=</span> link.text();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>说明</strong></p>
<p><code>Elements</code> 这个对象提供了一系列类似于 DOM 的方法来查找元素，抽取并处理其中的数据。</p>
<p>具体如下：</p>
<h4 id="查找元素"><a href="#查找元素" class="headerlink" title="查找元素"></a>查找元素</h4><ul>
<li><code>getElementById(String id)</code></li>
<li><code>getElementsByTag(String tag)</code></li>
<li><code>getElementsByClass(String className)</code></li>
<li><code>getElementsByAttribute(String key)</code> (and related methods)</li>
<li>Element siblings: <code>siblingElements()</code>, <code>firstElementSibling()</code>, <code>lastElementSibling()</code>;<code>nextElementSibling()</code>, <code>previousElementSibling()</code></li>
<li>Graph: <code>parent()</code>, <code>children()</code>, <code>child(int index)</code></li>
</ul>
<h4 id="元素数据"><a href="#元素数据" class="headerlink" title="元素数据"></a>元素数据</h4><ul>
<li><code>attr(String key)</code>获取属性<code>attr(String key, String value)</code>设置属性</li>
<li><code>attributes()</code>获取所有属性</li>
<li><code>id()</code>, <code>className()</code> and <code>classNames()</code></li>
<li><code>text()</code>获取文本内容<code>text(String value)</code> 设置文本内容</li>
<li><code>html()</code>获取元素内 HTML<code>html(String value)</code>设置元素内的 HTML 内容</li>
<li><code>outerHtml()</code>获取元素外 HTML 内容</li>
<li><code>data()</code>获取数据内容（例如：script 和 style 标签)</li>
<li><code>tag()</code> and <code>tagName()</code></li>
</ul>
<h4 id="操作-HTML-和文本"><a href="#操作-HTML-和文本" class="headerlink" title="操作 HTML 和文本"></a>操作 HTML 和文本</h4><ul>
<li><code>append(String html)</code>, <code>prepend(String html)</code></li>
<li><code>appendText(String text)</code>, <code>prependText(String text)</code></li>
<li><code>appendElement(String tagName)</code>, <code>prependElement(String tagName)</code></li>
<li><code>html(String value)</code></li>
</ul>
<h3 id="使用选择器语法来查找元素"><a href="#使用选择器语法来查找元素" class="headerlink" title="使用选择器语法来查找元素"></a>使用选择器语法来查找元素</h3><p><strong>问题</strong></p>
<p>你想使用类似于 CSS 或 jQuery 的语法来查找和操作元素。</p>
<p><strong>方法</strong></p>
<p>可以使用<code>Element.select(String selector)</code> 和 <code>Elements.select(String selector)</code> 方法实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">File</span> <span class="variable">input</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;/tmp/input.html&quot;</span>);</span><br><span class="line"><span class="type">Document</span> <span class="variable">doc</span> <span class="operator">=</span> Jsoup.parse(input, <span class="string">&quot;UTF-8&quot;</span>, <span class="string">&quot;http://example.com/&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">Elements</span> <span class="variable">links</span> <span class="operator">=</span> doc.select(<span class="string">&quot;a[href]&quot;</span>); <span class="comment">//带有href属性的a元素</span></span><br><span class="line"><span class="type">Elements</span> <span class="variable">pngs</span> <span class="operator">=</span> doc.select(<span class="string">&quot;img[src$=.png]&quot;</span>);</span><br><span class="line">  <span class="comment">//扩展名为.png的图片</span></span><br><span class="line"></span><br><span class="line"><span class="type">Element</span> <span class="variable">masthead</span> <span class="operator">=</span> doc.select(<span class="string">&quot;div.masthead&quot;</span>).first();</span><br><span class="line">  <span class="comment">//class等于masthead的div标签</span></span><br><span class="line"></span><br><span class="line"><span class="type">Elements</span> <span class="variable">resultLinks</span> <span class="operator">=</span> doc.select(<span class="string">&quot;h3.r &gt; a&quot;</span>); <span class="comment">//在h3元素之后的a元素</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>说明</strong></p>
<p>jsoup elements 对象支持类似于<a target="_blank" rel="noopener" href="http://www.w3.org/TR/2009/PR-css3-selectors-20091215/">CSS</a> (或<a target="_blank" rel="noopener" href="http://jquery.com/">jquery</a>)的选择器语法，来实现非常强大和灵活的查找功能。.</p>
<p>这个<code>select</code> 方法在<code>Document</code>, <code>Element</code>,或<code>Elements</code>对象中都可以使用。且是上下文相关的，因此可实现指定元素的过滤，或者链式选择访问。</p>
<p>Select 方法将返回一个<code>Elements</code>集合，并提供一组方法来抽取和处理结果。</p>
</blockquote>
<h4 id="Selector-选择器概述"><a href="#Selector-选择器概述" class="headerlink" title="Selector 选择器概述"></a>Selector 选择器概述</h4><ul>
<li><code>tagname</code>: 通过标签查找元素，比如：<code>a</code></li>
<li><code>ns|tag</code>: 通过标签在命名空间查找元素，比如：可以用 <code>fb|name</code> 语法来查找 &#96;&#96; 元素</li>
<li><code>#id</code>: 通过 ID 查找元素，比如：<code>#logo</code></li>
<li><code>.class</code>: 通过 class 名称查找元素，比如：<code>.masthead</code></li>
<li><code>[attribute]</code>: 利用属性查找元素，比如：<code>[href]</code></li>
<li><code>[^attr]</code>: 利用属性名前缀来查找元素，比如：可以用<code>[^data-]</code> 来查找带有 HTML5 Dataset 属性的元素</li>
<li><code>[attr=value]</code>: 利用属性值来查找元素，比如：<code>[width=500]</code></li>
<li><code>[attr^=value]</code>, <code>[attr$=value]</code>, <code>[attr*=value]</code>: 利用匹配属性值开头、结尾或包含属性值来查找元素，比如：<code>[href*=/path/]</code></li>
<li><code>[attr\~=regex]</code>: 利用属性值匹配正则表达式来查找元素，比如： <code>img[src\~=(?i)\.(png|jpe?g)]</code></li>
<li><code>*</code>: 这个符号将匹配所有元素</li>
</ul>
<h4 id="Selector-选择器组合使用"><a href="#Selector-选择器组合使用" class="headerlink" title="Selector 选择器组合使用"></a>Selector 选择器组合使用</h4><ul>
<li><code>el##id</code>: 元素+ID，比如： <code>div##logo</code></li>
<li><code>el.class</code>: 元素+class，比如： <code>div.masthead</code></li>
<li><code>el[attr]</code>: 元素+class，比如： <code>a[href]</code></li>
<li>任意组合，比如：<code>a[href].highlight</code></li>
<li><code>ancestor child</code>: 查找某个元素下子元素，比如：可以用<code>.body p</code> 查找在”body”元素下的所有<code>p</code>元素</li>
<li><code>parent &gt; child</code>: 查找某个父元素下的直接子元素，比如：可以用<code>div.content &gt; p</code> 查找 <code>p</code> 元素，也可以用<code>body &gt; *</code> 查找 body 标签下所有直接子元素</li>
<li><code>siblingA + siblingB</code>: 查找在 A 元素之前第一个同级元素 B，比如：<code>div.head + div</code></li>
<li><code>siblingA \~ siblingX</code>: 查找 A 元素之前的同级 X 元素，比如：<code>h1 \~ p</code></li>
<li><code>el, el, el</code>:多个选择器组合，查找匹配任一选择器的唯一元素，例如：<code>div.masthead, div.logo</code></li>
</ul>
<h4 id="伪选择器-selectors"><a href="#伪选择器-selectors" class="headerlink" title="伪选择器 selectors"></a>伪选择器 selectors</h4><ul>
<li><code>:lt(n)</code>: 查找哪些元素的同级索引值（它的位置在 DOM 树中是相对于它的父节点）小于 n，比如：<code>td:lt(3)</code> 表示小于三列的元素</li>
<li><code>:gt(n)</code>:查找哪些元素的同级索引值大于<code>n``，比如</code>： <code>div p:gt(2)</code>表示哪些 div 中有包含 2 个以上的 p 元素</li>
<li><code>:eq(n)</code>: 查找哪些元素的同级索引值与<code>n</code>相等，比如：<code>form input:eq(1)</code>表示包含一个 input 标签的 Form 元素</li>
<li><code>:has(seletor)</code>: 查找匹配选择器包含元素的元素，比如：<code>div:has(p)</code>表示哪些 div 包含了 p 元素</li>
<li><code>:not(selector)</code>: 查找与选择器不匹配的元素，比如： <code>div:not(.logo)</code> 表示不包含 class&#x3D;logo 元素的所有 div 列表</li>
<li><code>:contains(text)</code>: 查找包含给定文本的元素，搜索不区分大不写，比如： <code>p:contains(jsoup)</code></li>
<li><code>:containsOwn(text)</code>: 查找直接包含给定文本的元素</li>
<li><code>:matches(regex)</code>: 查找哪些元素的文本匹配指定的正则表达式，比如：<code>div:matches((?i)login)</code></li>
<li><code>:matchesOwn(regex)</code>: 查找自身包含文本匹配指定正则表达式的元素</li>
<li>注意：上述伪选择器索引是从 0 开始的，也就是说第一个元素索引值为 0，第二个元素 index 为 1 等</li>
</ul>
<p>可以查看<code>Selector</code> API 参考来了解更详细的内容</p>
<h3 id="从元素抽取属性，文本和-HTML"><a href="#从元素抽取属性，文本和-HTML" class="headerlink" title="从元素抽取属性，文本和 HTML"></a>从元素抽取属性，文本和 HTML</h3><p><strong>问题</strong></p>
<p>在解析获得一个 Document 实例对象，并查找到一些元素之后，你希望取得在这些元素中的数据。</p>
<p><strong>方法</strong></p>
<ul>
<li>要取得一个属性的值，可以使用<code>Node.attr(String key)</code> 方法</li>
<li>对于一个元素中的文本，可以使用<code>Element.text()</code>方法</li>
<li>对于要取得元素或属性中的 HTML 内容，可以使用<code>Element.html()</code>, 或 <code>Node.outerHtml()</code>方法</li>
</ul>
<p>示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">html</span> <span class="operator">=</span> <span class="string">&quot;&lt;p&gt;An &lt;a href=&#x27;http://example.com/&#x27;&gt;&lt;b&gt;example&lt;/b&gt;&lt;/a&gt; link.&lt;/p&gt;&quot;</span>;</span><br><span class="line"><span class="type">Document</span> <span class="variable">doc</span> <span class="operator">=</span> Jsoup.parse(html);<span class="comment">//解析HTML字符串返回一个Document实现</span></span><br><span class="line"><span class="type">Element</span> <span class="variable">link</span> <span class="operator">=</span> doc.select(<span class="string">&quot;a&quot;</span>).first();<span class="comment">//查找第一个a元素</span></span><br><span class="line"></span><br><span class="line"><span class="type">String</span> <span class="variable">text</span> <span class="operator">=</span> doc.body().text(); <span class="comment">// &quot;An example link&quot;//取得字符串中的文本</span></span><br><span class="line"><span class="type">String</span> <span class="variable">linkHref</span> <span class="operator">=</span> link.attr(<span class="string">&quot;href&quot;</span>); <span class="comment">// &quot;http://example.com/&quot;//取得链接地址</span></span><br><span class="line"><span class="type">String</span> <span class="variable">linkText</span> <span class="operator">=</span> link.text(); <span class="comment">// &quot;example&quot;&quot;//取得链接地址中的文本</span></span><br><span class="line"></span><br><span class="line"><span class="type">String</span> <span class="variable">linkOuterH</span> <span class="operator">=</span> link.outerHtml();</span><br><span class="line">    <span class="comment">// &quot;&lt;a href=&quot;http://example.com&quot;&gt;&lt;b&gt;example&lt;/b&gt;&lt;/a&gt;&quot;</span></span><br><span class="line"><span class="type">String</span> <span class="variable">linkInnerH</span> <span class="operator">=</span> link.html(); <span class="comment">// &quot;&lt;b&gt;example&lt;/b&gt;&quot;//取得链接内的html内容</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>说明</strong></p>
<p>上述方法是元素数据访问的核心办法。此外还其它一些方法可以使用：</p>
<ul>
<li><code>Element.id()</code></li>
<li><code>Element.tagName()</code></li>
<li><code>Element.className()</code> and <code>Element.hasClass(String className)</code></li>
</ul>
<p>这些访问器方法都有相应的 setter 方法来更改数据</p>
</blockquote>
<p><strong>参见</strong></p>
<ul>
<li><code>Element</code>和<code>Elements</code>集合类的参考文档</li>
<li><a target="_blank" rel="noopener" href="http://www.open-open.com/jsoup/working-with-urls.htm">URLs 处理</a></li>
<li><a target="_blank" rel="noopener" href="http://www.open-open.com/jsoup/selector-syntax.htm">使用 CSS 选择器语法来查找元素</a></li>
</ul>
<h3 id="处理-URLs"><a href="#处理-URLs" class="headerlink" title="处理 URLs"></a>处理 URLs</h3><p><strong>问题</strong></p>
<p>你有一个包含相对 URLs 路径的 HTML 文档，需要将这些相对路径转换成绝对路径的 URLs。</p>
<p><strong>方法</strong></p>
<ol>
<li>在你解析文档时确保有指定<code>base URI</code>，然后</li>
<li>使用 <code>abs:</code> 属性前缀来取得包含<code>base URI</code>的绝对路径。代码如下：</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Document</span> <span class="variable">doc</span> <span class="operator">=</span> Jsoup.connect(<span class="string">&quot;http://www.open-open.com&quot;</span>).get();</span><br><span class="line"></span><br><span class="line"><span class="type">Element</span> <span class="variable">link</span> <span class="operator">=</span> doc.select(<span class="string">&quot;a&quot;</span>).first();</span><br><span class="line"><span class="type">String</span> <span class="variable">relHref</span> <span class="operator">=</span> link.attr(<span class="string">&quot;href&quot;</span>); <span class="comment">// == &quot;/&quot;</span></span><br><span class="line"><span class="type">String</span> <span class="variable">absHref</span> <span class="operator">=</span> link.attr(<span class="string">&quot;abs:href&quot;</span>); <span class="comment">// &quot;http://www.open-open.com/&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>说明</strong></p>
<p>在 HTML 元素中，URLs 经常写成相对于文档位置的相对路径： <code>&lt;a href=&quot;/download&quot;&gt;...&lt;/a&gt;</code>. 当你使用 <code>Node.attr(String key)</code> 方法来取得 a 元素的 href 属性时，它将直接返回在 HTML 源码中指定定的值。</p>
<p>假如你需要取得一个绝对路径，需要在属性名前加 <code>abs:</code> 前缀。这样就可以返回包含根路径的 URL 地址<code>attr(&quot;abs:href&quot;)</code></p>
<p>因此，在解析 HTML 文档时，定义 base URI 非常重要。</p>
<p>如果你不想使用<code>abs:</code> 前缀，还有一个方法能够实现同样的功能 <code>Node.absUrl(String key)</code>。</p>
</blockquote>
<h2 id="数据修改"><a href="#数据修改" class="headerlink" title="数据修改"></a>数据修改</h2><h3 id="设置属性的值"><a href="#设置属性的值" class="headerlink" title="设置属性的值"></a>设置属性的值</h3><p><strong>问题</strong></p>
<p>在你解析一个 <code>Document</code> 之后可能想修改其中的某些属性值，然后再保存到磁盘或都输出到前台页面。</p>
<p><strong>方法</strong></p>
<p>可以使用属性设置方法 <code>Element.attr(String key, String value)</code>, 和 <code>Elements.attr(String key, String value)</code>.</p>
<p>假如你需要修改一个元素的 <code>class</code> 属性，可以使用 <code>Element.addClass(String className)</code> 和<code>Element.removeClass(String className)</code> 方法。</p>
<p><code>Elements</code> 提供了批量操作元素属性和 class 的方法，比如：要为 div 中的每一个 a 元素都添加一个<code>rel=&quot;nofollow&quot;</code> 可以使用如下方法：</p>
<figure class="highlight q"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">doc.<span class="keyword">select</span>(<span class="string">&quot;div.comments a&quot;</span>).<span class="built_in">attr</span>(<span class="string">&quot;rel&quot;</span>, <span class="string">&quot;nofollow&quot;</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>说明</strong></p>
<p>与<code>Element</code>中的其它方法一样，<code>attr</code> 方法也是返回当 <code>Element</code> (或在使用选择器是返回 <code>Elements</code>集合)。这样能够很方便使用方法连用的书写方式。比如：</p>
<figure class="highlight q"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">doc.<span class="keyword">select</span>(<span class="string">&quot;div.masthead&quot;</span>).<span class="built_in">attr</span>(<span class="string">&quot;title&quot;</span>, <span class="string">&quot;jsoup&quot;</span>).addClass(<span class="string">&quot;round-box&quot;</span>);</span><br></pre></td></tr></table></figure>
</blockquote>
<h3 id="设置一个元素的-HTML-内容"><a href="#设置一个元素的-HTML-内容" class="headerlink" title="设置一个元素的 HTML 内容"></a>设置一个元素的 HTML 内容</h3><p><strong>问题</strong></p>
<p>你需要一个元素中的 HTML 内容</p>
<p><strong>方法</strong></p>
<p>可以使用<code>Element</code>中的 HTML 设置方法具体如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Element</span> <span class="variable">div</span> <span class="operator">=</span> doc.select(<span class="string">&quot;div&quot;</span>).first(); <span class="comment">// &lt;div&gt;&lt;/div&gt;</span></span><br><span class="line">div.html(<span class="string">&quot;&lt;p&gt;lorem ipsum&lt;/p&gt;&quot;</span>); <span class="comment">// &lt;div&gt;&lt;p&gt;lorem ipsum&lt;/p&gt;&lt;/div&gt;</span></span><br><span class="line">div.prepend(<span class="string">&quot;&lt;p&gt;First&lt;/p&gt;&quot;</span>);<span class="comment">//在div前添加html内容</span></span><br><span class="line">div.append(<span class="string">&quot;&lt;p&gt;Last&lt;/p&gt;&quot;</span>);<span class="comment">//在div之后添加html内容</span></span><br><span class="line"><span class="comment">// 添完后的结果: &lt;div&gt;&lt;p&gt;First&lt;/p&gt;&lt;p&gt;lorem ipsum&lt;/p&gt;&lt;p&gt;Last&lt;/p&gt;&lt;/div&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="type">Element</span> <span class="variable">span</span> <span class="operator">=</span> doc.select(<span class="string">&quot;span&quot;</span>).first(); <span class="comment">// &lt;span&gt;One&lt;/span&gt;</span></span><br><span class="line">span.wrap(<span class="string">&quot;&lt;li&gt;&lt;a href=&#x27;http://example.com/&#x27;&gt;&lt;/a&gt;&lt;/li&gt;&quot;</span>);</span><br><span class="line"><span class="comment">// 添完后的结果: &lt;li&gt;&lt;a href=&quot;http://example.com&quot;&gt;&lt;span&gt;One&lt;/span&gt;&lt;/a&gt;&lt;/li&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>说明</strong></p>
<ul>
<li><code>Element.html(String html)</code> 这个方法将先清除元素中的 HTML 内容，然后用传入的 HTML 代替。</li>
<li><code>Element.prepend(String first)</code> 和 <code>Element.append(String last)</code> 方法用于在分别在元素内部 HTML 的前面和后面添加 HTML 内容</li>
<li><code>Element.wrap(String around)</code> 对元素包裹一个外部 HTML 内容。</li>
</ul>
<p><strong>参见</strong></p>
<p>可以查看 API 参考文档中 <code>Element.prependElement(String tag)</code>和<code>Element.appendElement(String tag)</code> 方法来创建新的元素并作为文档的子元素插入其中。</p>
</blockquote>
<h3 id="设置元素的文本内容"><a href="#设置元素的文本内容" class="headerlink" title="设置元素的文本内容"></a>设置元素的文本内容</h3><p><strong>问题</strong></p>
<p>你需要修改一个 HTML 文档中的文本内容</p>
<p><strong>方法</strong></p>
<p>可以使用<code>Element</code>的设置方法：:</p>
<figure class="highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Element div =<span class="built_in"> doc</span>.select(<span class="string">&quot;div&quot;</span>).first(); // <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">div.<span class="type">text</span>(<span class="string">&quot;five &gt; four&quot;</span>); // <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>five <span class="symbol">&amp;gt;</span> four<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">div.prepend(<span class="string">&quot;First &quot;</span>);</span><br><span class="line">div.append(<span class="string">&quot; Last&quot;</span>);</span><br><span class="line">// now: <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>First five <span class="symbol">&amp;gt;</span> four Last<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>说明</strong></p>
<p>文本设置方法与 <a target="_blank" rel="noopener" href="http://jsoup.org/cookbook/modifying-data/set-html">HTML setter</a> 方法一样：</p>
<ul>
<li><code>Element.text(String text)</code> 将清除一个元素中的内部 HTML 内容，然后提供的文本进行代替</li>
<li><code>Element.prepend(String first)</code> 和 <code>Element.append(String last)</code> 将分别在元素的内部 html 前后添加文本节点。</li>
</ul>
<p>对于传入的文本如果含有像 <code>&lt;</code>, <code>&gt;</code> 等这样的字符，将以文本处理，而非 HTML。</p>
</blockquote>
<h2 id="HTML-清理"><a href="#HTML-清理" class="headerlink" title="HTML 清理"></a>HTML 清理</h2><h3 id="消除不受信任的-HTML-来防止-XSS-攻击"><a href="#消除不受信任的-HTML-来防止-XSS-攻击" class="headerlink" title="消除不受信任的 HTML (来防止 XSS 攻击)"></a>消除不受信任的 HTML (来防止 XSS 攻击)</h3><p><strong>问题</strong></p>
<p>在做网站的时候，经常会提供用户评论的功能。有些不怀好意的用户，会搞一些脚本到评论内容中，而这些脚本可能会破坏整个页面的行为，更严重的是获取一些机要信息，此时需要清理该 HTML，以避免跨站脚本<a target="_blank" rel="noopener" href="http://en.wikipedia.org/wiki/Cross-site_scripting">cross-site scripting</a>攻击（XSS）。</p>
<p><strong>方法</strong></p>
<p>使用 jsoup HTML <code>Cleaner</code> 方法进行清除，但需要指定一个可配置的 <code>Whitelist</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">unsafe</span> <span class="operator">=</span></span><br><span class="line">  <span class="string">&quot;&lt;p&gt;&lt;a href=&#x27;http://example.com/&#x27; onclick=&#x27;stealCookies()&#x27;&gt;Link&lt;/a&gt;&lt;/p&gt;&quot;</span>;</span><br><span class="line"><span class="type">String</span> <span class="variable">safe</span> <span class="operator">=</span> Jsoup.clean(unsafe, Whitelist.basic());</span><br><span class="line"><span class="comment">// now: &lt;p&gt;&lt;a href=&quot;http://example.com/&quot; rel=&quot;nofollow&quot;&gt;Link&lt;/a&gt;&lt;/p&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>说明</strong></p>
<p>XSS 又叫 CSS (Cross Site Script) ，跨站脚本攻击。它指的是恶意攻击者往 Web 页面里插入恶意 html 代码，当用户浏览该页之时，嵌入其中 Web 里面的 html 代码会被执行，从而达到恶意攻击用户的特殊目的。XSS 属于被动式的攻击，因为其被动且不好利用，所以许多人常忽略其危害性。所以我们经常只让用户输入纯文本的内容，但这样用户体验就比较差了。</p>
<p>一个更好的解决方法就是使用一个富文本编辑器 WYSIWYG 如 <a target="_blank" rel="noopener" href="http://ckeditor.com/">CKEditor</a> 和 <a target="_blank" rel="noopener" href="http://tinymce.moxiecode.com/">TinyMCE</a>。这些可以输出 HTML 并能够让用户可视化编辑。虽然他们可以在客户端进行校验，但是这样还不够安全，需要在服务器端进行校验并清除有害的 HTML 代码，这样才能确保输入到你网站的 HTML 是安全的。否则，攻击者能够绕过客户端的 Javascript 验证，并注入不安全的 HMTL 直接进入您的网站。</p>
<p>jsoup 的 whitelist 清理器能够在服务器端对用户输入的 HTML 进行过滤，只输出一些安全的标签和属性。</p>
<p>jsoup 提供了一系列的 <code>Whitelist</code> 基本配置，能够满足大多数要求；但如有必要，也可以进行修改，不过要小心。</p>
<p>这个 cleaner 非常好用不仅可以避免 XSS 攻击，还可以限制用户可以输入的标签范围。</p>
<p><strong>参见</strong></p>
<ul>
<li>参阅<a target="_blank" rel="noopener" href="http://ha.ckers.org/xss.html">XSS cheat sheet</a> ，有一个例子可以了解为什么不能使用正则表达式，而采用安全的 whitelist parser-based 清理器才是正确的选择。</li>
<li>参阅<code>Cleaner</code> ，了解如何返回一个 <code>Document</code> 对象，而不是字符串</li>
<li>参阅<code>Whitelist</code>，了解如何创建一个自定义的 whitelist</li>
<li><a target="_blank" rel="noopener" href="http://en.wikipedia.org/wiki/Nofollow">nofollow</a> 链接属性了解</li>
</ul>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/jhy/jsoup">jsoup github 托管代码</a></li>
<li><a target="_blank" rel="noopener" href="https://jsoup.org/cookbook/">jsoup Cookbook</a></li>
<li><a target="_blank" rel="noopener" href="http://www.open-open.com/jsoup/">jsoup Cookbook(中文版)</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/code4craft/jsoup-learning">不错的 jsoup 学习笔记</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://dunwu.github.io/blog/pages/adacc5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/uploads/avatar.gif">
      <meta itemprop="name" content="钝悟 ◾ Dunwu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dunwu Blog">
      <meta itemprop="description" content="钝悟的个人博客">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Dunwu Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/pages/adacc5/" class="post-title-link" itemprop="url">Thumbnailator 快速入门</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-02-17 22:34:30" itemprop="dateCreated datePublished" datetime="2022-02-17T22:34:30+08:00">2022-02-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-01-27 23:32:48" itemprop="dateModified" datetime="2024-01-27T23:32:48+08:00">2024-01-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/%E5%B7%A5%E5%85%B7/" itemprop="url" rel="index"><span itemprop="name">工具</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/%E5%B7%A5%E5%85%B7/%E5%85%B6%E4%BB%96/" itemprop="url" rel="index"><span itemprop="name">其他</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>5.1k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>5 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Thumbnailator-快速入门"><a href="#Thumbnailator-快速入门" class="headerlink" title="Thumbnailator 快速入门"></a>Thumbnailator 快速入门</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p><code>Thumbnailator</code> 是一个开源的 <strong>Java</strong> 项目，它提供了非常简单的 API 来对图片进行缩放、旋转以及加水印的处理。</p>
<p>有多简单呢？简单到一行代码就可以完成图片处理。形式如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Thumbnails.of(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;path/to/directory&quot;</span>).listFiles())</span><br><span class="line">    .size(<span class="number">640</span>, <span class="number">480</span>)</span><br><span class="line">    .outputFormat(<span class="string">&quot;jpg&quot;</span>)</span><br><span class="line">    .toFiles(Rename.PREFIX_DOT_THUMBNAIL);</span><br></pre></td></tr></table></figure>

<p>当然，Thumbnailator 还有一些使用细节，下面我会一一道来。</p>
<h2 id="核心-API"><a href="#核心-API" class="headerlink" title="核心 API"></a>核心 API</h2><h3 id="Thumbnails"><a href="#Thumbnails" class="headerlink" title="Thumbnails"></a>Thumbnails</h3><p><code>Thumbnails</code> 是使用 Thumbnailator 创建缩略图的主入口。</p>
<p>它提供了一组初始化 <code>Thumbnails.Builder</code> 的接口。</p>
<p>先看下这组接口的声明：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 可变长度参数列表</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Builder&lt;File&gt; <span class="title function_">of</span><span class="params">(String... files)</span> &#123;...&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Builder&lt;File&gt; <span class="title function_">of</span><span class="params">(File... files)</span> &#123;...&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Builder&lt;URL&gt; <span class="title function_">of</span><span class="params">(URL... urls)</span> &#123;...&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Builder&lt;? <span class="keyword">extends</span> <span class="title class_">InputStream</span>&gt; of(InputStream... inputStreams) &#123;...&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Builder&lt;BufferedImage&gt; <span class="title function_">of</span><span class="params">(BufferedImage... images)</span> &#123;...&#125;</span><br><span class="line"><span class="comment">// 迭代器（所有实现 Iterable 接口的 Java 对象都可以，当然也包括 List、Set）</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Builder&lt;File&gt; <span class="title function_">fromFilenames</span><span class="params">(Iterable&lt;String&gt; files)</span> &#123;...&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Builder&lt;File&gt; <span class="title function_">fromFiles</span><span class="params">(Iterable&lt;File&gt; files)</span> &#123;...&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Builder&lt;URL&gt; <span class="title function_">fromURLs</span><span class="params">(Iterable&lt;URL&gt; urls)</span> &#123;...&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Builder&lt;InputStream&gt; <span class="title function_">fromInputStreams</span><span class="params">(Iterable&lt;? extends InputStream&gt; inputStreams)</span> &#123;...&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Builder&lt;BufferedImage&gt; <span class="title function_">fromImages</span><span class="params">(Iterable&lt;BufferedImage&gt; images)</span> &#123;...&#125;</span><br></pre></td></tr></table></figure>

<p>很显然，<strong>Thumbnails 允许通过传入文件名、文件、网络图的 URL、图片流、图片缓存多种方式来初始化构造器</strong>。</p>
<p>因此，你可以根据实际需求来灵活的选择图片的输入方式。</p>
<p>需要注意一点：<strong>如果输入是多个对象（无论你是直接输入容器对象或使用可变参数方式传入多个对象），则输出也必须选用输出多个对象的方式，否则会报异常。</strong></p>
<h3 id="Thumbnails-Builder"><a href="#Thumbnails-Builder" class="headerlink" title="Thumbnails.Builder"></a>Thumbnails.Builder</h3><p><code>Thumbnails.Builder</code> 是 <code>Thumbnails</code> 的内部静态类。它用于设置生成缩略图任务的相关参数。</p>
<p><strong><em>注：<code>Thumbnails.Builder</code> 的构造函数是私有函数。所以，它只允许通过 <code>Thumbnails</code> 的实例化函数来进行初始化。</em></strong></p>
<h4 id="设置参数的函数"><a href="#设置参数的函数" class="headerlink" title="设置参数的函数"></a>设置参数的函数</h4><p><code>Thumbnails.Builder</code> 提供了一组函数链形式的接口来设置缩放图参数。</p>
<p>以设置大小函数为例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Builder&lt;T&gt; <span class="title function_">size</span><span class="params">(<span class="type">int</span> width, <span class="type">int</span> height)</span></span><br><span class="line">&#123;</span><br><span class="line"> updateStatus(Properties.SIZE, Status.ALREADY_SET);</span><br><span class="line"> updateStatus(Properties.SCALE, Status.CANNOT_SET);</span><br><span class="line"></span><br><span class="line"> validateDimensions(width, height);</span><br><span class="line"> <span class="built_in">this</span>.width = width;</span><br><span class="line"> <span class="built_in">this</span>.height = height;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过返回 this 指针，使得设置参数函数可以以链式调用的方式来使用，形式如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Thumbnails.of(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;original.jpg&quot;</span>))</span><br><span class="line">        .size(<span class="number">160</span>, <span class="number">160</span>)</span><br><span class="line">        .rotate(<span class="number">90</span>)</span><br><span class="line">        .watermark(Positions.BOTTOM_RIGHT, ImageIO.read(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;watermark.png&quot;</span>)), <span class="number">0.5f</span>)</span><br><span class="line">        .outputQuality(<span class="number">0.8</span>)</span><br><span class="line">        .toFile(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;image-with-watermark.jpg&quot;</span>));</span><br></pre></td></tr></table></figure>

<p>好处，不言自明：那就是大大简化了代码。</p>
<h4 id="输出函数"><a href="#输出函数" class="headerlink" title="输出函数"></a>输出函数</h4><p><code>Thumbnails.Builder</code> 提供了一组重载函数来输出生成的缩放图。</p>
<p>函数声明如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 返回图片缓存</span></span><br><span class="line"><span class="keyword">public</span> List&lt;BufferedImage&gt; <span class="title function_">asBufferedImages</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;...&#125;</span><br><span class="line"><span class="keyword">public</span> BufferedImage <span class="title function_">asBufferedImage</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;...&#125;</span><br><span class="line"><span class="comment">// 返回文件列表</span></span><br><span class="line"><span class="keyword">public</span> List&lt;File&gt; <span class="title function_">asFiles</span><span class="params">(Iterable&lt;File&gt; iterable)</span> <span class="keyword">throws</span> IOException &#123;...&#125;</span><br><span class="line"><span class="keyword">public</span> List&lt;File&gt; <span class="title function_">asFiles</span><span class="params">(Rename rename)</span> <span class="keyword">throws</span> IOException &#123;...&#125;</span><br><span class="line"><span class="keyword">public</span> List&lt;File&gt; <span class="title function_">asFiles</span><span class="params">(File destinationDir, Rename rename)</span> <span class="keyword">throws</span> IOException &#123;...&#125;</span><br><span class="line"><span class="comment">// 创建文件</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">toFile</span><span class="params">(File outFile)</span> <span class="keyword">throws</span> IOException &#123;...&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">toFile</span><span class="params">(String outFilepath)</span> <span class="keyword">throws</span> IOException &#123;...&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">toFiles</span><span class="params">(Iterable&lt;File&gt; iterable)</span> <span class="keyword">throws</span> IOException &#123;...&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">toFiles</span><span class="params">(Rename rename)</span> <span class="keyword">throws</span> IOException &#123;...&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">toFiles</span><span class="params">(File destinationDir, Rename rename)</span> <span class="keyword">throws</span> IOException &#123;...&#125;</span><br><span class="line"><span class="comment">// 创建输出流</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">toOutputStream</span><span class="params">(OutputStream os)</span> <span class="keyword">throws</span> IOException &#123;...&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">toOutputStreams</span><span class="params">(Iterable&lt;? extends OutputStream&gt; iterable)</span> <span class="keyword">throws</span> IOException &#123;...&#125;</span><br></pre></td></tr></table></figure>

<h3 id="工作流"><a href="#工作流" class="headerlink" title="工作流"></a>工作流</h3><p>Thumbnailator 的工作步骤十分简单，可分为三步：</p>
<ol>
<li><p><strong>输入</strong>：<code>Thumbnails</code> 根据输入初始化构造器—— <code>Thumbnails.Builder</code> 。</p>
</li>
<li><p><strong>设置</strong>：<code>Thumbnails.Builder</code> 设置缩放图片的参数。</p>
</li>
<li><p><strong>输出</strong>：<code>Thumbnails.Builder</code> 输出图片文件或图片流。</p>
</li>
</ol>
<blockquote>
<p>更多详情可以参考： <a target="_blank" rel="noopener" href="https://coobird.github.io/thumbnailator/javadoc/0.4.8/"><u>Thumbnailator 官网 javadoc</u></a></p>
</blockquote>
<h2 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h2><p>前文介绍了 Thumbnailator 的核心 API，接下来我们就可以通过实战来看看 Thumbnailator 究竟可以做些什么。</p>
<p>Thumbnailator 生成什么样的图片，是根据设置参数来决定的。</p>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>maven 项目中引入依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>net.coobird<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>thumbnailator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>[0.4, 0.5)<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="图片缩放"><a href="#图片缩放" class="headerlink" title="图片缩放"></a>图片缩放</h3><p><code>Thumbnails.Builder</code> 的 <code>size</code> 函数可以设置新图片精确的宽度和高度，也可以用 <code>scale</code> 函数设置缩放比例。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Thumbnails.of(<span class="string">&quot;oldFile.png&quot;</span>)</span><br><span class="line">  .size(<span class="number">16</span>, <span class="number">16</span>)</span><br><span class="line">  .toFile(<span class="string">&quot;newFile_16_16.png&quot;</span>);</span><br><span class="line"></span><br><span class="line">Thumbnails.of(<span class="string">&quot;oldFile.png&quot;</span>)</span><br><span class="line">  .scale(<span class="number">2.0</span>)</span><br><span class="line">  .toFile(<span class="string">&quot;newFile_scale_2.0.png&quot;</span>);</span><br><span class="line"></span><br><span class="line">Thumbnails.of(<span class="string">&quot;oldFile.png&quot;</span>)</span><br><span class="line">  .scale(<span class="number">1.0</span>, <span class="number">0.5</span>)</span><br><span class="line">  .toFile(<span class="string">&quot;newFile_scale_1.0_0.5.png&quot;</span>);</span><br></pre></td></tr></table></figure>

<p><strong>oldFile.png</strong></p>
<p><img src="http://upload-images.jianshu.io/upload_images/3101171-ba63439898602e8f.png" alt="img"></p>
<p><strong>newFile_scale_1.0_0.5.png</strong></p>
<p><img src="http://upload-images.jianshu.io/upload_images/3101171-a01ea4515fff865d.png" alt="img"></p>
<h3 id="图片旋转"><a href="#图片旋转" class="headerlink" title="图片旋转"></a>图片旋转</h3><p><code>Thumbnails.Builder</code> 的 <code>size</code> 函数可以设置新图片的旋转角度。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Thumbnails.of(<span class="string">&quot;oldFile.png&quot;</span>)</span><br><span class="line">  .scale(<span class="number">0.8</span>)</span><br><span class="line">  .rotate(<span class="number">90</span>)</span><br><span class="line">  .toFile(<span class="string">&quot;newFile_rotate_90.png&quot;</span>);</span><br><span class="line"></span><br><span class="line">Thumbnails.of(<span class="string">&quot;oldFile.png&quot;</span>)</span><br><span class="line">  .scale(<span class="number">0.8</span>)</span><br><span class="line">  .rotate(<span class="number">180</span>)</span><br><span class="line">  .toFile(<span class="string">&quot;newFile_rotate_180.png&quot;</span>);</span><br></pre></td></tr></table></figure>

<p><strong>newFile_rotate_90.png</strong></p>
<p><img src="http://upload-images.jianshu.io/upload_images/3101171-17d54bc33b38d45b.png" alt="img"></p>
<h3 id="加水印"><a href="#加水印" class="headerlink" title="加水印"></a>加水印</h3><p><code>Thumbnails.Builder</code> 的 <code>watermark</code> 函数可以为图片添加水印图片。第一个参数是水印的位置；第二个参数是水印图片的缓存数据；第三个参数是透明度。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">BufferedImage</span> <span class="variable">watermarkImage</span> <span class="operator">=</span> ImageIO.read(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;wartermarkFile.png&quot;</span>));</span><br><span class="line">Thumbnails.of(<span class="string">&quot;oldFile.png&quot;</span>)</span><br><span class="line">  .scale(<span class="number">0.8</span>)</span><br><span class="line">  .watermark(Positions.BOTTOM_LEFT, watermarkImage, <span class="number">0.5f</span>)</span><br><span class="line">  .toFile(<span class="string">&quot;newFile_watermark.png&quot;</span>);</span><br></pre></td></tr></table></figure>

<p><strong>wartermarkFile.png</strong></p>
<p><img src="http://upload-images.jianshu.io/upload_images/3101171-97909ee6c066c195.png?imageMogr2/auto-orient/strip" alt="img"></p>
<p><strong>newFile_watermark.png</strong></p>
<p><img src="http://upload-images.jianshu.io/upload_images/3101171-93eb7ef71b811a0c.png" alt="img"></p>
<h3 id="批量处理图片"><a href="#批量处理图片" class="headerlink" title="批量处理图片"></a>批量处理图片</h3><p>下面以批量给图片加水印来展示一下如何处理多个图片文件。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">BufferedImage</span> <span class="variable">watermarkImage</span> <span class="operator">=</span> ImageIO.read(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;wartermarkFile.png&quot;</span>));</span><br><span class="line"></span><br><span class="line"><span class="type">File</span> <span class="variable">destinationDir</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;D:\\watermark\\&quot;</span>);</span><br><span class="line">Thumbnails.of(<span class="string">&quot;oldFile.png&quot;</span>, <span class="string">&quot;oldFile2.png&quot;</span>)</span><br><span class="line">  .scale(<span class="number">0.8</span>)</span><br><span class="line">  .watermark(Positions.BOTTOM_LEFT, watermarkImage, <span class="number">0.5f</span>)</span><br><span class="line">  .toFiles(destinationDir, Rename.PREFIX_DOT_THUMBNAIL);</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>需要参考完整测试例代码请</strong> <a target="_blank" rel="noopener" href="https://github.com/dunwu/JavaParty/blob/master/toolbox/image/src/test/java/org/zp/image/ThumbnailatorTest.java"><u><strong>点击这里</strong></u></a></p>
</blockquote>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a target="_blank" rel="noopener" href="https://github.com/coobird/thumbnailator/wiki/Examples">Thumbnailator 官方示例文档</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://dunwu.github.io/blog/pages/b563af/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/uploads/avatar.gif">
      <meta itemprop="name" content="钝悟 ◾ Dunwu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dunwu Blog">
      <meta itemprop="description" content="钝悟的个人博客">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Dunwu Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/pages/b563af/" class="post-title-link" itemprop="url">ZXing 快速入门</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-02-17 22:34:30" itemprop="dateCreated datePublished" datetime="2022-02-17T22:34:30+08:00">2022-02-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-01-27 23:32:48" itemprop="dateModified" datetime="2024-01-27T23:32:48+08:00">2024-01-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/%E5%B7%A5%E5%85%B7/" itemprop="url" rel="index"><span itemprop="name">工具</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/%E5%B7%A5%E5%85%B7/%E5%85%B6%E4%BB%96/" itemprop="url" rel="index"><span itemprop="name">其他</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>2.1k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>2 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="ZXing-快速入门"><a href="#ZXing-快速入门" class="headerlink" title="ZXing 快速入门"></a>ZXing 快速入门</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p><code>ZXing</code> 是一个开源 Java 类库用于解析多种格式的 1D&#x2F;2D 条形码。目标是能够对 QR 编码、Data Matrix、UPC 的 1D 条形码进行解码。 其提供了多种平台下的客户端包括：J2ME、J2SE 和 Android。</p>
<p>官网：<a target="_blank" rel="noopener" href="https://github.com/zxing/zxing"><u>ZXing github 仓库</u></a></p>
<h2 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h2><p><strong><em>本例演示如何在一个非 android 的 Java 项目中使用 ZXing 来生成、解析二维码图片。</em></strong></p>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>maven 项目只需引入依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.google.zxing<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.3.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.google.zxing<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javase<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.3.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>如果非 maven 项目，就去官网下载发布版本：<a target="_blank" rel="noopener" href="https://github.com/zxing/zxing/releases"><u>下载地址</u></a></p>
<h3 id="生成二维码图片"><a href="#生成二维码图片" class="headerlink" title="生成二维码图片"></a>生成二维码图片</h3><p>ZXing 生成二维码图片有以下步骤：</p>
<ol>
<li><code>com.google.zxing.MultiFormatWriter</code> 根据内容以及图像编码参数生成图像 2D 矩阵。</li>
<li>​ <code>com.google.zxing.client.j2se.MatrixToImageWriter</code> 根据图像矩阵生成图片文件或图片缓存 <code>BufferedImage</code> 。</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">encode</span><span class="params">(String content, String filepath)</span> <span class="keyword">throws</span> WriterException, IOException &#123;</span><br><span class="line"> <span class="type">int</span> <span class="variable">width</span> <span class="operator">=</span> <span class="number">100</span>;</span><br><span class="line"> <span class="type">int</span> <span class="variable">height</span> <span class="operator">=</span> <span class="number">100</span>;</span><br><span class="line"> Map&lt;EncodeHintType, Object&gt; encodeHints = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;EncodeHintType, Object&gt;();</span><br><span class="line"> encodeHints.put(EncodeHintType.CHARACTER_SET, <span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line"> <span class="type">BitMatrix</span> <span class="variable">bitMatrix</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MultiFormatWriter</span>().encode(content, BarcodeFormat.QR_CODE, width, height, encodeHints);</span><br><span class="line"> <span class="type">Path</span> <span class="variable">path</span> <span class="operator">=</span> FileSystems.getDefault().getPath(filepath);</span><br><span class="line"> MatrixToImageWriter.writeToPath(bitMatrix, <span class="string">&quot;png&quot;</span>, path);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="解析二维码图片"><a href="#解析二维码图片" class="headerlink" title="解析二维码图片"></a>解析二维码图片</h3><p>ZXing 解析二维码图片有以下步骤：</p>
<ol>
<li><p>使用 <code>javax.imageio.ImageIO</code> 读取图片文件，并存为一个 <code>java.awt.image.BufferedImage</code> 对象。</p>
</li>
<li><p>将 <code>java.awt.image.BufferedImage</code> 转换为 ZXing 能识别的 <code>com.google.zxing.BinaryBitmap</code> 对象。</p>
</li>
<li><p><code>com.google.zxing.MultiFormatReader</code> 根据图像解码参数来解析 <code>com.google.zxing.BinaryBitmap</code> 。</p>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> String <span class="title function_">decode</span><span class="params">(String filepath)</span> <span class="keyword">throws</span> IOException, NotFoundException &#123;</span><br><span class="line"> <span class="type">BufferedImage</span> <span class="variable">bufferedImage</span> <span class="operator">=</span> ImageIO.read(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(filepath));</span><br><span class="line"> <span class="type">LuminanceSource</span> <span class="variable">source</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedImageLuminanceSource</span>(bufferedImage);</span><br><span class="line"> <span class="type">Binarizer</span> <span class="variable">binarizer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HybridBinarizer</span>(source);</span><br><span class="line"> <span class="type">BinaryBitmap</span> <span class="variable">bitmap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BinaryBitmap</span>(binarizer);</span><br><span class="line"> HashMap&lt;DecodeHintType, Object&gt; decodeHints = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;DecodeHintType, Object&gt;();</span><br><span class="line"> decodeHints.put(DecodeHintType.CHARACTER_SET, <span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line"> <span class="type">Result</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MultiFormatReader</span>().decode(bitmap, decodeHints);</span><br><span class="line"> <span class="keyword">return</span> result.getText();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>完整参考示例：<a target="_blank" rel="noopener" href="https://github.com/dunwu/JavaParty/blob/master/toolbox/image/src/test/java/org/zp/image/QRCodeUtilTest.java"><u>测试例代码</u></a></p>
<p>以下是一个生成的二维码图片示例：</p>
<p><img src="http://upload-images.jianshu.io/upload_images/3101171-26b73730088f0ab8.png" alt="img"></p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a target="_blank" rel="noopener" href="https://github.com/zxing/zxing">ZXing github 仓库</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://dunwu.github.io/blog/pages/d4e6ee/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/uploads/avatar.gif">
      <meta itemprop="name" content="钝悟 ◾ Dunwu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dunwu Blog">
      <meta itemprop="description" content="钝悟的个人博客">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Dunwu Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/pages/d4e6ee/" class="post-title-link" itemprop="url">Mybatis快速入门</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-02-17 22:34:30" itemprop="dateCreated datePublished" datetime="2022-02-17T22:34:30+08:00">2022-02-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-01-27 23:32:48" itemprop="dateModified" datetime="2024-01-27T23:32:48+08:00">2024-01-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/%E6%A1%86%E6%9E%B6/" itemprop="url" rel="index"><span itemprop="name">框架</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/%E6%A1%86%E6%9E%B6/ORM/" itemprop="url" rel="index"><span itemprop="name">ORM</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>10k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>9 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="MyBatis-快速入门"><a href="#MyBatis-快速入门" class="headerlink" title="MyBatis 快速入门"></a>MyBatis 快速入门</h1><blockquote>
<p>MyBatis 的前身就是 iBatis ，是一个作用在数据持久层的对象关系映射（Object Relational Mapping，简称 ORM）框架。</p>
</blockquote>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/20200716162305.png" alt="img"></p>
<h2 id="Mybatis-简介"><a href="#Mybatis-简介" class="headerlink" title="Mybatis 简介"></a>Mybatis 简介</h2><p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/20210510164925.png" alt="img"></p>
<h3 id="什么是-MyBatis"><a href="#什么是-MyBatis" class="headerlink" title="什么是 MyBatis"></a>什么是 MyBatis</h3><p>MyBatis 是一款持久层框架，它支持定制化 SQL、存储过程以及高级映射。MyBatis 避免了几乎所有的 JDBC 代码和手动设置参数以及获取结果集。MyBatis 可以使用简单的 XML 或注解来配置和映射原生类型、接口和 Java 的 POJO（Plain Old Java Objects，普通老式 Java 对象）为数据库中的记录。</p>
<h3 id="MyBatis-vs-Hibernate"><a href="#MyBatis-vs-Hibernate" class="headerlink" title="MyBatis vs. Hibernate"></a>MyBatis vs. Hibernate</h3><p>MyBatis 和 Hibernate 都是 Java 世界中比较流行的 ORM 框架。我们应该了解其各自的优势，根据项目的需要去抉择在开发中使用哪个框架。</p>
<p><strong>Mybatis 优势</strong></p>
<ul>
<li>MyBatis 可以进行更为细致的 SQL 优化，可以减少查询字段。</li>
<li>MyBatis 容易掌握，而 Hibernate 门槛较高。</li>
</ul>
<p><strong>Hibernate 优势</strong></p>
<ul>
<li>Hibernate 的 DAO 层开发比 MyBatis 简单，Mybatis 需要维护 SQL 和结果映射。</li>
<li>Hibernate 对对象的维护和缓存要比 MyBatis 好，对增删改查的对象的维护要方便。</li>
<li>Hibernate 数据库移植性很好，MyBatis 的数据库移植性不好，不同的数据库需要写不同 SQL。</li>
<li>Hibernate 有更好的二级缓存机制，可以使用第三方缓存。MyBatis 本身提供的缓存机制不佳。</li>
</ul>
<h2 id="快速入门"><a href="#快速入门" class="headerlink" title="快速入门"></a>快速入门</h2><blockquote>
<p>这里，我将以一个入门级的示例来演示 Mybatis 是如何工作的。</p>
<p>注：本文后面章节中的原理、源码部分也将基于这个示例来进行讲解。</p>
</blockquote>
<h3 id="数据库准备"><a href="#数据库准备" class="headerlink" title="数据库准备"></a>数据库准备</h3><p>在本示例中，需要针对一张用户表进行 CRUD 操作。其数据模型如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> <span class="keyword">user</span> (</span><br><span class="line">    id      <span class="type">BIGINT</span>(<span class="number">10</span>) UNSIGNED <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;Id&#x27;</span>,</span><br><span class="line">    name    <span class="type">VARCHAR</span>(<span class="number">10</span>)         <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span> COMMENT <span class="string">&#x27;用户名&#x27;</span>,</span><br><span class="line">    age     <span class="type">INT</span>(<span class="number">3</span>)              <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span> COMMENT <span class="string">&#x27;年龄&#x27;</span>,</span><br><span class="line">    address <span class="type">VARCHAR</span>(<span class="number">32</span>)         <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span> COMMENT <span class="string">&#x27;地址&#x27;</span>,</span><br><span class="line">    email   <span class="type">VARCHAR</span>(<span class="number">32</span>)         <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span> COMMENT <span class="string">&#x27;邮件&#x27;</span>,</span><br><span class="line">    <span class="keyword">PRIMARY</span> KEY (id)</span><br><span class="line">) COMMENT <span class="operator">=</span> <span class="string">&#x27;用户表&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">user</span> (name, age, address, email)</span><br><span class="line"><span class="keyword">VALUES</span> (<span class="string">&#x27;张三&#x27;</span>, <span class="number">18</span>, <span class="string">&#x27;北京&#x27;</span>, <span class="string">&#x27;xxx@163.com&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">user</span> (name, age, address, email)</span><br><span class="line"><span class="keyword">VALUES</span> (<span class="string">&#x27;李四&#x27;</span>, <span class="number">19</span>, <span class="string">&#x27;上海&#x27;</span>, <span class="string">&#x27;xxx@163.com&#x27;</span>);</span><br></pre></td></tr></table></figure>

<h3 id="添加-Mybatis"><a href="#添加-Mybatis" class="headerlink" title="添加 Mybatis"></a>添加 Mybatis</h3><p>如果使用 Maven 来构建项目，则需将下面的依赖代码置于 pom.xml 文件中：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>x.x.x<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="Mybatis-配置"><a href="#Mybatis-配置" class="headerlink" title="Mybatis 配置"></a>Mybatis 配置</h3><p>XML 配置文件中包含了对 MyBatis 系统的核心设置，包括获取数据库连接实例的数据源（DataSource）以及决定事务作用域和控制方式的事务管理器（TransactionManager）。</p>
<p>本示例中只是给出最简化的配置。</p>
<p>【示例】mybatis-config.xml 文件</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">configuration</span> <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD Config 3.0//EN&quot;</span></span></span><br><span class="line"><span class="meta">  <span class="string">&quot;http://mybatis.org/dtd/mybatis-3-config.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">environments</span> <span class="attr">default</span>=<span class="string">&quot;development&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">environment</span> <span class="attr">id</span>=<span class="string">&quot;development&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">transactionManager</span> <span class="attr">type</span>=<span class="string">&quot;JDBC&quot;</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">dataSource</span> <span class="attr">type</span>=<span class="string">&quot;POOLED&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;driver&quot;</span> <span class="attr">value</span>=<span class="string">&quot;com.mysql.cj.jdbc.Driver&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;url&quot;</span></span></span><br><span class="line"><span class="tag">                  <span class="attr">value</span>=<span class="string">&quot;jdbc:mysql://127.0.0.1:3306/spring_tutorial?serverTimezone=UTC&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">value</span>=<span class="string">&quot;root&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> <span class="attr">value</span>=<span class="string">&quot;root&quot;</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">dataSource</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">environment</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">environments</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mappers</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mapper</span> <span class="attr">resource</span>=<span class="string">&quot;mybatis/mapper/UserMapper.xml&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">mappers</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>说明：上面的配置文件中仅仅指定了数据源连接方式和 User 表的映射配置文件。</p>
</blockquote>
<h3 id="Mapper"><a href="#Mapper" class="headerlink" title="Mapper"></a>Mapper</h3><h4 id="Mapper-xml"><a href="#Mapper-xml" class="headerlink" title="Mapper.xml"></a>Mapper.xml</h4><p>个人理解，Mapper.xml 文件可以看做是 Mybatis 的 JDBC SQL 模板。</p>
<p>【示例】UserMapper.xml 文件</p>
<p>下面是一个通过 Mybatis Generator 自动生成的完整的 Mapper 文件。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mapper</span> <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span> <span class="string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;io.github.dunwu.spring.orm.mapper.UserMapper&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">id</span>=<span class="string">&quot;BaseResultMap&quot;</span> <span class="attr">type</span>=<span class="string">&quot;io.github.dunwu.spring.orm.entity.User&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span> <span class="attr">column</span>=<span class="string">&quot;id&quot;</span> <span class="attr">jdbcType</span>=<span class="string">&quot;BIGINT&quot;</span> <span class="attr">property</span>=<span class="string">&quot;id&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">&quot;name&quot;</span> <span class="attr">jdbcType</span>=<span class="string">&quot;VARCHAR&quot;</span> <span class="attr">property</span>=<span class="string">&quot;name&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">&quot;age&quot;</span> <span class="attr">jdbcType</span>=<span class="string">&quot;INTEGER&quot;</span> <span class="attr">property</span>=<span class="string">&quot;age&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">&quot;address&quot;</span> <span class="attr">jdbcType</span>=<span class="string">&quot;VARCHAR&quot;</span> <span class="attr">property</span>=<span class="string">&quot;address&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">&quot;email&quot;</span> <span class="attr">jdbcType</span>=<span class="string">&quot;VARCHAR&quot;</span> <span class="attr">property</span>=<span class="string">&quot;email&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">delete</span> <span class="attr">id</span>=<span class="string">&quot;deleteByPrimaryKey&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;java.lang.Long&quot;</span>&gt;</span></span><br><span class="line">    delete from user</span><br><span class="line">    where id = #&#123;id,jdbcType=BIGINT&#125;</span><br><span class="line">  <span class="tag">&lt;/<span class="name">delete</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">&quot;insert&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;io.github.dunwu.spring.orm.entity.User&quot;</span>&gt;</span></span><br><span class="line">    insert into user (id, name, age,</span><br><span class="line">      address, email)</span><br><span class="line">    values (#&#123;id,jdbcType=BIGINT&#125;, #&#123;name,jdbcType=VARCHAR&#125;, #&#123;age,jdbcType=INTEGER&#125;,</span><br><span class="line">      #&#123;address,jdbcType=VARCHAR&#125;, #&#123;email,jdbcType=VARCHAR&#125;)</span><br><span class="line">  <span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">&quot;updateByPrimaryKey&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;io.github.dunwu.spring.orm.entity.User&quot;</span>&gt;</span></span><br><span class="line">    update user</span><br><span class="line">    set name = #&#123;name,jdbcType=VARCHAR&#125;,</span><br><span class="line">      age = #&#123;age,jdbcType=INTEGER&#125;,</span><br><span class="line">      address = #&#123;address,jdbcType=VARCHAR&#125;,</span><br><span class="line">      email = #&#123;email,jdbcType=VARCHAR&#125;</span><br><span class="line">    where id = #&#123;id,jdbcType=BIGINT&#125;</span><br><span class="line">  <span class="tag">&lt;/<span class="name">update</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;selectByPrimaryKey&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;java.lang.Long&quot;</span> <span class="attr">resultMap</span>=<span class="string">&quot;BaseResultMap&quot;</span>&gt;</span></span><br><span class="line">    select id, name, age, address, email</span><br><span class="line">    from user</span><br><span class="line">    where id = #&#123;id,jdbcType=BIGINT&#125;</span><br><span class="line">  <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;selectAll&quot;</span> <span class="attr">resultMap</span>=<span class="string">&quot;BaseResultMap&quot;</span>&gt;</span></span><br><span class="line">    select id, name, age, address, email</span><br><span class="line">    from user</span><br><span class="line">  <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="Mapper-java"><a href="#Mapper-java" class="headerlink" title="Mapper.java"></a>Mapper.java</h4><p>Mapper.java 文件是 Mapper.xml 对应的 Java 对象。</p>
<p>【示例】UserMapper.java 文件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserMapper</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="title function_">deleteByPrimaryKey</span><span class="params">(Long id)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="title function_">insert</span><span class="params">(User record)</span>;</span><br><span class="line"></span><br><span class="line">    User <span class="title function_">selectByPrimaryKey</span><span class="params">(Long id)</span>;</span><br><span class="line"></span><br><span class="line">    List&lt;User&gt; <span class="title function_">selectAll</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="title function_">updateByPrimaryKey</span><span class="params">(User record)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对比 UserMapper.java 和 UserMapper.xml 文件，不难发现：</p>
<p>UserMapper.java 中的方法和 UserMapper.xml 的 CRUD 语句元素（ <code>&lt;insert&gt;</code>、<code>&lt;delete&gt;</code>、<code>&lt;update&gt;</code>、<code>&lt;select&gt;</code>）存在一一对应关系。</p>
<p>在 Mybatis 中，正是通过方法的全限定名，将二者绑定在一起。</p>
<h4 id="数据实体-java"><a href="#数据实体-java" class="headerlink" title="数据实体.java"></a>数据实体.java</h4><p>【示例】User.java 文件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String address;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String email;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>&lt;insert&gt;</code>、<code>&lt;delete&gt;</code>、<code>&lt;update&gt;</code>、<code>&lt;select&gt;</code> 的 <code>parameterType</code> 属性以及 <code>&lt;resultMap&gt;</code> 的 <code>type</code> 属性都可能会绑定到数据实体。这样就可以把 JDBC 操作的输入输出和 JavaBean 结合起来，更加方便、易于理解。</p>
<h3 id="测试程序"><a href="#测试程序" class="headerlink" title="测试程序"></a>测试程序</h3><p>【示例】MybatisDemo.java 文件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MybatisDemo</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 1. 加载 mybatis 配置文件，创建 SqlSessionFactory</span></span><br><span class="line">        <span class="comment">// 注：在实际的应用中，SqlSessionFactory 应该是单例</span></span><br><span class="line">        <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> Resources.getResourceAsStream(<span class="string">&quot;mybatis/mybatis-config.xml&quot;</span>);</span><br><span class="line">        <span class="type">SqlSessionFactoryBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SqlSessionFactoryBuilder</span>();</span><br><span class="line">        <span class="type">SqlSessionFactory</span> <span class="variable">factory</span> <span class="operator">=</span> builder.build(inputStream);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 创建一个 SqlSession 实例，进行数据库操作</span></span><br><span class="line">        <span class="type">SqlSession</span> <span class="variable">sqlSession</span> <span class="operator">=</span> factory.openSession();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. Mapper 映射并执行</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">params</span> <span class="operator">=</span> <span class="number">1L</span>;</span><br><span class="line">        List&lt;User&gt; list = sqlSession.selectList(<span class="string">&quot;io.github.dunwu.spring.orm.mapper.UserMapper.selectByPrimaryKey&quot;</span>, params);</span><br><span class="line">        <span class="keyword">for</span> (User user : list) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;user name: &quot;</span> + user.getName());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 输出：user name: 张三</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>说明：</p>
<p><code>SqlSession</code> 接口是 Mybatis API 核心中的核心，它代表了 Mybatis 和数据库的一次完整会话。</p>
<ul>
<li>Mybatis 会解析配置，并根据配置创建 <code>SqlSession</code> 。</li>
<li>然后，Mybatis 将 Mapper 映射为 <code>SqlSession</code>，然后传递参数，执行 SQL 语句并获取结果。</li>
</ul>
</blockquote>
<h2 id="Mybatis-xml-配置"><a href="#Mybatis-xml-配置" class="headerlink" title="Mybatis xml 配置"></a>Mybatis xml 配置</h2><blockquote>
<p>配置的详细内容请参考：“ <a target="_blank" rel="noopener" href="http://www.mybatis.org/mybatis-3/zh/configuration.html">Mybatis 官方文档之配置</a> ” 。</p>
</blockquote>
<p>MyBatis 的配置文件包含了会深深影响 MyBatis 行为的设置和属性信息。主要配置项有以下：</p>
<ul>
<li><a target="_blank" rel="noopener" href="http://www.mybatis.org/mybatis-3/zh/configuration.html#properties">properties（属性）</a></li>
<li><a target="_blank" rel="noopener" href="http://www.mybatis.org/mybatis-3/zh/configuration.html#settings">settings（设置）</a></li>
<li><a target="_blank" rel="noopener" href="http://www.mybatis.org/mybatis-3/zh/configuration.html#typeAliases">typeAliases（类型别名）</a></li>
<li><a target="_blank" rel="noopener" href="http://www.mybatis.org/mybatis-3/zh/configuration.html#typeHandlers">typeHandlers（类型处理器）</a></li>
<li><a target="_blank" rel="noopener" href="http://www.mybatis.org/mybatis-3/zh/configuration.html#objectFactory">objectFactory（对象工厂）</a></li>
<li><a target="_blank" rel="noopener" href="http://www.mybatis.org/mybatis-3/zh/configuration.html#plugins">plugins（插件）</a></li>
<li><a target="_blank" rel="noopener" href="http://www.mybatis.org/mybatis-3/zh/configuration.html#environments">environments（环境配置）</a><ul>
<li>environment（环境变量）<ul>
<li>transactionManager（事务管理器）</li>
<li>dataSource（数据源）</li>
</ul>
</li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="http://www.mybatis.org/mybatis-3/zh/configuration.html#databaseIdProvider">databaseIdProvider（数据库厂商标识）</a></li>
<li><a target="_blank" rel="noopener" href="http://www.mybatis.org/mybatis-3/zh/configuration.html#mappers">mappers（映射器）</a></li>
</ul>
<h2 id="Mybatis-xml-映射器"><a href="#Mybatis-xml-映射器" class="headerlink" title="Mybatis xml 映射器"></a>Mybatis xml 映射器</h2><blockquote>
<p>SQL XML 映射文件详细内容请参考：“ <a target="_blank" rel="noopener" href="http://www.mybatis.org/mybatis-3/zh/sqlmap-xml.html">Mybatis 官方文档之 XML 映射文件</a> ”。</p>
</blockquote>
<p>XML 映射文件只有几个顶级元素：</p>
<ul>
<li><code>cache</code> – 对给定命名空间的缓存配置。</li>
<li><code>cache-ref</code> – 对其他命名空间缓存配置的引用。</li>
<li><code>resultMap</code> – 是最复杂也是最强大的元素，用来描述如何从数据库结果集中来加载对象。</li>
<li><del><code>parameterMap</code> – 已被废弃！老式风格的参数映射。更好的办法是使用内联参数，此元素可能在将来被移除。文档中不会介绍此元素。</del></li>
<li><code>sql</code> – 可被其他语句引用的可重用语句块。</li>
<li><code>insert</code> – 映射插入语句</li>
<li><code>update</code> – 映射更新语句</li>
<li><code>delete</code> – 映射删除语句</li>
<li><code>select</code> – 映射查询语句</li>
</ul>
<h2 id="Mybatis-扩展"><a href="#Mybatis-扩展" class="headerlink" title="Mybatis 扩展"></a>Mybatis 扩展</h2><h3 id="Mybatis-类型处理器"><a href="#Mybatis-类型处理器" class="headerlink" title="Mybatis 类型处理器"></a>Mybatis 类型处理器</h3><p>MyBatis 在设置预处理语句（PreparedStatement）中的参数或从结果集中取出一个值时， 都会用类型处理器将获取到的值以合适的方式转换成 Java 类型。下表描述了一些默认的类型处理器。</p>
<p>从 3.4.5 开始，MyBatis 默认支持 JSR-310（日期和时间 API） 。</p>
<p>你可以重写已有的类型处理器或创建你自己的类型处理器来处理不支持的或非标准的类型。 具体做法为：实现 <code>org.apache.ibatis.type.TypeHandler</code> 接口， 或继承一个很便利的类 <code>org.apache.ibatis.type.BaseTypeHandler</code>， 并且可以（可选地）将它映射到一个 JDBC 类型。比如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ExampleTypeHandler.java</span></span><br><span class="line"><span class="meta">@MappedJdbcTypes(JdbcType.VARCHAR)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ExampleTypeHandler</span> <span class="keyword">extends</span> <span class="title class_">BaseTypeHandler</span>&lt;String&gt; &#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setNonNullParameter</span><span class="params">(PreparedStatement ps, <span class="type">int</span> i, String parameter, JdbcType jdbcType)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">    ps.setString(i, parameter);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> String <span class="title function_">getNullableResult</span><span class="params">(ResultSet rs, String columnName)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">    <span class="keyword">return</span> rs.getString(columnName);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> String <span class="title function_">getNullableResult</span><span class="params">(ResultSet rs, <span class="type">int</span> columnIndex)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">    <span class="keyword">return</span> rs.getString(columnIndex);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> String <span class="title function_">getNullableResult</span><span class="params">(CallableStatement cs, <span class="type">int</span> columnIndex)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">    <span class="keyword">return</span> cs.getString(columnIndex);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- mybatis-config.xml --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">typeHandlers</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">typeHandler</span> <span class="attr">handler</span>=<span class="string">&quot;org.mybatis.example.ExampleTypeHandler&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">typeHandlers</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>使用上述的类型处理器将会覆盖已有的处理 Java String 类型的属性以及 VARCHAR 类型的参数和结果的类型处理器。 要注意 MyBatis 不会通过检测数据库元信息来决定使用哪种类型，所以你必须在参数和结果映射中指明字段是 VARCHAR 类型， 以使其能够绑定到正确的类型处理器上。这是因为 MyBatis 直到语句被执行时才清楚数据类型。</p>
<h3 id="Mybatis-插件"><a href="#Mybatis-插件" class="headerlink" title="Mybatis 插件"></a>Mybatis 插件</h3><p>MyBatis 允许你在映射语句执行过程中的某一点进行拦截调用。默认情况下，MyBatis 允许使用插件来拦截的方法调用包括：</p>
<ul>
<li>Executor (update, query, flushStatements, commit, rollback, getTransaction, close, isClosed)</li>
<li>ParameterHandler (getParameterObject, setParameters)</li>
<li>ResultSetHandler (handleResultSets, handleOutputParameters)</li>
<li>StatementHandler (prepare, parameterize, batch, update, query)</li>
</ul>
<p>这些类中方法的细节可以通过查看每个方法的签名来发现，或者直接查看 MyBatis 发行包中的源代码。 如果你想做的不仅仅是监控方法的调用，那么你最好相当了解要重写的方法的行为。 因为在试图修改或重写已有方法的行为时，很可能会破坏 MyBatis 的核心模块。 这些都是更底层的类和方法，所以使用插件的时候要特别当心。</p>
<p>通过 MyBatis 提供的强大机制，使用插件是非常简单的，只需实现 Interceptor 接口，并指定想要拦截的方法签名即可。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ExamplePlugin.java</span></span><br><span class="line"><span class="meta">@Intercepts(&#123;@Signature(</span></span><br><span class="line"><span class="meta">  type= Executor.class,</span></span><br><span class="line"><span class="meta">  method = &quot;update&quot;,</span></span><br><span class="line"><span class="meta">  args = &#123;MappedStatement.class,Object.class&#125;)&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ExamplePlugin</span> <span class="keyword">implements</span> <span class="title class_">Interceptor</span> &#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="type">Properties</span> <span class="variable">properties</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Properties</span>();</span><br><span class="line">  <span class="keyword">public</span> Object <span class="title function_">intercept</span><span class="params">(Invocation invocation)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">    <span class="comment">// implement pre processing if need</span></span><br><span class="line">    <span class="type">Object</span> <span class="variable">returnObject</span> <span class="operator">=</span> invocation.proceed();</span><br><span class="line">    <span class="comment">// implement post processing if need</span></span><br><span class="line">    <span class="keyword">return</span> returnObject;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setProperties</span><span class="params">(Properties properties)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.properties = properties;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- mybatis-config.xml --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">plugin</span> <span class="attr">interceptor</span>=<span class="string">&quot;org.mybatis.example.ExamplePlugin&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;someProperty&quot;</span> <span class="attr">value</span>=<span class="string">&quot;100&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>上面的插件将会拦截在 Executor 实例中所有的 “update” 方法调用， 这里的 Executor 是负责执行底层映射语句的内部对象。</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><strong>官方</strong><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/mybatis/mybatis-3">Mybatis Github</a></li>
<li><a target="_blank" rel="noopener" href="http://www.mybatis.org/mybatis-3/">Mybatis 官网</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/mybatis/generator">MyBatis 官方代码生成（mybatis-generator）</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/mybatis/spring">MyBatis 官方集成 Spring（mybatis-spring）</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/mybatis/spring-boot-starter">Mybatis 官方集成 Spring Boot（mybatis-spring-boot）</a></li>
</ul>
</li>
<li><strong>扩展插件</strong><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/baomidou/mybatis-plus">MyBatis-Plus</a> - CRUD 扩展插件、代码生成器、分页器等多功能</li>
<li><a target="_blank" rel="noopener" href="https://github.com/abel533/Mapper">Mapper</a> - CRUD 扩展插件</li>
<li><a target="_blank" rel="noopener" href="https://github.com/pagehelper/Mybatis-PageHelper">Mybatis-PageHelper</a> - Mybatis 通用分页插件</li>
</ul>
</li>
<li><strong>文章</strong><ul>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/luanlouis/article/details/40422941">深入理解 mybatis 原理</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/tuguangquan/mybatis">mybatis 源码中文注释</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/isea533/article/details/42102297">MyBatis Generator 详解</a></li>
<li><a target="_blank" rel="noopener" href="https://juejin.im/post/5aa646cdf265da237e095da1">Mybatis 常见面试题</a></li>
<li><a target="_blank" rel="noopener" href="https://juejin.im/post/5cee8b61e51d455d88219ea4">Mybatis 中强大的 resultMap</a></li>
</ul>
</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://dunwu.github.io/blog/pages/d55184/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/uploads/avatar.gif">
      <meta itemprop="name" content="钝悟 ◾ Dunwu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dunwu Blog">
      <meta itemprop="description" content="钝悟的个人博客">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Dunwu Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/pages/d55184/" class="post-title-link" itemprop="url">Mybatis原理</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-02-17 22:34:30" itemprop="dateCreated datePublished" datetime="2022-02-17T22:34:30+08:00">2022-02-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-01-27 23:32:48" itemprop="dateModified" datetime="2024-01-27T23:32:48+08:00">2024-01-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/%E6%A1%86%E6%9E%B6/" itemprop="url" rel="index"><span itemprop="name">框架</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/%E6%A1%86%E6%9E%B6/ORM/" itemprop="url" rel="index"><span itemprop="name">ORM</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>24k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>22 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Mybatis-原理"><a href="#Mybatis-原理" class="headerlink" title="Mybatis 原理"></a>Mybatis 原理</h1><blockquote>
<p>Mybatis 的前身就是 iBatis ，是一款优秀的持久层框架，它支持自定义 SQL、存储过程以及高级映射。本文以一个 Mybatis 完整示例为切入点，结合 Mybatis 底层源码分析，图文并茂的讲解 Mybatis 的核心工作机制。</p>
</blockquote>
<h2 id="Mybatis-完整示例"><a href="#Mybatis-完整示例" class="headerlink" title="Mybatis 完整示例"></a>Mybatis 完整示例</h2><blockquote>
<p>这里，我将以一个入门级的示例来演示 Mybatis 是如何工作的。</p>
<p>注：本文后面章节中的原理、源码部分也将基于这个示例来进行讲解。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/dunwu/spring-tutorial/blob/master/codes/data/spring-data-mybatis/src/main/java/io/github/dunwu/spring/orm/MybatisDemo.java">完整示例源码地址</a></p>
</blockquote>
<h3 id="数据库准备"><a href="#数据库准备" class="headerlink" title="数据库准备"></a>数据库准备</h3><p>在本示例中，需要针对一张用户表进行 CRUD 操作。其数据模型如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> <span class="keyword">user</span> (</span><br><span class="line">    id      <span class="type">BIGINT</span>(<span class="number">10</span>) UNSIGNED <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;Id&#x27;</span>,</span><br><span class="line">    name    <span class="type">VARCHAR</span>(<span class="number">10</span>)         <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span> COMMENT <span class="string">&#x27;用户名&#x27;</span>,</span><br><span class="line">    age     <span class="type">INT</span>(<span class="number">3</span>)              <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span> COMMENT <span class="string">&#x27;年龄&#x27;</span>,</span><br><span class="line">    address <span class="type">VARCHAR</span>(<span class="number">32</span>)         <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span> COMMENT <span class="string">&#x27;地址&#x27;</span>,</span><br><span class="line">    email   <span class="type">VARCHAR</span>(<span class="number">32</span>)         <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span> COMMENT <span class="string">&#x27;邮件&#x27;</span>,</span><br><span class="line">    <span class="keyword">PRIMARY</span> KEY (id)</span><br><span class="line">) COMMENT <span class="operator">=</span> <span class="string">&#x27;用户表&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">user</span> (name, age, address, email)</span><br><span class="line"><span class="keyword">VALUES</span> (<span class="string">&#x27;张三&#x27;</span>, <span class="number">18</span>, <span class="string">&#x27;北京&#x27;</span>, <span class="string">&#x27;xxx@163.com&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">user</span> (name, age, address, email)</span><br><span class="line"><span class="keyword">VALUES</span> (<span class="string">&#x27;李四&#x27;</span>, <span class="number">19</span>, <span class="string">&#x27;上海&#x27;</span>, <span class="string">&#x27;xxx@163.com&#x27;</span>);</span><br></pre></td></tr></table></figure>

<h3 id="添加-Mybatis"><a href="#添加-Mybatis" class="headerlink" title="添加 Mybatis"></a>添加 Mybatis</h3><p>如果使用 Maven 来构建项目，则需将下面的依赖代码置于 pom.xml 文件中：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.Mybatis<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>Mybatis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>x.x.x<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="Mybatis-配置"><a href="#Mybatis-配置" class="headerlink" title="Mybatis 配置"></a>Mybatis 配置</h3><p>XML 配置文件中包含了对 Mybatis 系统的核心设置，包括获取数据库连接实例的数据源（DataSource）以及决定事务作用域和控制方式的事务管理器（TransactionManager）。</p>
<p>本示例中只是给出最简化的配置。</p>
<p>【示例】Mybatis-config.xml 文件</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">configuration</span> <span class="keyword">PUBLIC</span> <span class="string">&quot;-//Mybatis.org//DTD Config 3.0//EN&quot;</span></span></span><br><span class="line"><span class="meta">  <span class="string">&quot;http://Mybatis.org/dtd/Mybatis-3-config.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">environments</span> <span class="attr">default</span>=<span class="string">&quot;development&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">environment</span> <span class="attr">id</span>=<span class="string">&quot;development&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">transactionManager</span> <span class="attr">type</span>=<span class="string">&quot;JDBC&quot;</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">dataSource</span> <span class="attr">type</span>=<span class="string">&quot;POOLED&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;driver&quot;</span> <span class="attr">value</span>=<span class="string">&quot;com.mysql.cj.jdbc.Driver&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;url&quot;</span></span></span><br><span class="line"><span class="tag">                  <span class="attr">value</span>=<span class="string">&quot;jdbc:mysql://127.0.0.1:3306/spring_tutorial?serverTimezone=UTC&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">value</span>=<span class="string">&quot;root&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> <span class="attr">value</span>=<span class="string">&quot;root&quot;</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">dataSource</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">environment</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">environments</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mappers</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mapper</span> <span class="attr">resource</span>=<span class="string">&quot;Mybatis/mapper/UserMapper.xml&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">mappers</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>说明：上面的配置文件中仅仅指定了数据源连接方式和 User 表的映射配置文件。</p>
</blockquote>
<h3 id="Mapper"><a href="#Mapper" class="headerlink" title="Mapper"></a>Mapper</h3><h4 id="Mapper-xml"><a href="#Mapper-xml" class="headerlink" title="Mapper.xml"></a>Mapper.xml</h4><p>个人理解，Mapper.xml 文件可以看做是 Mybatis 的 JDBC SQL 模板。</p>
<p>【示例】UserMapper.xml 文件</p>
<p>下面是一个通过 Mybatis Generator 自动生成的完整的 Mapper 文件。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mapper</span> <span class="keyword">PUBLIC</span> <span class="string">&quot;-//Mybatis.org//DTD Mapper 3.0//EN&quot;</span> <span class="string">&quot;http://Mybatis.org/dtd/Mybatis-3-mapper.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;io.github.dunwu.spring.orm.mapper.UserMapper&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">id</span>=<span class="string">&quot;BaseResultMap&quot;</span> <span class="attr">type</span>=<span class="string">&quot;io.github.dunwu.spring.orm.entity.User&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span> <span class="attr">column</span>=<span class="string">&quot;id&quot;</span> <span class="attr">jdbcType</span>=<span class="string">&quot;BIGINT&quot;</span> <span class="attr">property</span>=<span class="string">&quot;id&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">&quot;name&quot;</span> <span class="attr">jdbcType</span>=<span class="string">&quot;VARCHAR&quot;</span> <span class="attr">property</span>=<span class="string">&quot;name&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">&quot;age&quot;</span> <span class="attr">jdbcType</span>=<span class="string">&quot;INTEGER&quot;</span> <span class="attr">property</span>=<span class="string">&quot;age&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">&quot;address&quot;</span> <span class="attr">jdbcType</span>=<span class="string">&quot;VARCHAR&quot;</span> <span class="attr">property</span>=<span class="string">&quot;address&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">&quot;email&quot;</span> <span class="attr">jdbcType</span>=<span class="string">&quot;VARCHAR&quot;</span> <span class="attr">property</span>=<span class="string">&quot;email&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">delete</span> <span class="attr">id</span>=<span class="string">&quot;deleteByPrimaryKey&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;java.lang.Long&quot;</span>&gt;</span></span><br><span class="line">    delete from user</span><br><span class="line">    where id = #&#123;id,jdbcType=BIGINT&#125;</span><br><span class="line">  <span class="tag">&lt;/<span class="name">delete</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">&quot;insert&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;io.github.dunwu.spring.orm.entity.User&quot;</span>&gt;</span></span><br><span class="line">    insert into user (id, name, age,</span><br><span class="line">      address, email)</span><br><span class="line">    values (#&#123;id,jdbcType=BIGINT&#125;, #&#123;name,jdbcType=VARCHAR&#125;, #&#123;age,jdbcType=INTEGER&#125;,</span><br><span class="line">      #&#123;address,jdbcType=VARCHAR&#125;, #&#123;email,jdbcType=VARCHAR&#125;)</span><br><span class="line">  <span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">&quot;updateByPrimaryKey&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;io.github.dunwu.spring.orm.entity.User&quot;</span>&gt;</span></span><br><span class="line">    update user</span><br><span class="line">    set name = #&#123;name,jdbcType=VARCHAR&#125;,</span><br><span class="line">      age = #&#123;age,jdbcType=INTEGER&#125;,</span><br><span class="line">      address = #&#123;address,jdbcType=VARCHAR&#125;,</span><br><span class="line">      email = #&#123;email,jdbcType=VARCHAR&#125;</span><br><span class="line">    where id = #&#123;id,jdbcType=BIGINT&#125;</span><br><span class="line">  <span class="tag">&lt;/<span class="name">update</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;selectByPrimaryKey&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;java.lang.Long&quot;</span> <span class="attr">resultMap</span>=<span class="string">&quot;BaseResultMap&quot;</span>&gt;</span></span><br><span class="line">    select id, name, age, address, email</span><br><span class="line">    from user</span><br><span class="line">    where id = #&#123;id,jdbcType=BIGINT&#125;</span><br><span class="line">  <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;selectAll&quot;</span> <span class="attr">resultMap</span>=<span class="string">&quot;BaseResultMap&quot;</span>&gt;</span></span><br><span class="line">    select id, name, age, address, email</span><br><span class="line">    from user</span><br><span class="line">  <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="Mapper-java"><a href="#Mapper-java" class="headerlink" title="Mapper.java"></a>Mapper.java</h4><p>Mapper.java 文件是 Mapper.xml 对应的 Java 对象。</p>
<p>【示例】UserMapper.java 文件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserMapper</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="title function_">deleteByPrimaryKey</span><span class="params">(Long id)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="title function_">insert</span><span class="params">(User record)</span>;</span><br><span class="line"></span><br><span class="line">    User <span class="title function_">selectByPrimaryKey</span><span class="params">(Long id)</span>;</span><br><span class="line"></span><br><span class="line">    List&lt;User&gt; <span class="title function_">selectAll</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="title function_">updateByPrimaryKey</span><span class="params">(User record)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对比 UserMapper.java 和 UserMapper.xml 文件，不难发现：</p>
<p>UserMapper.java 中的方法和 UserMapper.xml 的 CRUD 语句元素（ <code>&lt;insert&gt;</code>、<code>&lt;delete&gt;</code>、<code>&lt;update&gt;</code>、<code>&lt;select&gt;</code>）存在一一对应关系。</p>
<p>在 Mybatis 中，正是通过方法的全限定名，将二者绑定在一起。</p>
<h4 id="数据实体-java"><a href="#数据实体-java" class="headerlink" title="数据实体.java"></a>数据实体.java</h4><p>【示例】User.java 文件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String address;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String email;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>&lt;insert&gt;</code>、<code>&lt;delete&gt;</code>、<code>&lt;update&gt;</code>、<code>&lt;select&gt;</code> 的 <code>parameterType</code> 属性以及 <code>&lt;resultMap&gt;</code> 的 <code>type</code> 属性都可能会绑定到数据实体。这样就可以把 JDBC 操作的输入输出和 JavaBean 结合起来，更加方便、易于理解。</p>
<h3 id="测试程序"><a href="#测试程序" class="headerlink" title="测试程序"></a>测试程序</h3><p>【示例】MybatisDemo.java 文件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MybatisDemo</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 1. 加载 Mybatis 配置文件，创建 SqlSessionFactory</span></span><br><span class="line">        <span class="comment">// 注：在实际的应用中，SqlSessionFactory 应该是单例</span></span><br><span class="line">        <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> Resources.getResourceAsStream(<span class="string">&quot;Mybatis/Mybatis-config.xml&quot;</span>);</span><br><span class="line">        <span class="type">SqlSessionFactoryBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SqlSessionFactoryBuilder</span>();</span><br><span class="line">        <span class="type">SqlSessionFactory</span> <span class="variable">factory</span> <span class="operator">=</span> builder.build(inputStream);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 创建一个 SqlSession 实例，进行数据库操作</span></span><br><span class="line">        <span class="type">SqlSession</span> <span class="variable">sqlSession</span> <span class="operator">=</span> factory.openSession();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. Mapper 映射并执行</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">params</span> <span class="operator">=</span> <span class="number">1L</span>;</span><br><span class="line">        List&lt;User&gt; list = sqlSession.selectList(<span class="string">&quot;io.github.dunwu.spring.orm.mapper.UserMapper.selectByPrimaryKey&quot;</span>, params);</span><br><span class="line">        <span class="keyword">for</span> (User user : list) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;user name: &quot;</span> + user.getName());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 输出：user name: 张三</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>说明：</p>
<p><code>SqlSession</code> 接口是 Mybatis API 核心中的核心，它代表了 Mybatis 和数据库的一次完整会话。</p>
<ul>
<li>Mybatis 会解析配置，并根据配置创建 <code>SqlSession</code> 。</li>
<li>然后，Mybatis 将 Mapper 映射为 <code>SqlSession</code>，然后传递参数，执行 SQL 语句并获取结果。</li>
</ul>
</blockquote>
<h2 id="Mybatis-生命周期"><a href="#Mybatis-生命周期" class="headerlink" title="Mybatis 生命周期"></a>Mybatis 生命周期</h2><p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/20210510113446.png" alt="img"></p>
<h3 id="SqlSessionFactoryBuilder"><a href="#SqlSessionFactoryBuilder" class="headerlink" title="SqlSessionFactoryBuilder"></a>SqlSessionFactoryBuilder</h3><h4 id="SqlSessionFactoryBuilder-的职责"><a href="#SqlSessionFactoryBuilder-的职责" class="headerlink" title="SqlSessionFactoryBuilder 的职责"></a>SqlSessionFactoryBuilder 的职责</h4><p><strong><code>SqlSessionFactoryBuilder</code> 负责创建 <code>SqlSessionFactory</code> 实例</strong>。<code>SqlSessionFactoryBuilder</code> 可以从 XML 配置文件或一个预先定制的 <code>Configuration</code> 的实例构建出 <code>SqlSessionFactory</code> 的实例。</p>
<p><code>Configuration</code> 类包含了对一个 <code>SqlSessionFactory</code> 实例你可能关心的所有内容。</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/20210508173040.png" alt="img"></p>
<p><code>SqlSessionFactoryBuilder</code> 应用了建造者设计模式，它有五个 <code>build</code> 方法，允许你通过不同的资源创建 <code>SqlSessionFactory</code> 实例。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">SqlSessionFactory <span class="title function_">build</span><span class="params">(InputStream inputStream)</span></span><br><span class="line">SqlSessionFactory <span class="title function_">build</span><span class="params">(InputStream inputStream, String environment)</span></span><br><span class="line">SqlSessionFactory <span class="title function_">build</span><span class="params">(InputStream inputStream, Properties properties)</span></span><br><span class="line">SqlSessionFactory <span class="title function_">build</span><span class="params">(InputStream inputStream, String env, Properties props)</span></span><br><span class="line">SqlSessionFactory <span class="title function_">build</span><span class="params">(Configuration config)</span></span><br></pre></td></tr></table></figure>

<h4 id="SqlSessionFactoryBuilder-的生命周期"><a href="#SqlSessionFactoryBuilder-的生命周期" class="headerlink" title="SqlSessionFactoryBuilder 的生命周期"></a>SqlSessionFactoryBuilder 的生命周期</h4><p><code>SqlSessionFactoryBuilder</code> 可以被实例化、使用和丢弃，一旦创建了 <code>SqlSessionFactory</code>，就不再需要它了。 因此 <code>SqlSessionFactoryBuilder</code> 实例的最佳作用域是方法作用域（也就是局部方法变量）。你可以重用 <code>SqlSessionFactoryBuilder</code> 来创建多个 <code>SqlSessionFactory</code> 实例，但最好还是不要一直保留着它，以保证所有的 XML 解析资源可以被释放给更重要的事情。</p>
<h3 id="SqlSessionFactory"><a href="#SqlSessionFactory" class="headerlink" title="SqlSessionFactory"></a>SqlSessionFactory</h3><h4 id="SqlSessionFactory-职责"><a href="#SqlSessionFactory-职责" class="headerlink" title="SqlSessionFactory 职责"></a>SqlSessionFactory 职责</h4><p><strong><code>SqlSessionFactory</code> 负责创建 <code>SqlSession</code> 实例。</strong></p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/20210510105641.png" alt="img"></p>
<p><code>SqlSessionFactory</code> 应用了工厂设计模式，它提供了一组方法，用于创建 SqlSession 实例。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">SqlSession <span class="title function_">openSession</span><span class="params">()</span></span><br><span class="line">SqlSession <span class="title function_">openSession</span><span class="params">(<span class="type">boolean</span> autoCommit)</span></span><br><span class="line">SqlSession <span class="title function_">openSession</span><span class="params">(Connection connection)</span></span><br><span class="line">SqlSession <span class="title function_">openSession</span><span class="params">(TransactionIsolationLevel level)</span></span><br><span class="line">SqlSession <span class="title function_">openSession</span><span class="params">(ExecutorType execType, TransactionIsolationLevel level)</span></span><br><span class="line">SqlSession <span class="title function_">openSession</span><span class="params">(ExecutorType execType)</span></span><br><span class="line">SqlSession <span class="title function_">openSession</span><span class="params">(ExecutorType execType, <span class="type">boolean</span> autoCommit)</span></span><br><span class="line">SqlSession <span class="title function_">openSession</span><span class="params">(ExecutorType execType, Connection connection)</span></span><br><span class="line">Configuration <span class="title function_">getConfiguration</span><span class="params">()</span>;</span><br></pre></td></tr></table></figure>

<p>方法说明：</p>
<ul>
<li>默认的 <code>openSession()</code> 方法没有参数，它会创建具备如下特性的 <code>SqlSession</code>：<ul>
<li>事务作用域将会开启（也就是不自动提交）。</li>
<li>将由当前环境配置的 <code>DataSource</code> 实例中获取 <code>Connection</code> 对象。</li>
<li>事务隔离级别将会使用驱动或数据源的默认设置。</li>
<li>预处理语句不会被复用，也不会批量处理更新。</li>
</ul>
</li>
<li><code>TransactionIsolationLevel</code> 表示事务隔离级别，它对应着 JDBC 的五个事务隔离级别。</li>
<li><code>ExecutorType</code> 枚举类型定义了三个值:<ul>
<li><code>ExecutorType.SIMPLE</code>：该类型的执行器没有特别的行为。它为每个语句的执行创建一个新的预处理语句。</li>
<li><code>ExecutorType.REUSE</code>：该类型的执行器会复用预处理语句。</li>
<li><code>ExecutorType.BATCH</code>：该类型的执行器会批量执行所有更新语句，如果 SELECT 在多个更新中间执行，将在必要时将多条更新语句分隔开来，以方便理解。</li>
</ul>
</li>
</ul>
<h4 id="SqlSessionFactory-生命周期"><a href="#SqlSessionFactory-生命周期" class="headerlink" title="SqlSessionFactory 生命周期"></a>SqlSessionFactory 生命周期</h4><p><code>SqlSessionFactory</code> 应该以单例形式在应用的运行期间一直存在。</p>
<h3 id="SqlSession"><a href="#SqlSession" class="headerlink" title="SqlSession"></a>SqlSession</h3><h4 id="SqlSession-职责"><a href="#SqlSession-职责" class="headerlink" title="SqlSession 职责"></a>SqlSession 职责</h4><p><strong>Mybatis 的主要 Java 接口就是 <code>SqlSession</code>。它包含了所有执行语句，获取映射器和管理事务等方法。</strong></p>
<blockquote>
<p>详细内容可以参考：“ <a target="_blank" rel="noopener" href="http://www.mybatis.org/Mybatis-3/zh/java-api.html#sqlSessions">Mybatis 官方文档之 SqlSessions</a> ” 。</p>
</blockquote>
<p>SqlSession 类的方法可以按照下图进行大致分类：</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/20210510110638.png" alt="img"></p>
<h4 id="SqlSession-生命周期"><a href="#SqlSession-生命周期" class="headerlink" title="SqlSession 生命周期"></a>SqlSession 生命周期</h4><p><code>SqlSessions</code> 是由 <code>SqlSessionFactory</code> 实例创建的；而 <code>SqlSessionFactory</code> 是由 <code>SqlSessionFactoryBuilder</code> 创建的。</p>
<blockquote>
<p>🔔 注意：当 Mybatis 与一些依赖注入框架（如 Spring 或者 Guice）同时使用时，<code>SqlSessions</code> 将被依赖注入框架所创建，所以你不需要使用 <code>SqlSessionFactoryBuilder</code> 或者 <code>SqlSessionFactory</code>。</p>
</blockquote>
<p><strong>每个线程都应该有它自己的 <code>SqlSession</code> 实例。</strong></p>
<p><code>SqlSession</code> 的实例不是线程安全的，因此是不能被共享的，所以它的最佳的作用域是请求或方法作用域。 绝对不能将 <code>SqlSession</code> 实例的引用放在一个类的静态域，甚至一个类的实例变量也不行。 也绝不能将 <code>SqlSession</code> 实例的引用放在任何类型的托管作用域中，比如 Servlet 框架中的 <code>HttpSession</code>。 正确在 Web 中使用 <code>SqlSession</code> 的场景是：每次收到的 HTTP 请求，就可以打开一个 <code>SqlSession</code>，返回一个响应，就关闭它。</p>
<p>编程模式：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> (<span class="type">SqlSession</span> <span class="variable">session</span> <span class="operator">=</span> sqlSessionFactory.openSession()) &#123;</span><br><span class="line">  <span class="comment">// 你的应用逻辑代码</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="映射器"><a href="#映射器" class="headerlink" title="映射器"></a>映射器</h3><h4 id="映射器职责"><a href="#映射器职责" class="headerlink" title="映射器职责"></a>映射器职责</h4><p>映射器是一些由用户创建的、绑定 SQL 语句的接口。</p>
<p><code>SqlSession</code> 中的 <code>insert</code>、<code>update</code>、<code>delete</code> 和 <code>select</code> 方法都很强大，但也有些繁琐。更通用的方式是使用映射器类来执行映射语句。<strong>一个映射器类就是一个仅需声明与 <code>SqlSession</code> 方法相匹配的方法的接口类</strong>。</p>
<p>Mybatis 将配置文件中的每一个 <code>&lt;mapper&gt;</code> 节点抽象为一个 <code>Mapper</code> 接口，而这个接口中声明的方法和跟 <code>&lt;mapper&gt;</code> 节点中的 <code>&lt;select|update|delete|insert&gt;</code> 节点相对应，即 <code>&lt;select|update|delete|insert&gt;</code> 节点的 id 值为 Mapper 接口中的方法名称，<code>parameterType</code> 值表示 Mapper 对应方法的入参类型，而 <code>resultMap</code> 值则对应了 Mapper 接口表示的返回值类型或者返回结果集的元素类型。</p>
<p>Mybatis 会根据相应的接口声明的方法信息，通过动态代理机制生成一个 Mapper 实例；Mybatis 会根据这个方法的方法名和参数类型，确定 Statement Id，然后和 SqlSession 进行映射，底层还是通过 SqlSession 完成和数据库的交互。</p>
<p>下面的示例展示了一些方法签名以及它们是如何映射到 <code>SqlSession</code> 上的。</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/20210512111723.png" alt="img"></p>
<blockquote>
<p><strong>注意</strong></p>
<ul>
<li>映射器接口不需要去实现任何接口或继承自任何类。只要方法可以被唯一标识对应的映射语句就可以了。</li>
<li>映射器接口可以继承自其他接口。当使用 XML 来构建映射器接口时要保证语句被包含在合适的命名空间中。而且，唯一的限制就是你不能在两个继承关系的接口中拥有相同的方法签名（潜在的危险做法不可取）。</li>
</ul>
</blockquote>
<h4 id="映射器生命周期"><a href="#映射器生命周期" class="headerlink" title="映射器生命周期"></a>映射器生命周期</h4><p>映射器接口的实例是从 <code>SqlSession</code> 中获得的。因此从技术层面讲，任何映射器实例的最大作用域是和请求它们的 <code>SqlSession</code> 相同的。尽管如此，映射器实例的最佳作用域是方法作用域。 也就是说，映射器实例应该在调用它们的方法中被请求，用过之后即可丢弃。</p>
<p>编程模式：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> (<span class="type">SqlSession</span> <span class="variable">session</span> <span class="operator">=</span> sqlSessionFactory.openSession()) &#123;</span><br><span class="line">  <span class="type">BlogMapper</span> <span class="variable">mapper</span> <span class="operator">=</span> session.getMapper(BlogMapper.class);</span><br><span class="line">  <span class="comment">// 你的应用逻辑代码</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>映射器注解</strong></li>
</ul>
<p>Mybatis 是一个 XML 驱动的框架。配置信息是基于 XML 的，而且映射语句也是定义在 XML 中的。Mybatis 3 以后，支持注解配置。注解配置基于配置 API；而配置 API 基于 XML 配置。</p>
<p>Mybatis 支持诸如 <code>@Insert</code>、<code>@Update</code>、<code>@Delete</code>、<code>@Select</code>、<code>@Result</code> 等注解。</p>
<blockquote>
<p>详细内容请参考：<a target="_blank" rel="noopener" href="http://www.mybatis.org/Mybatis-3/zh/java-api.html#sqlSessions">Mybatis 官方文档之 sqlSessions</a>，其中列举了 Mybatis 支持的注解清单，以及基本用法。</p>
</blockquote>
<h2 id="Mybatis-的架构"><a href="#Mybatis-的架构" class="headerlink" title="Mybatis 的架构"></a>Mybatis 的架构</h2><p>从 Mybatis 代码实现的角度来看，Mybatis 的主要组件有以下几个：</p>
<ul>
<li><strong>SqlSession</strong> - 作为 Mybatis 工作的主要顶层 API，表示和数据库交互的会话，完成必要数据库增删改查功能。</li>
<li><strong>Executor</strong> - Mybatis 执行器，是 Mybatis 调度的核心，负责 SQL 语句的生成和查询缓存的维护。</li>
<li><strong>StatementHandler</strong> - 封装了 JDBC Statement 操作，负责对 JDBC statement 的操作，如设置参数、将 Statement 结果集转换成 List 集合。</li>
<li><strong>ParameterHandler</strong> - 负责对用户传递的参数转换成 JDBC Statement 所需要的参数。</li>
<li><strong>ResultSetHandler</strong> - 负责将 JDBC 返回的 ResultSet 结果集对象转换成 List 类型的集合。</li>
<li><strong>TypeHandler</strong> - 负责 java 数据类型和 jdbc 数据类型之间的映射和转换。</li>
<li><strong>MappedStatement</strong> - <code>MappedStatement</code> 维护了一条 <code>&lt;select|update|delete|insert&gt;</code> 节点的封装。</li>
<li><strong>SqlSource</strong> - 负责根据用户传递的 parameterObject，动态地生成 SQL 语句，将信息封装到 BoundSql 对象中，并返回。</li>
<li><strong>BoundSql</strong> - 表示动态生成的 SQL 语句以及相应的参数信息。</li>
<li><strong>Configuration</strong> - Mybatis 所有的配置信息都维持在 Configuration 对象之中。</li>
</ul>
<p>这些组件的架构层次如下：</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/20210512114852.png" alt="img"></p>
<h3 id="配置层"><a href="#配置层" class="headerlink" title="配置层"></a>配置层</h3><p>配置层决定了 Mybatis 的工作方式。</p>
<p>Mybatis 提供了两种配置方式：</p>
<ul>
<li>基于 XML 配置文件的方式</li>
<li>基于 Java API 的方式</li>
</ul>
<p><code>SqlSessionFactoryBuilder</code> 会根据配置创建 <code>SqlSessionFactory</code> ；</p>
<p><code>SqlSessionFactory</code> 负责创建 <code>SqlSessions</code> 。</p>
<h3 id="接口层"><a href="#接口层" class="headerlink" title="接口层"></a>接口层</h3><p>接口层负责和数据库交互的方式。</p>
<p>Mybatis 和数据库的交互有两种方式：</p>
<ul>
<li><strong>使用 SqlSession</strong>：SqlSession 封装了所有执行语句，获取映射器和管理事务的方法。<ul>
<li>用户只需要传入 Statement Id 和查询参数给 SqlSession 对象，就可以很方便的和数据库进行交互。</li>
<li>这种方式的缺点是不符合面向对象编程的范式。</li>
</ul>
</li>
<li><strong>使用 Mapper 接口</strong>：Mybatis 会根据相应的接口声明的方法信息，通过动态代理机制生成一个 Mapper 实例；Mybatis 会根据这个方法的方法名和参数类型，确定 Statement Id，然后和 SqlSession 进行映射，底层还是通过 SqlSession 完成和数据库的交互。</li>
</ul>
<h3 id="数据处理层"><a href="#数据处理层" class="headerlink" title="数据处理层"></a>数据处理层</h3><p>数据处理层可以说是 Mybatis 的核心，从大的方面上讲，它要完成两个功能：</p>
<ul>
<li>根据传参 <code>Statement</code> 和参数构建动态 SQL 语句<ul>
<li>动态语句生成可以说是 Mybatis 框架非常优雅的一个设计，Mybatis 通过传入的参数值，<strong>使用 Ognl 来动态地构造 SQL 语句</strong>，使得 Mybatis 有很强的灵活性和扩展性。</li>
<li>参数映射指的是对于 java 数据类型和 jdbc 数据类型之间的转换：这里有包括两个过程：查询阶段，我们要将 java 类型的数据，转换成 jdbc 类型的数据，通过 <code>preparedStatement.setXXX()</code> 来设值；另一个就是对 resultset 查询结果集的 jdbcType 数据转换成 java 数据类型。</li>
</ul>
</li>
<li>执行 SQL 语句以及处理响应结果集 ResultSet<ul>
<li>动态 SQL 语句生成之后，Mybatis 将执行 SQL 语句，并将可能返回的结果集转换成 <code>List&lt;E&gt;</code> 列表。</li>
<li>Mybatis 在对结果集的处理中，支持结果集关系一对多和多对一的转换，并且有两种支持方式，一种为嵌套查询语句的查询，还有一种是嵌套结果集的查询。</li>
</ul>
</li>
</ul>
<h3 id="框架支撑层"><a href="#框架支撑层" class="headerlink" title="框架支撑层"></a>框架支撑层</h3><ul>
<li><p><strong>事务管理机制</strong> - Mybatis 将事务抽象成了 Transaction 接口。Mybatis 的事务管理分为两种形式：</p>
<ul>
<li>使用 JDBC 的事务管理机制：即利用 <code>java.sql.Connection</code> 对象完成对事务的提交（<code>commit</code>）、回滚（<code>rollback</code>）、关闭（<code>close</code>）等。</li>
<li>使用 MANAGED 的事务管理机制：Mybatis 自身不会去实现事务管理，而是让程序的容器如（JBOSS，Weblogic）来实现对事务的管理。</li>
</ul>
</li>
<li><p><strong>连接池管理</strong></p>
</li>
<li><p><strong>SQL 语句的配置</strong> - 支持两种方式：</p>
<ul>
<li>xml 配置</li>
<li>注解配置</li>
</ul>
</li>
<li><p>缓存机制 - Mybatis 采用两级缓存结构</p>
<ul>
<li><strong>一级缓存是 Session 会话级别的缓存</strong> - 一级缓存又被称之为本地缓存。一般而言，一个 <code>SqlSession</code> 对象会使用一个 <code>Executor</code> 对象来完成会话操作，<code>Executor</code> 对象会维护一个 Cache 缓存，以提高查询性能。<ul>
<li>一级缓存的生命周期是 Session 会话级别的。</li>
</ul>
</li>
<li><strong>二级缓存是 Application 应用级别的缓存</strong> - 用户配置了 <code>&quot;cacheEnabled=true&quot;</code>，才会开启二级缓存。<ul>
<li>如果开启了二级缓存，<code>SqlSession</code> 会先使用 <code>CachingExecutor</code> 对象来处理查询请求。<code>CachingExecutor</code> 会在二级缓存中查看是否有匹配的数据，如果匹配，则直接返回缓存结果；如果缓存中没有，再交给真正的 <code>Executor</code> 对象来完成查询，之后 <code>CachingExecutor</code> 会将真正 <code>Executor</code> 返回的查询结果放置到缓存中，然后在返回给用户。</li>
<li>二级缓存的生命周期是应用级别的。</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/20210512185709.png" alt="img"></p>
<h2 id="SqlSession-内部工作机制"><a href="#SqlSession-内部工作机制" class="headerlink" title="SqlSession 内部工作机制"></a>SqlSession 内部工作机制</h2><p>从前文，我们已经了解了，Mybatis 封装了对数据库的访问，把对数据库的会话和事务控制放到了 SqlSession 对象中。那么具体是如何工作的呢？接下来，我们通过源码解读来进行分析。</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/20210512173437.png" alt="img"></p>
<p><code>SqlSession</code> 对于 insert、update、delete、select 的内部处理机制基本上大同小异。所以，接下来，我会以一次完整的 select 查询流程为例讲解 <code>SqlSession</code> 内部的工作机制。相信读者如果理解了 select 的处理流程，对于其他 CRUD 操作也能做到一通百通。</p>
<h3 id="SqlSession-子组件"><a href="#SqlSession-子组件" class="headerlink" title="SqlSession 子组件"></a>SqlSession 子组件</h3><p>前面的内容已经介绍了：SqlSession 是 Mybatis 的顶层接口，它提供了所有执行语句，获取映射器和管理事务等方法。</p>
<p>实际上，SqlSession 是通过聚合多个子组件，让每个子组件负责各自功能的方式，实现了任务的下发。</p>
<p>在了解各个子组件工作机制前，先让我们简单认识一下 SqlSession 的核心子组件。</p>
<h4 id="Executor"><a href="#Executor" class="headerlink" title="Executor"></a>Executor</h4><p>Executor 即执行器，它负责生成动态 SQL 以及管理缓存。</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/20210512150000.png" alt="img"></p>
<ul>
<li><code>Executor</code> 即执行器接口。</li>
<li><code>BaseExecutor</code> 是 <code>Executor</code> 的抽象类，它采用了模板方法设计模式，内置了一些共性方法，而将定制化方法留给子类去实现。</li>
<li><code>SimpleExecutor</code> 是最简单的执行器。它只会直接执行 SQL，不会做额外的事。</li>
<li><code>BatchExecutor</code> 是批处理执行器。它的作用是通过批处理来优化性能。值得注意的是，批量更新操作，由于内部有缓存机制，使用完后需要调用 <code>flushStatements</code> 来清除缓存。</li>
<li><code>ReuseExecutor</code> 是可重用的执行器。重用的对象是 <code>Statement</code>，也就是说，该执行器会缓存同一个 SQL 的 <code>Statement</code>，避免重复创建 <code>Statement</code>。其内部的实现是通过一个 <code>HashMap</code> 来维护 <code>Statement</code> 对象的。由于当前 <code>Map</code> 只在该 session 中有效，所以使用完后需要调用 <code>flushStatements</code> 来清除 Map。</li>
<li><code>CachingExecutor</code> 是缓存执行器。它只在启用二级缓存时才会用到。</li>
</ul>
<h4 id="StatementHandler"><a href="#StatementHandler" class="headerlink" title="StatementHandler"></a>StatementHandler</h4><p><code>StatementHandler</code> 对象负责设置 <code>Statement</code> 对象中的查询参数、处理 JDBC 返回的 resultSet，将 resultSet 加工为 List 集合返回。</p>
<p><code>StatementHandler</code> 的家族成员：</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/20210512160243.png" alt="img"></p>
<ul>
<li><code>StatementHandler</code> 是接口；</li>
<li><code>BaseStatementHandler</code> 是实现 <code>StatementHandler</code> 的抽象类，内置一些共性方法；</li>
<li><code>SimpleStatementHandler</code> 负责处理 <code>Statement</code>；</li>
<li><code>PreparedStatementHandler</code> 负责处理 <code>PreparedStatement</code>；</li>
<li><code>CallableStatementHandler</code> 负责处理 <code>CallableStatement</code>。</li>
<li><code>RoutingStatementHandler</code> 负责代理 <code>StatementHandler</code> 具体子类，根据 <code>Statement</code> 类型，选择实例化 <code>SimpleStatementHandler</code>、<code>PreparedStatementHandler</code>、<code>CallableStatementHandler</code>。</li>
</ul>
<h4 id="ParameterHandler"><a href="#ParameterHandler" class="headerlink" title="ParameterHandler"></a>ParameterHandler</h4><p><code>ParameterHandler</code> 负责将传入的 Java 对象转换 JDBC 类型对象，并为 <code>PreparedStatement</code> 的动态 SQL 填充数值。</p>
<p><code>ParameterHandler</code> 只有一个具体实现类，即 <code>DefaultParameterHandler</code>。</p>
<h4 id="ResultSetHandler"><a href="#ResultSetHandler" class="headerlink" title="ResultSetHandler"></a>ResultSetHandler</h4><p><code>ResultSetHandler</code> 负责两件事：</p>
<ul>
<li>处理 <code>Statement</code> 执行后产生的结果集，生成结果列表</li>
<li>处理存储过程执行后的输出参数</li>
</ul>
<p><code>ResultSetHandler</code> 只有一个具体实现类，即 <code>DefaultResultSetHandler</code>。</p>
<h4 id="TypeHandler"><a href="#TypeHandler" class="headerlink" title="TypeHandler"></a>TypeHandler</h4><p>TypeHandler 负责将 Java 对象类型和 JDBC 类型进行相互转换。</p>
<h3 id="SqlSession-和-Mapper"><a href="#SqlSession-和-Mapper" class="headerlink" title="SqlSession 和 Mapper"></a>SqlSession 和 Mapper</h3><p>先来回忆一下 Mybatis 完整示例章节的 测试程序部分的代码。</p>
<p>MybatisDemo.java 文件中的代码片段：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 2. 创建一个 SqlSession 实例，进行数据库操作</span></span><br><span class="line"><span class="type">SqlSession</span> <span class="variable">sqlSession</span> <span class="operator">=</span> factory.openSession();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. Mapper 映射并执行</span></span><br><span class="line"><span class="type">Long</span> <span class="variable">params</span> <span class="operator">=</span> <span class="number">1L</span>;</span><br><span class="line">List&lt;User&gt; list = sqlSession.selectList(<span class="string">&quot;io.github.dunwu.spring.orm.mapper.UserMapper.selectByPrimaryKey&quot;</span>, params);</span><br><span class="line"><span class="keyword">for</span> (User user : list) &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;user name: &quot;</span> + user.getName());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>示例代码中，给 sqlSession 对象的传递一个配置的 Sql 语句的 Statement Id 和参数，然后返回结果</p>
<p><code>io.github.dunwu.spring.orm.mapper.UserMapper.selectByPrimaryKey</code> 是配置在 <code>UserMapper.xml</code> 的 Statement ID，params 是 SQL 参数。</p>
<p>UserMapper.xml 文件中的代码片段：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;selectByPrimaryKey&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;java.lang.Long&quot;</span> <span class="attr">resultMap</span>=<span class="string">&quot;BaseResultMap&quot;</span>&gt;</span></span><br><span class="line">  select id, name, age, address, email</span><br><span class="line">  from user</span><br><span class="line">  where id = #&#123;id,jdbcType=BIGINT&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>Mybatis 通过方法的全限定名，将 SqlSession 和 Mapper 相互映射起来。</p>
<h3 id="SqlSession-和-Executor"><a href="#SqlSession-和-Executor" class="headerlink" title="SqlSession 和 Executor"></a>SqlSession 和 Executor</h3><p><code>org.apache.ibatis.session.defaults.DefaultSqlSession</code> 中 <code>selectList</code> 方法的源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> &lt;E&gt; List&lt;E&gt; <span class="title function_">selectList</span><span class="params">(String statement)</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">this</span>.selectList(statement, <span class="literal">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> &lt;E&gt; List&lt;E&gt; <span class="title function_">selectList</span><span class="params">(String statement, Object parameter)</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">this</span>.selectList(statement, parameter, RowBounds.DEFAULT);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> &lt;E&gt; List&lt;E&gt; <span class="title function_">selectList</span><span class="params">(String statement, Object parameter, RowBounds rowBounds)</span> &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// 1. 根据 Statement Id，在配置对象 Configuration 中查找和配置文件相对应的 MappedStatement</span></span><br><span class="line">    <span class="type">MappedStatement</span> <span class="variable">ms</span> <span class="operator">=</span> configuration.getMappedStatement(statement);</span><br><span class="line">    <span class="comment">// 2. 将 SQL 语句交由执行器 Executor 处理</span></span><br><span class="line">    <span class="keyword">return</span> executor.query(ms, wrapCollection(parameter), rowBounds, Executor.NO_RESULT_HANDLER);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    <span class="keyword">throw</span> ExceptionFactory.wrapException(<span class="string">&quot;Error querying database.  Cause: &quot;</span> + e, e);</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    ErrorContext.instance().reset();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>说明：</p>
<p>Mybatis 所有的配置信息都维持在 <code>Configuration</code> 对象之中。中维护了一个 <code>Map&lt;String, MappedStatement&gt;</code> 对象。其中，key 为 Mapper 方法的全限定名（对于本例而言，key 就是 <code>io.github.dunwu.spring.orm.mapper.UserMapper.selectByPrimaryKey</code> ），value 为 <code>MappedStatement</code> 对象。所以，传入 Statement Id 就可以从 Map 中找到对应的 <code>MappedStatement</code>。</p>
<p><code>MappedStatement</code> 维护了一个 Mapper 方法的元数据信息，其数据组织可以参考下面的 debug 截图：</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/20210511150650.png" alt="img"></p>
<blockquote>
<p>小结：</p>
<p>通过 “SqlSession 和 Mapper” 以及 “SqlSession 和 Executor” 这两节，我们已经知道：</p>
<p>SqlSession 的职能是：根据 Statement ID, 在 <code>Configuration</code> 中获取到对应的 <code>MappedStatement</code> 对象，然后调用 <code>Executor</code> 来执行具体的操作。</p>
</blockquote>
<h3 id="Executor-工作流程"><a href="#Executor-工作流程" class="headerlink" title="Executor 工作流程"></a>Executor 工作流程</h3><p>继续上一节的流程，<code>SqlSession</code> 将 SQL 语句交由执行器 <code>Executor</code> 处理。<code>Executor</code> 又做了哪些事儿呢？</p>
<p>（1）执行器查询入口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;E&gt; List&lt;E&gt; <span class="title function_">query</span><span class="params">(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">	<span class="comment">// 1. 根据传参，动态生成需要执行的 SQL 语句，用 BoundSql 对象表示</span></span><br><span class="line">    <span class="type">BoundSql</span> <span class="variable">boundSql</span> <span class="operator">=</span> ms.getBoundSql(parameter);</span><br><span class="line">    <span class="comment">// 2. 根据传参，创建一个缓存Key</span></span><br><span class="line">    <span class="type">CacheKey</span> <span class="variable">key</span> <span class="operator">=</span> createCacheKey(ms, parameter, rowBounds, boundSql);</span><br><span class="line">    <span class="keyword">return</span> query(ms, parameter, rowBounds, resultHandler, key, boundSql);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>执行器查询入口主要做两件事：</p>
<ul>
<li><strong>生成动态 SQL</strong>：根据传参，动态生成需要执行的 SQL 语句，用 BoundSql 对象表示。</li>
<li><strong>管理缓存</strong>：根据传参，创建一个缓存 Key。</li>
</ul>
<p>（2）执行器查询第二入口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> &lt;E&gt; List&lt;E&gt; <span class="title function_">query</span><span class="params">(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, CacheKey key, BoundSql boundSql)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">  <span class="comment">// 略</span></span><br><span class="line">  List&lt;E&gt; list;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    queryStack++;</span><br><span class="line">    list = resultHandler == <span class="literal">null</span> ? (List&lt;E&gt;) localCache.getObject(key) : <span class="literal">null</span>;</span><br><span class="line">    <span class="comment">// 3. 缓存中有值，则直接从缓存中取数据；否则，查询数据库</span></span><br><span class="line">    <span class="keyword">if</span> (list != <span class="literal">null</span>) &#123;</span><br><span class="line">      handleLocallyCachedOutputParameters(ms, key, parameter, boundSql);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      list = queryFromDatabase(ms, parameter, rowBounds, resultHandler, key, boundSql);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    queryStack--;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 略</span></span><br><span class="line">  <span class="keyword">return</span> list;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>实际查询方法主要的职能是判断缓存 key 是否能命中缓存：</p>
<ul>
<li>命中，则将缓存中数据返回；</li>
<li>不命中，则查询数据库：</li>
</ul>
<p>（3）查询数据库</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> &lt;E&gt; List&lt;E&gt; <span class="title function_">queryFromDatabase</span><span class="params">(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, CacheKey key, BoundSql boundSql)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">  List&lt;E&gt; list;</span><br><span class="line">  localCache.putObject(key, EXECUTION_PLACEHOLDER);</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// 4. 执行查询，获取 List 结果，并将查询的结果更新本地缓存中</span></span><br><span class="line">    list = doQuery(ms, parameter, rowBounds, resultHandler, boundSql);</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    localCache.removeObject(key);</span><br><span class="line">  &#125;</span><br><span class="line">  localCache.putObject(key, list);</span><br><span class="line">  <span class="keyword">if</span> (ms.getStatementType() == StatementType.CALLABLE) &#123;</span><br><span class="line">    localOutputParameterCache.putObject(key, parameter);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> list;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>queryFromDatabase</code> 方法的职责是调用 doQuery，向数据库发起查询，并将返回的结果更新到本地缓存。</p>
<p>（4）实际查询方法</p>
<p>SimpleExecutor 类的 doQuery()方法实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> &lt;E&gt; List&lt;E&gt; <span class="title function_">doQuery</span><span class="params">(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, BoundSql boundSql)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">  <span class="type">Statement</span> <span class="variable">stmt</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="type">Configuration</span> <span class="variable">configuration</span> <span class="operator">=</span> ms.getConfiguration();</span><br><span class="line">    <span class="comment">// 5. 根据既有的参数，创建StatementHandler对象来执行查询操作</span></span><br><span class="line">    <span class="type">StatementHandler</span> <span class="variable">handler</span> <span class="operator">=</span> configuration.newStatementHandler(wrapper, ms, parameter, rowBounds, resultHandler, boundSql);</span><br><span class="line">    <span class="comment">// 6. 创建java.Sql.Statement对象，传递给StatementHandler对象</span></span><br><span class="line">    stmt = prepareStatement(handler, ms.getStatementLog());</span><br><span class="line">    <span class="comment">// 7. 调用StatementHandler.query()方法，返回List结果</span></span><br><span class="line">    <span class="keyword">return</span> handler.query(stmt, resultHandler);</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    closeStatement(stmt);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上述的 Executor.query()方法几经转折，最后会创建一个 <code>StatementHandler</code> 对象，然后将必要的参数传递给 <code>StatementHandler</code>，使用 <code>StatementHandler</code> 来完成对数据库的查询，最终返回 List 结果集。<br>从上面的代码中我们可以看出，<code>Executor</code> 的功能和作用是：</p>
<ol>
<li><p>根据传递的参数，完成 SQL 语句的动态解析，生成 BoundSql 对象，供 <code>StatementHandler</code> 使用；</p>
</li>
<li><p>为查询创建缓存，以提高性能</p>
</li>
<li><p>创建 JDBC 的 <code>Statement</code> 连接对象，传递给 <code>StatementHandler</code> 对象，返回 List 查询结果。</p>
</li>
</ol>
<p>prepareStatement() 方法的实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Statement <span class="title function_">prepareStatement</span><span class="params">(StatementHandler handler, Log statementLog)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">  Statement stmt;</span><br><span class="line">  <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> getConnection(statementLog);</span><br><span class="line">  stmt = handler.prepare(connection, transaction.getTimeout());</span><br><span class="line">  <span class="comment">//对创建的Statement对象设置参数，即设置SQL 语句中 ? 设置为指定的参数</span></span><br><span class="line">  handler.parameterize(stmt);</span><br><span class="line">  <span class="keyword">return</span> stmt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对于 JDBC 的 <code>PreparedStatement</code> 类型的对象，创建的过程中，我们使用的是 SQL 语句字符串会包含 若干个? 占位符，我们其后再对占位符进行设值。</p>
<h3 id="StatementHandler-工作流程"><a href="#StatementHandler-工作流程" class="headerlink" title="StatementHandler 工作流程"></a>StatementHandler 工作流程</h3><p><code>StatementHandler</code> 有一个子类 <code>RoutingStatementHandler</code>，它负责代理其他 <code>StatementHandler</code> 子类的工作。</p>
<p>它会根据配置的 <code>Statement</code> 类型，选择实例化相应的 <code>StatementHandler</code>，然后由其代理对象完成工作。</p>
<p>【源码】RoutingStatementHandler</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">RoutingStatementHandler</span><span class="params">(Executor executor, MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, BoundSql boundSql)</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">switch</span> (ms.getStatementType()) &#123;</span><br><span class="line">    <span class="keyword">case</span> STATEMENT:</span><br><span class="line">      delegate = <span class="keyword">new</span> <span class="title class_">SimpleStatementHandler</span>(executor, ms, parameter, rowBounds, resultHandler, boundSql);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> PREPARED:</span><br><span class="line">      delegate = <span class="keyword">new</span> <span class="title class_">PreparedStatementHandler</span>(executor, ms, parameter, rowBounds, resultHandler, boundSql);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> CALLABLE:</span><br><span class="line">      delegate = <span class="keyword">new</span> <span class="title class_">CallableStatementHandler</span>(executor, ms, parameter, rowBounds, resultHandler, boundSql);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ExecutorException</span>(<span class="string">&quot;Unknown statement type: &quot;</span> + ms.getStatementType());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>【源码】<code>RoutingStatementHandler</code> 的 <code>parameterize</code> 方法源码</p>
<p>【源码】<code>PreparedStatementHandler</code> 的 <code>parameterize</code> 方法源码</p>
<p><code>StatementHandler</code> 使用 <code>ParameterHandler</code> 对象来完成对 <code>Statement</code> 的赋值。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">parameterize</span><span class="params">(Statement statement)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">  <span class="comment">// 使用 ParameterHandler 对象来完成对 Statement 的设值</span></span><br><span class="line">  parameterHandler.setParameters((PreparedStatement) statement);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>【源码】<code>StatementHandler</code> 的 <code>query</code> 方法源码</p>
<p><code>StatementHandler</code> 使用 <code>ResultSetHandler</code> 对象来完成对 <code>ResultSet</code> 的处理。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> &lt;E&gt; List&lt;E&gt; <span class="title function_">query</span><span class="params">(Statement statement, ResultHandler resultHandler)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">  <span class="type">PreparedStatement</span> <span class="variable">ps</span> <span class="operator">=</span> (PreparedStatement) statement;</span><br><span class="line">  ps.execute();</span><br><span class="line">  <span class="comment">// 使用ResultHandler来处理ResultSet</span></span><br><span class="line">  <span class="keyword">return</span> resultSetHandler.handleResultSets(ps);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ParameterHandler-工作流程"><a href="#ParameterHandler-工作流程" class="headerlink" title="ParameterHandler 工作流程"></a>ParameterHandler 工作流程</h3><p>【源码】<code>DefaultParameterHandler</code> 的 <code>setParameters</code> 方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">@Override</span></span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setParameters</span><span class="params">(PreparedStatement ps)</span> &#123;</span><br><span class="line"><span class="comment">// parameterMappings 是对占位符 #&#123;&#125; 对应参数的封装</span></span><br><span class="line">   List&lt;ParameterMapping&gt; parameterMappings = boundSql.getParameterMappings();</span><br><span class="line">   <span class="keyword">if</span> (parameterMappings != <span class="literal">null</span>) &#123;</span><br><span class="line">     <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; parameterMappings.size(); i++) &#123;</span><br><span class="line">       <span class="type">ParameterMapping</span> <span class="variable">parameterMapping</span> <span class="operator">=</span> parameterMappings.get(i);</span><br><span class="line">       <span class="comment">// 不处理存储过程中的参数</span></span><br><span class="line">       <span class="keyword">if</span> (parameterMapping.getMode() != ParameterMode.OUT) &#123;</span><br><span class="line">         Object value;</span><br><span class="line">         <span class="type">String</span> <span class="variable">propertyName</span> <span class="operator">=</span> parameterMapping.getProperty();</span><br><span class="line">         <span class="keyword">if</span> (boundSql.hasAdditionalParameter(propertyName)) &#123; <span class="comment">// issue #448 ask first for additional params</span></span><br><span class="line">           <span class="comment">// 获取对应的实际数值</span></span><br><span class="line">           value = boundSql.getAdditionalParameter(propertyName);</span><br><span class="line">         &#125; <span class="keyword">else</span> <span class="keyword">if</span> (parameterObject == <span class="literal">null</span>) &#123;</span><br><span class="line">           value = <span class="literal">null</span>;</span><br><span class="line">         &#125; <span class="keyword">else</span> <span class="keyword">if</span> (typeHandlerRegistry.hasTypeHandler(parameterObject.getClass())) &#123;</span><br><span class="line">           value = parameterObject;</span><br><span class="line">         &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="comment">// 获取对象中相应的属性或查找 Map 对象中的值</span></span><br><span class="line">           <span class="type">MetaObject</span> <span class="variable">metaObject</span> <span class="operator">=</span> configuration.newMetaObject(parameterObject);</span><br><span class="line">           value = metaObject.getValue(propertyName);</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         <span class="type">TypeHandler</span> <span class="variable">typeHandler</span> <span class="operator">=</span> parameterMapping.getTypeHandler();</span><br><span class="line">         <span class="type">JdbcType</span> <span class="variable">jdbcType</span> <span class="operator">=</span> parameterMapping.getJdbcType();</span><br><span class="line">         <span class="keyword">if</span> (value == <span class="literal">null</span> &amp;&amp; jdbcType == <span class="literal">null</span>) &#123;</span><br><span class="line">           jdbcType = configuration.getJdbcTypeForNull();</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="comment">// 通过 TypeHandler 将 Java 对象参数转为 JDBC 类型的参数</span></span><br><span class="line">           <span class="comment">// 然后，将数值动态绑定到 PreparedStaement 中</span></span><br><span class="line">           typeHandler.setParameter(ps, i + <span class="number">1</span>, value, jdbcType);</span><br><span class="line">         &#125; <span class="keyword">catch</span> (TypeException | SQLException e) &#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TypeException</span>(<span class="string">&quot;Could not set parameters for mapping: &quot;</span> + parameterMapping + <span class="string">&quot;. Cause: &quot;</span> + e, e);</span><br><span class="line">         &#125;</span><br><span class="line">       &#125;</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<h3 id="ResultSetHandler-工作流程"><a href="#ResultSetHandler-工作流程" class="headerlink" title="ResultSetHandler 工作流程"></a>ResultSetHandler 工作流程</h3><p><code>ResultSetHandler</code> 的实现可以概括为：将 <code>Statement</code> 执行后的结果集，按照 <code>Mapper</code> 文件中配置的 <code>ResultType</code> 或 <code>ResultMap</code> 来转换成对应的 JavaBean 对象，最后将结果返回。</p>
<p>【源码】<code>DefaultResultSetHandler</code> 的 <code>handleResultSets</code> 方法</p>
<p><code>handleResultSets</code> 方法是 <code>DefaultResultSetHandler</code> 的最关键方法。其实现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> List&lt;Object&gt; <span class="title function_">handleResultSets</span><span class="params">(Statement stmt)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">  ErrorContext.instance().activity(<span class="string">&quot;handling results&quot;</span>).object(mappedStatement.getId());</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> List&lt;Object&gt; multipleResults = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> <span class="variable">resultSetCount</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">  <span class="comment">// 第一个结果集</span></span><br><span class="line">  <span class="type">ResultSetWrapper</span> <span class="variable">rsw</span> <span class="operator">=</span> getFirstResultSet(stmt);</span><br><span class="line">  List&lt;ResultMap&gt; resultMaps = mappedStatement.getResultMaps();</span><br><span class="line">  <span class="comment">// 判断结果集的数量</span></span><br><span class="line">  <span class="type">int</span> <span class="variable">resultMapCount</span> <span class="operator">=</span> resultMaps.size();</span><br><span class="line">  validateResultMapsCount(rsw, resultMapCount);</span><br><span class="line">  <span class="comment">// 遍历处理结果集</span></span><br><span class="line">  <span class="keyword">while</span> (rsw != <span class="literal">null</span> &amp;&amp; resultMapCount &gt; resultSetCount) &#123;</span><br><span class="line">    <span class="type">ResultMap</span> <span class="variable">resultMap</span> <span class="operator">=</span> resultMaps.get(resultSetCount);</span><br><span class="line">    handleResultSet(rsw, resultMap, multipleResults, <span class="literal">null</span>);</span><br><span class="line">    rsw = getNextResultSet(stmt);</span><br><span class="line">    cleanUpAfterHandlingResultSet();</span><br><span class="line">    resultSetCount++;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  String[] resultSets = mappedStatement.getResultSets();</span><br><span class="line">  <span class="keyword">if</span> (resultSets != <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">while</span> (rsw != <span class="literal">null</span> &amp;&amp; resultSetCount &lt; resultSets.length) &#123;</span><br><span class="line">      <span class="type">ResultMapping</span> <span class="variable">parentMapping</span> <span class="operator">=</span> nextResultMaps.get(resultSets[resultSetCount]);</span><br><span class="line">      <span class="keyword">if</span> (parentMapping != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">nestedResultMapId</span> <span class="operator">=</span> parentMapping.getNestedResultMapId();</span><br><span class="line">        <span class="type">ResultMap</span> <span class="variable">resultMap</span> <span class="operator">=</span> configuration.getResultMap(nestedResultMapId);</span><br><span class="line">        handleResultSet(rsw, resultMap, <span class="literal">null</span>, parentMapping);</span><br><span class="line">      &#125;</span><br><span class="line">      rsw = getNextResultSet(stmt);</span><br><span class="line">      cleanUpAfterHandlingResultSet();</span><br><span class="line">      resultSetCount++;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> collapseSingleResultList(multipleResults);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><strong>官方</strong><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/Mybatis/Mybatis-3">Mybatis Github</a></li>
<li><a target="_blank" rel="noopener" href="http://www.mybatis.org/Mybatis-3/">Mybatis 官网</a></li>
</ul>
</li>
<li><strong>文章</strong><ul>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/luanlouis/article/details/40422941">深入理解 Mybatis 原理</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/tuguangquan/Mybatis">Mybatis 源码中文注释</a></li>
<li><a target="_blank" rel="noopener" href="https://juejin.im/post/5cee8b61e51d455d88219ea4">Mybatis 中强大的 resultMap</a></li>
</ul>
</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="上一页" aria-label="上一页" href="/blog/page/11/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/blog/">1</a><span class="space">&hellip;</span><a class="page-number" href="/blog/page/11/">11</a><span class="page-number current">12</span><a class="page-number" href="/blog/page/13/">13</a><span class="space">&hellip;</span><a class="page-number" href="/blog/page/47/">47</a><a class="extend next" rel="next" title="下一页" aria-label="下一页" href="/blog/page/13/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 2015 – 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">钝悟 ◾ Dunwu</span>
  </div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
      <span>站点总字数：</span>
    <span title="站点总字数">3.5m</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span>站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">53:28</span>
  </span>
</div>

    </div>
  </footer>

  
  <div class="reading-progress-bar"></div>

  <a href="https://github.com/dunwu/blog" class="github-corner" title="在 GitHub 上关注我" aria-label="在 GitHub 上关注我" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/blog/js/comments.js"></script><script src="/blog/js/utils.js"></script><script src="/blog/js/motion.js"></script><script src="/blog/js/next-boot.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/hexo-generator-searchdb@1.4.1/dist/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/blog/js/third-party/search/local-search.js"></script>





  <script src="/blog/js/third-party/pace.js"></script>


  




<script src="https://cdn.jsdelivr.net/npm/darkmode-js@1.5.7/lib/darkmode-js.min.js"></script>

<script>
var options = {
  bottom: '64px',
  right: 'unset',
  left: '32px',
  time: '0.5s',
  mixColor: 'transparent',
  backgroundColor: 'transparent',
  buttonColorDark: '#100f2c',
  buttonColorLight: '#fff',
  saveInCookies: true,
  label: '🌓',
  autoMatchOsTheme: true
}
const darkmode = new Darkmode(options);
window.darkmode = darkmode;
darkmode.showWidget();
</script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1.8.0/dist/gitalk.css" integrity="sha256-AJnUHL7dBv6PGaeyPQJcgQPDjt/Hn/PvYZde1iqfp8U=" crossorigin="anonymous">

<script class="next-config" data-name="gitalk" type="application/json">{"enable":true,"github_id":"dunwu","repo":"blog","client_id":"c45bc13ca1d3d3aa4836","client_secret":"1907a9f0c22087badad3938e1d7dcba9078f88ac","admin_user":"dunwu","distraction_free_mode":true,"proxy":"https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token","language":"zh-CN","js":{"url":"https://cdn.jsdelivr.net/npm/gitalk@1.8.0/dist/gitalk.min.js","integrity":"sha256-MVK9MGD/XJaGyIghSVrONSnoXoGh3IFxLw0zfvzpxR4="},"path_md5":"203c89ed6dd6b0abeeeb1cd3c7b2fc89"}</script>
<script src="/blog/js/third-party/comments/gitalk.js"></script>

</body>
</html>
